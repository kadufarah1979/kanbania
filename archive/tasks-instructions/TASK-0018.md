# TASK-0018: Implementar pipeline de ingestão (parse, validate, store)

## Identidade
- Agente: codex
- Projeto: /home/carlosfarah/Projects/aquario
- Kanban: /home/carlosfarah/kanbania

## Card

```yaml+markdown
---
id: TASK-0018
title: "Implementar pipeline de ingestão (parse, validate, store)"
project: aquario
sprint: sprint-003
okr: OKR-2026-Q1-01
priority: high
labels: [feature]
story_points: 5
created_at: "2026-02-14T10:00:00-03:00"
created_by: claude-code
assigned_to: codex
depends_on: [TASK-0017, TASK-0014]
blocks: [TASK-0022]
acted_by:
  - agent: codex
    action: claimed
    date: "2026-02-14T13:06:01-03:00"
  - agent: codex
    action: reassigned
    date: "2026-02-14T10:15:59-03:00"
  - agent: claude-code
    action: created
    date: "2026-02-14T10:00:00-03:00"
---

## Descrição

Implementar o pipeline completo de ingestão de dados de sensores. Quando o MQTT consumer recebe uma mensagem `metrics/minute`, o pipeline deve:

1. Identificar o device pelo device_id no tópico
2. Validar que o device existe e está ativo no banco
3. Atualizar device.last_seen_at e device.is_online = True
4. Para cada campo no payload, mapear para param_code via MQTT_FIELD_MAP
5. Validar valor dentro de abs_min/abs_max do catálogo
6. Gravar sensor_reading com source='sensor'
7. Retornar lista de readings gravadas (para avaliação de alertas)

Arquivos:
- `backend/app/mqtt/handlers.py` — handler para cada tipo de tópico
- `backend/app/services/reading_service.py` — lógica de ingestão e consulta

## Critérios de Aceite

- [ ] MQTT_FIELD_MAP mapeando temp_c→temperature, tds_ppm→tds
- [ ] Validação de device existente (ignora mensagem de device desconhecido com warning)
- [ ] Validação abs_min/abs_max (rejeita valores impossíveis)
- [ ] Grava sensor_reading no TimescaleDB com timestamp correto
- [ ] Atualiza device.last_seen_at a cada mensagem
- [ ] Campos desconhecidos no payload são ignorados (extensível)
- [ ] Tratamento de erro robusto (não crasha o consumer)

## Contexto Técnico

- Payload do firmware: `{"temp_c": 25.5, "tds_ppm": 480, "hum_pct": 78.2, "uptime_s": 3600}`
- hum_pct (umidade ambiente) não é parâmetro de aquário → mapeado para None no MQTT_FIELD_MAP
- Referência: `docs/dev/PLANO_IMPLANTACAO.md` seção 2.1

## Notas de Progresso
```

## Dependencias

- TASK-0017: done
- TASK-0014: done

## Workflow

1. Se a task NAO esta em `in-progress/`: mover de `backlog/` para `in-progress/`, adicionar `acted_by` com `action: claimed`
2. Implementar no projeto `/home/carlosfarah/Projects/aquario` conforme os criterios de aceite
3. Fazer commit no projeto com mensagem descritiva
4. Adicionar nota de progresso no card em `/home/carlosfarah/kanbania/board/in-progress/TASK-0018.md`
5. Mover card: `mv /home/carlosfarah/kanbania/board/in-progress/TASK-0018.md /home/carlosfarah/kanbania/board/review/TASK-0018.md`
6. Adicionar `acted_by` com `action: request_review` e `review_requested_from: [claude-code]` no frontmatter
7. Append em `/home/carlosfarah/kanbania/logs/activity.jsonl`
8. Fazer commit no kanban

## Formato Commit Projeto

```
feat(pipeline): descricao concisa - TASK-0018
```

## Formato Commit Kanban

```
[KANBAN] <action> TASK-0018: <descricao>
```

## Formato Log

```json
{"timestamp":"<ISO>","agent":"codex","action":"<claimed|request_review>","entity_type":"task","entity_id":"TASK-0018","details":"<descricao>","project":"aquario"}
```

## Contexto Tecnico

- Payload do firmware: `{"temp_c": 25.5, "tds_ppm": 480, "hum_pct": 78.2, "uptime_s": 3600}`
- hum_pct (umidade ambiente) não é parâmetro de aquário → mapeado para None no MQTT_FIELD_MAP
- Referência: `docs/dev/PLANO_IMPLANTACAO.md` seção 2.1

## Instrucoes Importantes

- NAO leia arquivos de protocolo (CODEX.md, AGENTS.md, config.yaml, sprints/current.md). TUDO que voce precisa esta NESTE arquivo.
- Foque em IMPLEMENTAR. Nao gaste tokens com leituras desnecessarias.
- Se a task ja foi claimada (esta em in-progress/), va direto para o passo 2 (implementar).
- Ao terminar, SEMPRE mova para review/ e registre no log.
