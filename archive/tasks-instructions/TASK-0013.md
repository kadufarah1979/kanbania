# TASK-0013: Configurar TimescaleDB hypertable para sensor_readings

## Identidade
- Agente: codex
- Projeto: /home/carlosfarah/Projects/aquario
- Kanban: /home/carlosfarah/kanbania

## Card

```yaml+markdown
---
id: TASK-0013
title: "Configurar TimescaleDB hypertable para sensor_readings"
project: aquario
sprint: sprint-002
okr: OKR-2026-Q1-01
priority: high
labels: [infra]
story_points: 2
created_at: "2026-02-14T10:00:00-03:00"
created_by: claude-code
assigned_to: codex
depends_on: [TASK-0012]
blocks: []
acted_by:
  - agent: codex
    action: request_review
    date: "2026-02-14T12:28:13-03:00"
    review_requested_from: [claude-code]
  - agent: codex
    action: claimed
    date: "2026-02-14T12:25:02-03:00"
  - agent: codex
    action: reassigned
    date: "2026-02-14T10:15:59-03:00"
  - agent: claude-code
    action: created
    date: "2026-02-14T10:00:00-03:00"
---

## Descrição

Converter a tabela `sensor_readings` em hypertable do TimescaleDB para particionamento automático por tempo. Criar índices otimizados para queries frequentes.

## Critérios de Aceite

- [x] `sensor_readings` convertida em hypertable com `create_hypertable('sensor_readings', 'time')`
- [x] Índice `idx_readings_aquarium_param` criado (aquarium_id, param_code, time DESC)
- [x] Índice `idx_readings_device` criado (device_id, time DESC)
- [x] Verificar com `SELECT * FROM timescaledb_information.hypertables` que está ativa
- [x] Script pode ser re-executado sem erro (idempotente)

## Contexto Técnico

- A extensão TimescaleDB já está disponível na imagem `timescale/timescaledb:latest-pg16`
- Precisa rodar APÓS a migration Alembic (depende de TASK-0012)
- Pode ser feito via migration Alembic customizada ou script SQL no init
- Referência: `docs/dev/PLANO_IMPLANTACAO.md` seção 1.2 (sensor_readings)

## Notas de Progresso

- 2026-02-14: Criada migration Alembic `9f3c2d7c2e8a_timescale_hypertable_sensor_readings.py` para `create_hypertable(..., if_not_exists => TRUE)` e `CREATE INDEX IF NOT EXISTS ...`.
- 2026-02-14: Aplicado via `docker compose exec -T backend alembic upgrade head`.
- 2026-02-14: Validado hypertable via `SELECT ... FROM timescaledb_information.hypertables WHERE hypertable_name='sensor_readings'`.
- 2026-02-14: Re-execucao do SQL (hypertable + indices) sem erro (notices de "already exists", conforme esperado).
```

## Dependencias

- TASK-0012: done

## Workflow

1. Se a task NAO esta em `in-progress/`: mover de `backlog/` para `in-progress/`, adicionar `acted_by` com `action: claimed`
2. Implementar no projeto `/home/carlosfarah/Projects/aquario` conforme os criterios de aceite
3. Fazer commit no projeto com mensagem descritiva
4. Adicionar nota de progresso no card em `/home/carlosfarah/kanbania/board/in-progress/TASK-0013.md`
5. Mover card: `mv /home/carlosfarah/kanbania/board/in-progress/TASK-0013.md /home/carlosfarah/kanbania/board/review/TASK-0013.md`
6. Adicionar `acted_by` com `action: request_review` e `review_requested_from: [claude-code]` no frontmatter
7. Append em `/home/carlosfarah/kanbania/logs/activity.jsonl`
8. Fazer commit no kanban

## Formato Commit Projeto

```
infra(timescaledb-hypertab): descricao concisa - TASK-0013
```

## Formato Commit Kanban

```
[KANBAN] <action> TASK-0013: <descricao>
```

## Formato Log

```json
{"timestamp":"<ISO>","agent":"codex","action":"<claimed|request_review>","entity_type":"task","entity_id":"TASK-0013","details":"<descricao>","project":"aquario"}
```

## Contexto Tecnico

- A extensão TimescaleDB já está disponível na imagem `timescale/timescaledb:latest-pg16`
- Precisa rodar APÓS a migration Alembic (depende de TASK-0012)
- Pode ser feito via migration Alembic customizada ou script SQL no init
- Referência: `docs/dev/PLANO_IMPLANTACAO.md` seção 1.2 (sensor_readings)

## Instrucoes Importantes

- NAO leia arquivos de protocolo (CODEX.md, AGENTS.md, config.yaml, sprints/current.md). TUDO que voce precisa esta NESTE arquivo.
- Foque em IMPLEMENTAR. Nao gaste tokens com leituras desnecessarias.
- Se a task ja foi claimada (esta em in-progress/), va direto para o passo 2 (implementar).
- Ao terminar, SEMPRE mova para review/ e registre no log.
