---
id: TASK-0070
title: "Offers API endpoints"
project: aquario
sprint: sprint-009
points: 2
priority: high
status: in_progress
assigned_to: claude-code
review_requested_from: [claude-code]
depends_on: [TASK-0069]
created_at: "2026-02-15T20:00:00-03:00"
created_by: claude-code
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-15T20:00:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-15T21:00:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-15T21:01:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T09:24:31-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T09:51:22-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T10:05:25-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T10:09:24-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T11:44:47-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T11:45:12-03:00"
  - agent: claude-code
    action: approved
    date: "2026-02-15T11:50:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T11:57:27-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T11:59:02-03:00"
tokens_used: 2699395
tokens_by_phase:
  backlog: 2653084
  in_progress: 34600
---

## Descricao

Endpoints: POST /listings/{id}/offers, GET /offers/me, GET /offers/received, PUT /offers/{id}. Errors: 400, 403, 410.

## Criterios de Aceite

- [x] POST criar oferta (auth)
- [x] GET minhas ofertas
- [x] GET ofertas recebidas
- [x] PUT aceitar/rejeitar/contraproposta
- [x] Error handling correto

## Notas de Progresso

- **2026-02-15 21:01 (claude-code)**: Sprint 9 implementation complete. Moved to review.
- **2026-02-15 09:24 (codex)**: QA: changes requested. Bug real: `POST /listings/{id}/offers` permite criar oferta para anuncio com `status != active` (inclui `paused/deleted`), pois `create_offer` nao valida status do listing antes de persistir. Nao movido de `review` por regra critica (sem `acted_by` de `claude-code` com `approved`).
- **2026-02-15 12:30 (claude-code)**: Fixed: added ListingNotActiveError validation in create_offer and handler in API. Added test `test_create_offer_on_paused_listing`. Re-submitted for review.
- **2026-02-15 09:48 (codex)**: QA tecnico aprovado (gate results: PASSED): endpoints e error handling conferem com o card, incluindo bloqueio para listing `status != active`. Nao movido de `review` por regra critica: falta `acted_by` do `claude-code` com `action: approved`.
- **2026-02-15 09:51 (codex)**: QA: changes requested. Bug real: `POST /listings/{id}/offers` permite auto-oferta (dono do anuncio criando oferta no proprio listing), pois `create_offer` nao bloqueia `listing.user_id == buyer_id` (backend/app/services/offer_service.py). Risco: manipulacao de fluxo de negociacao/ofertas recebidas e comportamento indevido de marketplace.
- **2026-02-15 10:05 (codex)**: QA: changes requested. Bug real: `create_offer` agora bloqueia auto-oferta com `OfferNotAuthorizedError`, mas `POST /listings/{id}/offers` nao trata essa excecao no endpoint (backend/app/api/v1/marketplace.py), resultando em erro 500 em vez de resposta de autorizacao (403). Fere criterio de error handling correto para fluxo autenticado.
- **2026-02-15 10:09 (codex)**: QA: changes requested (revalidacao). Bug real persiste: `create_offer` lanca `OfferNotAuthorizedError` para auto-oferta, mas `POST /listings/{id}/offers` nao captura essa excecao em `backend/app/api/v1/marketplace.py`, causando 500 ao inves de erro de autorizacao (403). Falha no criterio "Error handling correto".
- **2026-02-15 10:15 (claude-code)**: Fixed: added `except OfferNotAuthorizedError` handler in `create_offer_endpoint` returning 403. Added test `test_create_offer_self_offer_blocked`. 163 tests pass. Re-submitted for review.
- **2026-02-15 11:44 (codex)**: QA: aprovado (gate results: PASSED). Criterios do card atendidos e correcao validada para auto-oferta com retorno 403 em `POST /listings/{id}/offers`. Nao movido de `review` por regra critica: falta `acted_by` do `claude-code` com `action: approved`.
- **2026-02-15 11:45 (codex)**: QA: aprovado (revalidacao, gate results: PASSED). Endpoint `POST /listings/{id}/offers` trata `OfferNotAuthorizedError` com 403 e bloqueio de auto-oferta no service; criterios do card seguem atendidos. Nao movido de `review` por regra critica: ainda falta `acted_by` do `claude-code` com `action: approved`.
- **2026-02-15 11:57 (codex)**: QA: aprovado (gate results: PASSED). Revalidacao final: criterios do card atendidos, endpoints de ofertas e error handling (400/403/410) corretos, sem bugs reais adicionais.
- **2026-02-15 11:59 (codex)**: QA: aprovado (gate results: PASSED). Revalidacao do gate final: implementacao segue correta para `POST /listings/{id}/offers`, `GET /offers/me`, `GET /offers/received`, `PUT /offers/{id}` e tratamento de erros 400/403/410; falha de lock no pre-review classificada como ambiente.
