---
id: TASK-0364
title: "Criar endpoints analyze + confirm com testes de integracao"
project: aquario
sprint: sprint-048
okr: null
priority: high
labels: [feature]
story_points: 3
created_at: "2026-02-21T06:30:00-03:00"
created_by: "claude-code"
assigned_to: claude-code
review_requested_from: [codex]
depends_on: [TASK-0361, TASK-0362, TASK-0363]
blocks: [TASK-0365]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T06:30:00-03:00"
  - agent: "claude-code"
    action: moved_to_review
    date: "2026-02-21T13:00:00-03:00"
  - agent: "codex"
    action: qa_changes_requested
    date: "2026-02-21T16:19:14-03:00"
  - agent: "claude-code"
    action: qa_fix_applied
    date: "2026-02-21T16:30:00-03:00"
  - agent: "codex"
    action: qa_approved
    date: "2026-02-21T16:49:11-03:00"
tokens_used: 69541
tokens_by_phase:
  backlog: 2829
  todo: 66714
---

## Descricao

Criar os endpoints de API para analise de foto e confirmacao do resultado. `POST /api/v1/test-kits/{id}/analyze` recebe imagem, executa color matching e retorna resultado. `POST /api/v1/test-kits/analyses/{id}/confirm` salva o valor final como leitura (sensor_readings com source=test_kit).

## Criterios de Aceite

- [x] `POST /api/v1/test-kits/{id}/analyze` aceita multipart/form-data com imagem
- [x] Resposta inclui: analysis_id, suggested_value, confidence, detected_color_hex, method, matched_scale_entry, closest_values
- [x] `POST /api/v1/test-kits/analyses/{id}/confirm` aceita aquarium_id, final_value, user_adjusted, notes
- [x] Confirmacao cria registro em sensor_readings com source="test_kit"
- [x] Confirmacao atualiza reading_id na analise
- [x] Multi-tenant isolation em ambos endpoints
- [x] Rate limit: max 10 analises por usuario por hora
- [x] Testes de integracao para ambos endpoints
- [x] Tratamento de erro para kit inexistente, imagem invalida, analise ja confirmada

## Contexto Tecnico

- Spec: `docs/dev/TEST_KITS.md` secoes 6.5 e 6.6
- Depende de: model test_kit_analyses (TASK-0361), upload service (TASK-0362), color matching (TASK-0363)
- Router em `backend/app/api/v1/test_kits.py` (adicionar ao user_kits_router)
- Service em `backend/app/services/test_kit_service.py` (estender)
- Referencia de sensor_readings: verificar model existente para source field

## Notas de Progresso

- Endpoints adicionados ao user_kits_router em test_kits.py
- Service estendido com analyze_test_kit(), confirm_analysis(), get_analysis(), _check_rate_limit()
- Rate limit: 10 analises/hora por usuario via query no test_kit_analyses
- confirm cria SensorReading com source="test_kit", test_method="test_kit:{slug}"
- Multi-tenant: tenant_id = user_id em todas as queries
- 7 testes unitarios com mocks, 1 teste de integracao do pipeline completo
- 24 testes passando (7 novos + 17 color matching)
- Commit: f5b21ae

### [2026-02-21 16:19] codex
QA: changes requested.
## Pendencias (QA)
1. `backend/app/schemas/test_kit.py:160` - endpoint de confirmacao nao aceita `aquarium_id` como exigido no criterio de aceite.
   ATUAL: `class TestKitAnalysisConfirm(BaseModel): final_value, user_adjusted, notes`
   ESPERADO: `class TestKitAnalysisConfirm(BaseModel): aquarium_id, final_value, user_adjusted, notes`
2. `backend/app/schemas/test_kit.py:166` - resposta nao expoe `matched_scale_entry` e `closest_values` no contrato esperado.
   ATUAL: `TestKitAnalysisResponse` retorna `matched_scale_id` e `ai_response`
   ESPERADO: `TestKitAnalysisResponse` incluir `matched_scale_entry` e `closest_values` no top-level
3. `backend/tests/test_analysis_endpoints.py:41` - suite cobre service com mocks, mas nao valida endpoints HTTP de analyze/confirm como testes de integracao.
   ATUAL: testes chamam `analyze_test_kit()` e `confirm_analysis()` diretamente
   ESPERADO: adicionar testes de integracao via API (`POST /api/v1/test-kits/{id}/analyze` e `POST /api/v1/test-kits/analyses/{id}/confirm`)

### [2026-02-21 16:30] claude-code
QA fix aplicado:
1. Adicionado `aquarium_id` ao `TestKitAnalysisConfirm` (campo opcional)
2. Adicionados `matched_scale_entry` e `closest_values` no top-level do `TestKitAnalysisResponse`
3. Adicionados 6 testes HTTP de integracao (analyze 201/404/401, confirm 200/409/404)
13 testes passando. Commit: 730ea6e

### [2026-02-21 16:49] codex
QA aprovado apos rework.
- Confirmacao aceita aquarium_id no schema de entrada.
- Resposta de analise/confirmacao inclui matched_scale_entry e closest_values em top-level.
- Suite inclui testes de integracao HTTP para os endpoints analyze e confirm.
