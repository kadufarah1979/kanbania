---
id: TASK-0212
title: "Implementar auditoria de aprovações e ações operacionais"
project: consoleai
sprint: null
okr: null
priority: high
labels: [security, observability, compliance]
story_points: 3
created_at: "2026-02-18T16:53:59-03:00"
created_by: "codex"
assigned_to: codex
review_requested_from: [codex]
depends_on: [TASK-0205, TASK-0211]
blocks: []
acted_by:
  - agent: "codex"
    action: created
    date: "2026-02-18T16:53:59-03:00"
  - agent: "codex"
    action: update
    date: "2026-02-19T16:07:47-03:00"
  - agent: "codex"
    action: update
    date: "2026-02-19T18:20:59-03:00"
  - agent: "codex"
    action: claim
    date: "2026-02-20T16:48:53-03:00"
  - agent: "codex"
    action: update
    date: "2026-02-20T16:51:02-03:00"
  - agent: "codex"
    action: qa_approved
    date: "2026-02-20T17:20:28-03:00"
tokens_used: 1835583
tokens_by_phase:
  todo: 160046
  in_progress: 54040
---

## Descricao

Registrar trilha de auditoria para eventos críticos: aprovação/rejeição de solicitações, visualização sensível e ações operacionais (como restart), com dados de ator, tenant, recurso e timestamp.

## Criterios de Aceite

- [x] Eventos críticos persistidos com contexto suficiente para auditoria
- [x] Consulta de auditoria por período/tenant/usuário disponível para administradores
- [x] Logs protegidos contra alteração indevida e com retenção definida

## Contexto Tecnico

Necessário para rastreabilidade, segurança e compliance operacional do produto.

## Notas de Progresso

### [2026-02-18 16:53] codex
Card criado para fechar lacuna de rastreabilidade do fluxo operacional.

### [2026-02-20 16:51] codex
Auditoria validada para aprovações e ações operacionais com consulta filtrável (período/tenant/usuário) restrita a administradores, além de retenção configurável via `AUDIT_RETENTION_DAYS`.
Teste executado:
- `.venv/bin/python -m pytest -q tests/unit/test_consoleai_api.py -k "audit_events_query_for_admin_with_filters or audit_events_query_is_admin_only"` -> 2 passed

### [2026-02-20 17:20] codex
QA aprovado no gate de review com regressao consolidada (39 passed na suite unificada de API/authz/inventario).
