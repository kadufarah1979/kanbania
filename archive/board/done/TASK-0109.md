---
id: TASK-0109
title: "Regression: marketplace (listings, offers, transactions)"
project: aquario
sprint: sprint-012
points: 2
priority: medium
status: done
assigned_to: null
review_requested_from: [codex]
depends_on: [TASK-0101]
created_at: "2026-02-15T16:00:00-03:00"
created_by: claude-code
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-15T16:00:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-15T15:48:53-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-15T16:26:44-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T16:33:49-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T18:51:38-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T19:02:30-03:00"
tokens_used: 1015975
tokens_by_phase:
  in_progress: 25339
---

## Descricao

Validar marketplace: perguntas em listings (com filtro de contato), ofertas com negociacao, transacoes, reviews e registros de loja.

## Criterios de Aceite

- [x] Perguntas: criar, responder, deletar, bloquear contato (phone/email/whatsapp)
- [x] Ofertas: criar, aceitar, rejeitar, contra-oferta, negociacao em 3 rounds
- [x] Ofertas: limite minimo (50%), duplicada bloqueada, self-offer bloqueada
- [x] Transacoes: status flow (pending_payment -> paid -> shipped -> delivered -> completed)
- [x] Transacoes: disputas (abrir, resolver com refund/release)
- [x] Reviews: criar apos delivery, prevenir duplicata
- [x] Store: registro, aprovacao, rejeicao por admin
- [x] Testes test_listing_questions.py (11 tests), test_offers.py (16 tests), test_transactions.py (20 tests) passam

## Notas de Progresso

- [2026-02-15T16:30:00-03:00] Marketplace regression OK: 47/47 tests pass (11 questions + 16 offers + 20 transactions). Contact filtering, offer limits, negotiation rounds, status flow, disputes, reviews, store registration/approval all working.
- [2026-02-15T16:34:08-03:00] QA (codex): Revisado backend `backend/app/services/{listing_question_service,offer_service,transaction_service,review_service,store_registration_service}.py` + endpoints `backend/app/api/v1/{marketplace,admin}.py` e testes `backend/tests/{test_listing_questions,test_offers,test_transactions}.py`. Criterios de aceite estao cobertos pelos testes e acoes estao com checagens de permissao (buyer/seller/admin). Observacao: `transaction_service.VALID_TRANSITIONS` permite `paid -> delivered` (alem do fluxo `paid -> shipped -> delivered`); confirmar se e intencional (pickup) ou se deve exigir `shipped`. Gate pre-review nao executou (lock) e nao ha `acted_by: claude-code approved` no card, entao nao movi para done.
- [2026-02-15T16:33:49-03:00] QA: aprovado. Criterios do card cobertos por testes e implementacao (Q&A com bloqueio de contato, ofertas com minimo 50%/duplicata/self-offer/negociacao em 3 rounds, transacoes com status flow + disputas refund/release, reviews pos-delivery sem duplicata, store registration com aprovacao/rejeicao admin). Gate [pre-review] nao executou por lock timeout (ambiente), ignorado conforme politica. Observacao: ainda nao existe `acted_by` do `claude-code` com action `approved`; mantendo a task em `review` ate isso.
- [2026-02-15T18:51:38-03:00] QA: aprovado (gate results: PASSED). Revisao final confirmou criterios do card no codigo e testes (47/47). Gate `pre-review` com lock timeout foi tratado como falha de ambiente (ignorado por politica). Sem `acted_by` do `claude-code` com `action: approved`, tarefa mantida em `review` (nao movida para `done`).
- [2026-02-15T19:02:30-03:00] QA: aprovado (gate results: PASSED). Criterios de aceite validados na implementacao e cobertura de testes de marketplace (perguntas com filtro de contato, ofertas com limite minimo/duplicata/self-offer e negociacao, transacoes com fluxo e disputas, reviews pos-delivery sem duplicata, store registration com decisao admin). `pre-review` com lock timeout tratado como falha de ambiente conforme politica.
