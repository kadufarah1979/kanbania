---
id: TASK-0065
title: "Q&A service layer"
project: aquario
sprint: sprint-009
points: 3
priority: high
status: done
assigned_to: null
review_requested_from: [codex]
depends_on: [TASK-0064]
created_at: "2026-02-15T20:00:00-03:00"
created_by: claude-code
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-15T20:00:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-15T21:00:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-15T21:01:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T09:19:41-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T09:23:37-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T09:46:37-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T09:51:40-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T10:09:03-03:00"
  - agent: claude-code
    action: approved
    date: "2026-02-15T11:50:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T11:57:06-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T11:58:56-03:00"
tokens_used: 2583150
tokens_by_phase:
  backlog: 2512629
  in_progress: 58813
---

## Descricao

Criar listing_question_service.py com: create_question (max 5 pending per user per listing, auto-moderation), answer_question (only listing owner), get_questions (paginated, exclude blocked), delete_question (seller/admin only), _check_contact_info regex. Unit tests.

## Criterios de Aceite

- [x] Service layer com todas as funcoes
- [x] Auto-moderacao de contato (telefone, email, instagram, whatsapp, links)
- [x] Limite de 5 perguntas pendentes por usuario por listing
- [x] Testes unitarios passando

## Notas de Progresso

- **2026-02-15 21:01 (claude-code)**: Sprint 9 implementation complete. Moved to review.
- **2026-02-15 09:19 (codex)**: QA: changes requested. Bug real encontrado: `get_questions` nao implementa paginacao (criterio exige listagem paginada), retornando todos os registros sem `limit/offset` ou `page/per_page`. Card mantido em `review` conforme regra critica (sem `acted_by` de aprovacao por `claude-code`).
- **2026-02-15 09:23 (codex)**: QA: changes requested (revalidado). Defeito persiste: `app/services/listing_question_service.py#get_questions` retorna lista completa sem paginacao; endpoint `GET /marketplace/listings/{listing_id}/questions` tambem nao aceita `page/per_page` ou `limit/offset`. Falha de gate (`Could not acquire lock`) tratada como ambiente/lock e nao como defeito de codigo.
- **2026-02-15 09:46 (codex)**: QA: changes requested (gate final). Defeito real persiste: `backend/app/services/listing_question_service.py#get_questions` nao recebe `page/per_page` (nem `limit/offset`) e nao aplica `LIMIT/OFFSET`; endpoint `backend/app/api/v1/marketplace.py` em `GET /listings/{listing_id}/questions` tambem nao aceita parametros de paginacao e retorna lista completa. Crit√©rio "get_questions (paginated, exclude blocked)" ainda nao atendido.
- **2026-02-15 09:51 (codex)**: QA: aprovado (gate results: PASSED - lock de ambiente ignorado conforme regra). Revalidado no codigo: `get_questions` agora aplica paginacao (`page/per_page` + `LIMIT/OFFSET`) e exclui bloqueadas por padrao; endpoint `GET /marketplace/listings/{listing_id}/questions` aceita `page/per_page`; regras de create/answer/delete e auto-moderacao atendidas. Card nao movido para done por regra critica: ausencia de `acted_by` do `claude-code` com `action: approved`.
- **2026-02-15 12:50 (claude-code)**: Fixed pagination in previous commit. Codex approved. Re-submitted for final move to done.
- **2026-02-15 10:09 (codex)**: QA: aprovado (gate results: PASSED). Revalidado no codigo: service `listing_question_service.py` atende create/answer/get paginado/delete, auto-moderacao por regex e limite de 5 pendentes; endpoint `GET /marketplace/listings/{listing_id}/questions` aceita `page/per_page`. Sem bugs reais de funcionalidade/seguranca. Card permanece em `review` por regra critica: ausencia de `acted_by` com `agent: claude-code` e `action: approved`.
- **2026-02-15 11:57 (codex)**: QA: aprovado (gate results: PASSED). Revalidado no codigo: `create_question` aplica limite de 5 pendentes e auto-moderacao de contato; `answer_question` restringe ao dono do anuncio; `get_questions` pagina com `page/per_page` e exclui bloqueadas por padrao; `delete_question` permite apenas vendedor/admin. Sem bugs reais de funcionalidade ou seguranca.
- **2026-02-15 11:58 (codex)**: QA: aprovado (gate results: PASSED). Revalidacao final no codigo confirma criterios de aceite atendidos para service layer Q&A (create/answer/get paginado/delete, auto-moderacao regex e limite de 5 pendentes); falha de gate por lock foi tratada como ambiente, sem defeito real.
