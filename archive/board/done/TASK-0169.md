---
id: TASK-0169
title: "Hierarquia Server/Client + Provisioning com Aprovacao"
project: aquario
sprint: sprint-020
okr: OKR-2026-Q1-01
priority: high
labels: [feature, devices, mqtt, backend, frontend]
story_points: 8
created_at: "2026-02-17T23:00:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: []
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-17T23:00:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-17T23:00:00-03:00"
  - agent: claude-code
    action: review_requested
    date: "2026-02-17T23:30:00-03:00"
  - agent: codex
    action: complete
    date: "2026-02-17T05:18:55-03:00"
tokens_used: 3334511
tokens_by_phase:
  in_progress: 1160460
---

## Descricao

Implementar hierarquia server/client para devices e fluxo de provisioning com aprovacao admin.

- **Server**: ESP32 rodando broker local, agrega ate 3 clients, conecta ao Mosquitto cloud
- **Client**: conecta localmente ao server, NAO conecta direto ao cloud

Fluxo: Admin provisiona server -> User escaneia QR -> Cria pedido de associacao -> Admin aprova -> Credenciais MQTT geradas -> Server pode conectar ao cloud -> Server reporta clients

## Criterios de Aceite

- [x] Modelo Device com campos `device_role`, `parent_device_id`, `association_status`, `aquarium_id` nullable
- [x] Modelo DeviceAssociation (pending/approved/rejected) seguindo padrao StoreRegistration
- [x] Migration Alembic para hierarquia + tabela associations
- [x] Service de associacao: claim, approve (gera MQTT creds), reject
- [x] ACL MQTT: server acessa topicos proprios + dos seus clients; client negado no cloud
- [x] Registro de clients: server pode ter ate 3 clients
- [x] Endpoint `POST /devices/claim` (user escaneia QR)
- [x] Endpoint `POST /devices/{id}/clients` e `GET /devices/{id}/clients`
- [x] Endpoint `POST /admin/devices/factory-provision`
- [x] Endpoint `GET /admin/device-associations` e `PATCH /admin/device-associations/{id}`
- [x] Frontend: QR scanner dialog com seletor de aquario
- [x] Frontend: Devices page com botao "Vincular Device", badges role/status
- [x] Frontend: Admin page com tab "Associacoes" (approve/reject) e botao "Provisionar Device"
- [x] Frontend: API functions para claim, clients, associations, factory provision
- [x] Testes backend: 13 novos testes cobrindo fluxo completo
- [x] Todos os 302 testes passando (existentes + novos)

## Contexto Tecnico

### Arquivos criados

| Arquivo | Descricao |
|---------|-----------|
| `backend/app/models/device_association.py` | Modelo DeviceAssociation |
| `backend/app/services/device_association_service.py` | Service claim/approve/reject |
| `backend/app/schemas/device_association.py` | Schemas do fluxo |
| `backend/alembic/versions/f3a4b5c6d7e8_add_device_hierarchy.py` | Migration |
| `backend/tests/test_device_association.py` | 13 testes |
| `frontend/src/components/devices/qr-scanner-dialog.tsx` | QR scanner dialog |

### Arquivos modificados

| Arquivo | Mudanca |
|---------|---------|
| `backend/app/models/device.py` | +device_role, parent_device_id, association_status, aquarium_id nullable, self-ref relationships |
| `backend/app/models/__init__.py` | Registrar DeviceAssociation |
| `backend/app/services/device_service.py` | ACL server/client, factory_provision, register_client, guards nullable aquarium_id |
| `backend/app/schemas/device.py` | Novos campos + schemas hierarchy/claim/provision |
| `backend/app/api/v1/devices.py` | +claim, +clients endpoints |
| `backend/app/api/v1/admin.py` | +associations, +factory-provision, +role/status cols |
| `frontend/src/lib/api/devices.ts` | Hierarchy fields + claim/client functions |
| `frontend/src/lib/api/admin.ts` | Associations + factory provision API |
| `frontend/src/app/(authenticated)/devices/page.tsx` | QR scanner button, role badges |
| `frontend/src/app/(authenticated)/admin/page.tsx` | Tab Associacoes, Provisionar button |

## Notas de Progresso

### [2026-02-17 23:30] claude-code

Implementacao completa de toda a feature. 302 testes passando (13 novos + 289 existentes).
Fluxo end-to-end testado: factory provision -> claim -> approve (gera MQTT) -> register client -> ACL server acessa client topics.

### [2026-02-17 05:18] codex
Gate de QA executado:
- Evidencias de implementacao revisadas no commit `16bf67a` (modelos, service, endpoints, UI admin/devices, QR dialog).
- Testes especificos do fluxo hierarquico validados no `make test`: `tests/test_device_association.py` (13 casos) todos passando.
- Regressao geral do backend confirmada: `302/302` testes passando.

Card aprovado e movido para `done`.
