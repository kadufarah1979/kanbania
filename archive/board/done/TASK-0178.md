---
id: TASK-0178
title: "Implementar endpoints de setup/claim com token one-time"
project: aquario
sprint: sprint-022
okr: OKR-2026-Q1-01
priority: high
labels: [feature, security]
story_points: 3
created_at: "2026-02-18T01:52:42-03:00"
created_by: "codex"
assigned_to: codex
review_requested_from: []
depends_on: [TASK-0176, TASK-0177]
blocks: [TASK-0181]
acted_by:
  - agent: "codex"
    action: created
    date: "2026-02-18T01:52:42-03:00"
  - agent: "codex"
    action: claimed
    date: "2026-02-18T02:55:12-03:00"
  - agent: "codex"
    action: complete
    date: "2026-02-18T03:03:52-03:00"
  - agent: "codex"
    action: complete
    date: "2026-02-18T03:12:31-03:00"
tokens_used: 1210163
tokens_by_phase:
  backlog: 49580
  review: 124
---

## Descricao

Evoluir fluxo de claim para exigir validacao de token de setup (QR), vinculando broker ao aquario do usuario com protecoes contra replay e claim indevido.

## Criterios de Aceite

- [x] Endpoint de validacao de token retorna estado do setup de forma segura
- [x] Endpoint de claim consome token e impede reutilizacao
- [x] Ownership do aquario e validado antes de criar associacao pendente

## Contexto Tecnico

Aproveitar endpoint existente `POST /api/v1/devices/claim` e service `claim_device`, adicionando passo de token antes da associacao.

## Notas de Progresso

### [2026-02-18 01:52] codex
Tarefa criada para fechar lacuna de seguranca no claim por QR.

### [2026-02-18 02:55] codex
Claim realizado apos analise de fila: `TASK-0160` mantida no todo por janela operacional (execucao somente apos 25/02/2026); `TASK-0178` selecionada por estar desbloqueada por `TASK-0176/0177` concluidas.

### [2026-02-18 03:03] codex
Implementados `POST /api/v1/devices/setup/validate` e claim com `setup_token` obrigatorio/one-time; fluxo de claim passa a consumir token em transacao unica com associacao pendente. Testes executados: `test_device_association.py` + `test_device_setup_token_service.py` (20 passed) e `test_mqtt_auth.py` (19 passed).

### [2026-02-18 03:12] codex
Gate de QA em review validado com reexecucao de `test_device_association.py` + `test_device_setup_token_service.py` (`20 passed in 5.86s`) e conferencias de contrato no codigo (`/devices/setup/validate` + `setup_token` obrigatorio no claim). Card aprovado para `done`.
