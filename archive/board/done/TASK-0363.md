---
id: TASK-0363
title: "Implementar servico de color matching (CIELAB + Delta-E + K-means)"
project: aquario
sprint: sprint-048
okr: null
priority: high
labels: [feature, ai-integration]
story_points: 5
created_at: "2026-02-21T06:30:00-03:00"
created_by: "claude-code"
assigned_to: claude-code
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0364]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T06:30:00-03:00"
  - agent: "claude-code"
    action: moved_to_review
    date: "2026-02-21T12:00:00-03:00"
  - agent: "codex"
    action: qa_approved
    date: "2026-02-21T16:19:09-03:00"
tokens_used: 28861
tokens_by_phase:
  backlog: 2829
  in_progress: 26034
---

## Descricao

Implementar o servico de color matching algoritmico que analisa uma foto de teste quimico e determina o valor do parametro comparando a cor da amostra com a escala de cores cadastrada do kit. Inclui conversao RGB-CIELAB, calculo Delta-E, extracao de cor dominante via K-means e interpolacao de valores intermediarios.

## Criterios de Aceite

- [x] Funcao de conversao RGB para CIELAB implementada
- [x] Funcao de calculo Delta-E (CIE76 ou CIEDE2000) implementada
- [x] Deteccao de ROI (regiao de interesse) na imagem: regiao central 30% como fallback
- [x] Extracao de cor dominante via K-means clustering (k=3), filtrando branco/preto/transparente
- [x] Comparacao da cor extraida com cada cor da escala do kit
- [x] Interpolacao linear para valores entre dois niveis da escala
- [x] Calculo de confianca baseado em delta-E e ambiguidade
- [x] Retorno estruturado: cor detectada (hex, lab), valor sugerido, confianca, matched_scale_id, closest_values
- [x] Testes unitarios com imagens sinteticas (cores conhecidas)
- [x] Performance < 500ms para analise de uma imagem

## Contexto Tecnico

- Spec: `docs/dev/TEST_KITS.md` secoes 5.1 e 5.2
- Dependencias Python: `Pillow`, `scikit-learn` (K-means), `numpy`
- Implementar conversao CIELAB internamente (sem dependencia de `colormath`)
- Servico em `backend/app/services/color_matching_service.py`
- Formulas de referencia: sRGB -> XYZ -> CIELAB (iluminante D65)
- Delta-E CIE76: sqrt((L1-L2)^2 + (a1-a2)^2 + (b1-b2)^2)

## Notas de Progresso

- Implementado K-means manual (sem scikit-learn) usando numpy
- Pipeline: sRGB -> XYZ (D65) -> CIELAB -> Delta-E CIE76
- ROI central 30%, downsample 100x100, k=3 clusters
- Interpolacao ponderada por Delta-E entre os 2 mais proximos
- Confianca: 0.95 (dE<5) decrescendo ate 0.05 (dE>30), com penalidade de ambiguidade
- 17 testes unitarios com imagens sinteticas (Pillow), todos passando
- Commit: cac85ba

### [2026-02-21 16:19] codex
QA: aprovado.
- Criterios de aceite validados no servico backend/app/services/color_matching_service.py e testes backend/tests/test_color_matching.py.
- Cobertura presente para CIELAB, Delta-E, ROI central, K-means, interpolacao, confianca e retorno estruturado.
