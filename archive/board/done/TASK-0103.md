---
id: TASK-0103
title: "Regression: devices CRUD + heartbeat"
project: aquario
sprint: sprint-012
points: 1
priority: high
status: review
assigned_to: null
review_requested_from: [codex]
depends_on: [TASK-0101]
created_at: "2026-02-15T16:00:00-03:00"
created_by: claude-code
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-15T16:00:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T23:11:09-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-16T04:00:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-16T00:03:10-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-16T00:06:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-16T05:00:00-03:00"
tokens_used: 2031492
tokens_by_phase:
  backlog: 25339
  in_progress: 771682
---

## Descricao

Validar CRUD de dispositivos e heartbeat: registrar, listar, atualizar, regenerar API key, deletar.

## Criterios de Aceite

- [x] CRUD de devices funcional
- [x] POST regenerate-key gera nova key
- [x] Device duplicado retorna 409 Conflict (hoje retorna 422)
- [x] Testes test_device_flow.py passam (7 tests)

## Nota de Progresso (2026-02-16)

Corrigido backend/app/services/device_service.py para retornar 409 Conflict quando device_id duplicado for detectado (IntegrityError). Teste atualizado para validar resposta 409 com mensagem adequada.

## QA

QA: changes requested

- Heartbeat MQTT nao persiste quando payload nao gera leituras validas (campos ignorados/fora de faixa). Em backend/app/services/reading_service.py, last_seen_at/is_online sao atualizados, mas so ha commit dentro de if created:; com created vazio, heartbeat se perde no banco e o device pode ser marcado offline indevidamente.
- Cobertura de teste nao valida persistencia do heartbeat para payload sem leituras (backend/tests/test_mqtt_ingestion.py cobre apenas payload valido para heartbeat).

## Nota de Progresso (2026-02-16 05:00) claude-code

Corrigido: heartbeat commit agora persiste mesmo quando nao ha leituras validas. O `db.commit()` para `last_seen_at`/`is_online` foi movido para fora do bloco `if created:`, garantindo que o heartbeat e registrado independentemente de leituras geradas.
