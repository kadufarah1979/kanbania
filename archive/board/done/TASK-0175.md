---
id: TASK-0175
title: "Firmware: robustez do broker local (tracking e bridge)"
project: aquario
sprint: sprint-021
okr: OKR-2026-Q1-02
priority: high
labels: [firmware, mqtt, refactor]
story_points: 3
created_at: "2026-02-17T18:31:47-03:00"
created_by: codex
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: []
acted_by:
  - agent: codex
    action: created
    date: "2026-02-17T18:31:47-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-18T03:51:16-03:00"
  - agent: codex
    action: completed
    date: "2026-02-18T03:53:37-03:00"
  - agent: codex
    action: review_approved
    date: "2026-02-18T03:54:33-03:00"
tokens_used: 2932889
tokens_by_phase:
  backlog: 1720380
---

## Descricao

Implementar melhorias de robustez no broker local do firmware ESP32 Server para evitar inconsistencias de tracking de clients, perda de eventos de connect/disconnect e churn na fila de bridge quando o cloud estiver indisponivel/restrito.

## Criterios de Aceite

- [x] Trocar tracking de clients por `client_device_id` para estrategia com contagem por device (refcount), evitando `disconnect` prematuro em reconexoes
- [x] Enfileirar eventos de `aquario/<serial>/clients` quando cloud indisponivel, garantindo entrega posterior
- [x] Ajustar `BridgeForwarder` para evitar padrao `pop + push` em mensagens bloqueadas por ACL, reduzindo churn/perda
- [x] Manter limite de 3 clients locais e validacao de `client_device_id` sem regressao
- [x] Atualizar `/status` e logs para facilitar diagnostico de divergencia entre conexoes MQTT e clients validos

## Contexto Tecnico

Baseado na analise do arquivo `firmware/src/local_broker.cpp` e do fluxo `main/cloud/bridge`, foram identificados riscos de consistencia em cenarios de reconnect rapido e cloud offline.

Arquivos esperados para alteracao:
- `firmware/src/local_broker.h`
- `firmware/src/local_broker.cpp`
- `firmware/src/main.cpp`
- `firmware/src/bridge_forwarder.cpp`
- `firmware/src/cloud_mqtt.cpp` (se necessario)

## Notas de Progresso

### [2026-02-17 18:31] codex
Tarefa criada para proxima sprint com foco em robustez operacional do broker local e bridge MQTT.

### [2026-02-18 03:53] codex
Implementacao concluida:
- `LocalBroker` agora usa refcount por `client_device_id` (`clientDeviceRefs_`) para evitar disconnect prematuro em reconnect rapido.
- Eventos de clients (`aquario/<serial>/clients`) passam pela `BridgeQueue` via `g_bridge.enqueue`, garantindo entrega posterior.
- `BridgeForwarder` alterado para `peek + dropFront` (sem `pop + push` em bloqueio ACL/falha de publish).
- `/status` atualizado com `mqtt_connections`, `valid_clients`, `invalid_client_sessions`; logs de contador adicionados em connect/disconnect.
- Build validado: `cd firmware && .venv/bin/pio run` com `SUCCESS`.

### [2026-02-18 03:54] codex
QA aprovado e criterios atendidos com validacao de build.
