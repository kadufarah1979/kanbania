---
id: TASK-0243
title: "Backend: provisionar relay channels automaticamente no registro de device"
project: aquario
sprint: sprint-030
okr: OKR-2026-Q1-02
priority: medium
labels: [feature, backend]
story_points: 2
created_at: "2026-02-19T16:30:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: []
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-19T16:30:00-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-19T14:58:11-03:00"
  - agent: codex
    action: moved_to_review
    date: "2026-02-19T14:58:52-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-19T14:59:38-03:00"

tokens_used: 1578403
tokens_by_phase:
  backlog: 17954
---

## Descricao

Atualmente relay channels so sao criados via upsert_channel_states (quando o firmware envia /state) ou manualmente. Ao registrar um device do tipo relay_controller, criar automaticamente os 4 relay channels padrao para que estejam disponiveis imediatamente no frontend.

## Criterios de Aceite

- [x] Ao registrar device com device_role=client e tipo relay, criar 4 RelayChannel (ch 0-3) com nomes padrao
- [x] Se channels ja existirem (re-registro), nao duplicar
- [x] Endpoint de registro de device retorna channels criados
- [x] Testes para o fluxo de provisionamento automatico

## Notas de Progresso

- 2026-02-19T14:58:52-03:00 codex: validacao executada em ambiente dockerizado do backend; testes de provisionamento automatico passaram (4/4) em tests/test_relay_provisioning.py.

- 2026-02-19T14:59:38-03:00 codex: QA concluido; card aprovado e movido para done.
