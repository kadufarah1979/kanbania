---
id: TASK-0195
title: "Backend: endpoint leitura manual com validacao"
project: aquario
sprint: sprint-025
okr: OKR-2026-Q1-01
priority: medium
labels: [backend, readings]
story_points: 3
created_at: "2026-02-18T18:00:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0196]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-18T18:00:00-03:00"
  - agent: codex
    action: complete
    date: "2026-02-18T17:46:54-03:00"
tokens_used: 1737537
tokens_by_phase:
  backlog: 1553137
---

## Descricao

Implementar endpoint POST /api/v1/readings/manual para registro de leituras manuais (test kits). Valida param_code, range abs_min/abs_max, avalia alertas, e retorna warnings quando valor fora da faixa.

## Criterios de Aceite

- [x] Endpoint POST /api/v1/readings/manual aceita lista de leituras
- [x] Valida: aquario pertence ao usuario, param_code existe no catalogo, valor dentro de abs_min/abs_max
- [x] Grava sensor_reading com source='manual' ou 'test_kit'
- [x] Avalia alert_rules apos gravar (dispara alerta se fora do range)
- [x] Retorna warnings (valor fora de crit range, desvio > 50% da ultima leitura)
- [x] Broadcast via WebSocket (tipo "reading")
- [x] Testes unitarios

## Contexto Tecnico

Backend: `/home/carlosfarah/Projects/aquario/backend/`
Doc: `docs/dev/PLANO_IMPLANTACAO.md` secao "Fase 2: API -- Leituras Manuais"

Schema do request (do doc):
```python
class ManualReadingCreate(BaseModel):
    aquarium_id: UUID
    readings: list[ReadingEntry]

class ReadingEntry(BaseModel):
    param_code: str
    value: float
    source: Literal["manual", "test_kit"] = "manual"
    test_method: str | None = None
    notes: str | None = None
    measured_at: datetime | None = None
```

Response: { saved: N, warnings: [...], alerts_triggered: N }

Usar reading_service.py existente se houver, ou criar.

## Notas de Progresso

### [2026-02-18 18:00] claude-code
Card criado para endpoint de leitura manual.

### [2026-02-18 21:30] claude-code
Endpoint, service, schemas e testes ja existiam previamente. Adicionado broadcast WebSocket (commit f639e94).
- Endpoint: `POST /api/v1/readings/manual` em `backend/app/api/v1/readings.py`
- Service: `ingest_manual_readings()` em `backend/app/services/reading_service.py`
- Schemas: `ManualReadingCreate`, `ReadingEntry`, `ManualReadingResponse` em `backend/app/schemas/reading.py`
- Testes: 8 testes em `backend/tests/test_reading_flow.py`
- WS broadcast: adicionado no endpoint apos sucesso (tipo "reading")
364 testes passando.

### [2026-02-18 17:46] codex
QA aprovado para fechamento. Validado no codigo: endpoint `POST /api/v1/readings/manual`, validacoes de ownership + catalogo + `abs_min/abs_max`, persistencia `source` manual/test_kit, warnings de faixa critica e desvio >50%, avaliacao de alert rules e broadcast WS tipo `reading`. Evidencias de testes de fluxo presentes em `backend/tests/test_reading_flow.py`.
