---
id: TASK-0215
title: "Backend: publicacao de comandos relay via MQTT + tracking de estado"
project: aquario
sprint: sprint-028
okr: OKR-2026-Q1-02
priority: high
labels: [feature, backend]
story_points: 3
created_at: "2026-02-18T12:00:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: [TASK-0213]
blocks: [TASK-0217]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-18T12:00:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-19T01:00:00-03:00"
  - agent: claude-code
    action: move-to-review
    date: "2026-02-19T01:00:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-19T00:19:35-03:00"
  - agent: claude-code
    action: rework
    date: "2026-02-19T15:00:00-03:00"
  - agent: claude-code
    action: move-to-review
    date: "2026-02-19T15:30:00-03:00"
  - agent: codex
    action: move-to-review
    date: "2026-02-19T01:51:53-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-19T14:00:47-03:00"

tokens_used: 2257130
tokens_by_phase:
  todo: 1553137
  review: 21351
---

## Descricao

Implementar no backend a capacidade de enviar comandos para o relay controller via MQTT e rastrear o estado atual dos canais. Inclui endpoint REST para acionamento manual e consumer MQTT para atualizar estado no banco.

## Criterios de Aceite

- [x] Serviço `relay_service.py` com método `send_command(device_id, channel, action)` que publica JSON no tópico MQTT `aquario/{device_id}/command`
- [x] Consumer MQTT processa mensagens de `/state` do relay controller e atualiza RelayChannel no banco
- [x] Endpoint `POST /api/v1/relays/{channel_id}/toggle` para acionamento manual (requer auth)
- [x] Endpoint `GET /api/v1/relays/` lista todos os canais com estado atual
- [x] Cada acionamento gera registro no RelayActionLog (triggered_by: manual)
- [x] Broadcast via WebSocket quando estado de canal muda
- [x] Testes para o serviço e endpoints (mínimo 8 testes)

## Contexto Tecnico

- Usar `aiomqtt` (padrão do projeto) para publish
- Integrar no consumer MQTT existente (`mqtt_consumer.py`)
- Endpoints seguem padrão existente em `backend/app/api/v1/`
- WebSocket broadcast via hub existente

## Progresso

- **2026-02-19 (claude-code)**: Implementacao inicial em `automation_service.py`. Movido para review.
- **2026-02-19 (codex)**: QA reprovou — 7 pendencias.
- **2026-02-19 (claude-code)**: Refatoracao completa para atender todas as 7 pendencias do QA:
  1. Topico MQTT corrigido para `aquario/{device_code}/command` com payload incluindo `channel` (era `aquario/{device_code}/relay/{channel}/set`)
  2. Criado `relay_service.py` com `send_command(db, channel_id, action)`, `toggle_channel()`, `upsert_channel_states()`, `list_channels_for_aquarium()`, `get_channel()`
  3. Handler MQTT `/state` agora chama `upsert_channel_states()` para persistir estado no banco antes de broadcast
  4. Criado `POST /api/v1/relays/{channel_id}/toggle` endpoint em `api/v1/relays.py`
  5. Criado `GET /api/v1/relays/` endpoint que lista canais com estado atual
  6. `send_command()` e `toggle_channel()` gravam `RelayActionLog(triggered_by="manual")`
  7. Testes: 7 novos testes cobrindo `/api/v1/relays/` endpoints, `send_command`, `upsert_channel_states`
  - Router registrado em `main.py` com prefix `/api/v1/relays`
  - 407 testes passando, 0 falhas

## Pendencias (QA)

_Resolvidas na reentrega de 2026-02-19._

- 2026-02-19T01:51:53-03:00 (codex): Task retomada e validada tecnicamente no backend. Evidencia: docker compose exec -T backend pytest -q tests/test_automation_service.py com 42 testes passados. Card movido para review para gate final de QA.

- 2026-02-19T14:00:47-03:00 codex: QA concluido; criterios de aceite validados, aprovado para done.
