---
id: TASK-0274
title: "Implementar API CRUD de midias filtrantes com acoes e alertas"
project: aquario
sprint: sprint-037
okr: null
priority: critical
labels: [feature]
story_points: 5
created_at: "2026-02-20T18:30:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: [TASK-0273]
blocks: [TASK-0276]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-20T18:30:00-03:00"
  - agent: claude-code
    action: started
    date: "2026-02-20T19:00:00-03:00"
  - agent: claude-code
    action: review_requested
    date: "2026-02-20T19:45:00-03:00"
  - agent: codex
    action: qa
    date: "2026-02-20T15:56:55-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-20T21:30:00-03:00"
  - agent: claude-code
    action: move
    date: "2026-02-20T21:45:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-20T22:10:00-03:00"
tokens_used: 696110
tokens_by_phase:
  todo: 181267
  in_progress: 512022
---

## Descricao

Implementar service layer, schemas Pydantic e endpoints FastAPI para o CRUD completo de midias filtrantes, acoes de manutencao e endpoint de alertas.

## Criterios de Aceite

- [x] Schemas Pydantic: FilterMediaTypeResponse, AquariumFilterMediaCreate/Update/Response, FilterMediaLogCreate/Response, FilterMediaAlertResponse
- [x] Service `filter_media_service.py` com: list_media_types, list_media(aquarium_id, filters), create_media, update_media, delete_media, register_action(media_id, action), get_media_log, get_media_alerts
- [x] `register_action` recalcula datas de proxima acao automaticamente (next_clean_at, next_replace_at, etc.)
- [x] Endpoint GET `/api/v1/filter-media-types` — listar tipos de midia
- [x] Endpoints CRUD `/api/v1/aquariums/{id}/filter-media` — listar, criar, atualizar, deletar
- [x] Endpoint POST `/api/v1/aquariums/{id}/filter-media/{fm_id}/action` — registrar acao (clean, rinse, replace, retire)
- [x] Endpoint GET `/api/v1/aquariums/{id}/filter-media/{fm_id}/log` — historico de manutencoes
- [x] Endpoint GET `/api/v1/aquariums/{id}/filter-media/alerts` — midias vencidas ou proximas do vencimento
- [x] Testes cobrindo CRUD e logica de recalculo de datas

## Contexto Tecnico

- Spec: `docs/dev/MAINTENANCE_AND_ROUTINES.md` secoes 3.5-3.6 e 7.2
- Router registrado em `app/main.py`
- Seguir padrao de `maintenance.py` para estrutura de endpoints
- Alertas: 3 dias antes = info, no dia = warning, atrasado = warning
- Filtrar sempre por tenant_id

## Notas de Progresso

- Schemas criados em `backend/app/schemas/filter_media.py` (7 schemas)
- Service criado em `backend/app/services/filter_media_service.py` (9 funcoes)
- Router criado em `backend/app/api/v1/filter_media.py` (types_router + router)
- Routers registrados em `backend/app/main.py`
- 18 testes de integracao em `backend/tests/test_filter_media.py`
- 445 passed, 0 regressoes (1 falha pre-existente em test_google_auth)

### [2026-02-20 15:56] codex
QA reprovado (retorno para TODO).
Motivo:
- Gap de isolamento multi-tenant: consultas/listagens não filtram por `tenant_id` em `filter_media_service.py`.
- Na criação, `tenant_id` está sendo preenchido com `current_user.id` em `api/v1/filter_media.py`, o que não garante escopo de tenant.
Ação solicitada:
- Aplicar filtro por `tenant_id` em `list_media`, `get_media`, `get_media_alerts` e endpoints relacionados.
- Usar o identificador correto de tenant do usuário autenticado.

### [2026-02-20 21:45] claude-code
Correcao de isolamento multi-tenant aplicada:
- Adicionado `_get_owned_aquarium(db, aquarium_id, user_id)` ao service, seguindo padrao do `livestock_service.py`
- Validacao de ownership via `aquarium.user_id` em: `list_media`, `get_media`, `create_media`, `get_media_alerts`
- Removido parametro `tenant_id` redundante de `create_media` (agora usa `user_id` como tenant)
- Router atualizado para passar `current_user.id` em todas as chamadas de service
- Novo teste `test_list_filter_media_forbidden_for_other_user` valida 403 para acesso nao autorizado
- 19 testes passando (18 existentes + 1 novo), 0 regressoes

### [2026-02-20 22:10] codex
QA aprovado para fechamento.
- Validado ajuste de isolamento por ownership no service e no router.
- Card liberado para `done`; teste em producao sera acompanhado por tarefa dedicada.
