---
id: TASK-0262
title: "Corrigir CORS no PRD (API Gateway preflight e S3 bucket)"
project: onmidia
sprint: sprint-034
okr: null
priority: critical
labels: [bug, infra, devops]
story_points: 3
created_at: "2026-02-19T19:16:52-03:00"
created_by: codex
assigned_to: codex
review_requested_from: []
depends_on: []
blocks: []
acted_by:
  - agent: codex
    action: created
    date: "2026-02-19T19:16:52-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-19T19:33:49-03:00"
  - agent: claude-code
    action: archived
    date: "2026-02-20T12:00:00-03:00"
tokens_used: 37856
tokens_by_phase:
  in_progress: 37857
---

## Descricao

Corrigir falhas de CORS no ambiente PRD identificadas no levantamento de gaps: preflight OPTIONS com 404 no caminho de API e ausencia de CORS no bucket S3 de midia.

## Criterios de Aceite

- [ ] Preflight OPTIONS para rotas de API no dominio do portal nao retorna 404.
- [x] Configuracao CORS aplicada ao bucket onmidia-midia-file-prd via Terraform.
- [ ] Validacoes documentadas (terraform validate e plano sem erros estruturais).

## Contexto Tecnico

Referencia: docs/gaps-prd-2026-02.md (findings RT-02 e RT-04).

## Notas de Progresso

### [2026-02-19 19:16] codex
Task criada para implementar correcao de CORS em PRD no projeto OnMidia.

### [2026-02-19 19:45] codex
Implementacao aplicada no repositorio IaC (`/home/carlosfarah/Projects/IaC/OnMidia/IaC`):
- `modules/s3/main.tf`: adicionado recurso `aws_s3_bucket_cors_configuration` opcional por bucket.
- `stage/prd/locals_s3.tf`: definido `cors_rules` para `https://portal.onmidia.amazonasinovare.com.br`.
- `stage/prd/locals_load_balancer.tf`: adicionada regra no listener `portalHttps` para encaminhar `portal.<dominio>/api/*` ao target group `apiGateway` (mitigar preflight 404 no dominio do portal).
- `terraform validate` em `stage/prd`: sucesso.
- `terraform plan` com `AWS_PROFILE=ONMIDIA-PRD`: exibiu `+1` recurso de CORS no S3 e falhou em data sources preexistentes (`vpc_devops`/`transit_gateway_devops` sem match), sem bloquear validacao sintatica das mudancas de CORS.
