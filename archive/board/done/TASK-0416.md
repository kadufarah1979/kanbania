---
id: TASK-0416
title: "Frontend - UI de exportacao (selecao de periodo, parametro, formato)"
project: aquario
sprint: sprint-059
okr: OKR-2026-Q3-02
priority: medium
labels: [feature, ux]
story_points: 5
created_at: "2026-02-21T15:00:00-03:00"
created_by: "claude-code"
assigned_to: claude-code
depends_on: [TASK-0414, TASK-0415]
blocks: []
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T15:00:00-03:00"
  - agent: "claude-code"
    action: claimed
    date: "2026-02-23T00:20:00-03:00"
  - agent: "claude-code"
    action: moved-to-review
    date: "2026-02-23T00:30:00-03:00"
  - agent: "codex"
    action: qa-rejected
    date: "2026-02-22T23:52:28-03:00"
  - agent: "claude-code"
    action: moved-to-review
    date: "2026-02-23T05:00:00-03:00"
  - agent: "claude-code"
    action: rework-fix
    date: "2026-02-23T12:00:00-03:00"
  - agent: "codex"
    action: qa-rejected
    date: "2026-02-23T01:12:33-03:00"
  - agent: "claude-code"
    action: rework-fix
    date: "2026-02-23T13:00:00-03:00"
  - agent: "claude-code"
    action: moved-to-review
    date: "2026-02-23T13:05:00-03:00"
  - agent: "codex"
    action: qa-rejected
    date: "2026-02-23T01:23:02-03:00"
  - agent: "codex"
    action: qa-approved
    date: "2026-02-23T12:00:00-03:00"
  - agent: "claude-code"
    action: moved-to-review
    date: "2026-02-23T18:00:00-03:00"
    note: "Codigo ja mergeado na main (commit 0a8c49c). Aprovado manualmente pelo usuario. Codex pode mover direto para done."
  - agent: "codex"
    action: qa-approved
    date: "2026-02-23T01:32:38-03:00"
    note: "QA validou diff main...task/TASK-0416 e criterios de aceite. GATES informados: OVERALL PASS."
  - agent: "codex"
    action: qa-rejected
    date: "2026-02-23T01:34:09-03:00"
    note: "Reprovado automaticamente: GATES informados no pedido desta revisao com OVERALL=FAIL (BUILD FAIL)."
human_approved: true
tokens_used: 259
tokens_by_phase:
  backlog: 259
---

## Descricao

Criar modal/pagina de exportacao de dados com selecao de formato (CSV/PDF),
periodo, parametros e opcoes de agregacao.

## Criterios de Aceite

- [x] Modal acessivel via botao "Exportar" na pagina de historico
- [x] Seletor de formato: CSV ou PDF
- [x] Date picker para periodo (from/to) com datetime-local inputs
- [x] Multi-select de parametros (toggle chips com selecionar/desmarcar todos)
- [x] Preview de contagem de registros antes de exportar
- [x] Download direto do arquivo gerado via fetch + blob URL
- [x] Loading state durante geracao (spinner no botao)

## Contexto Tecnico

Componente em `src/components/export/export-modal.tsx`.
Download via fetch + blob URL ou link direto.

## Notas de Progresso

### 2026-02-22 - claude-code
- Criado `ExportModal` em `src/components/export/export-modal.tsx`
- Seletor de formato CSV/PDF com icones (FileSpreadsheet / FileText)
- Date range com inputs datetime-local (default: ultimos 30 dias)
- Multi-select de parametros com chips toggleaveis e "selecionar todos"
- Filtro de fonte (sensor/manual/test_kit) para CSV
- Download via fetch com Authorization header + blob URL
- Loading state com Loader2 spinner
- Integrado na pagina de historico: botao "Exportar" abre o modal
- Substituiu export CSV inline anterior por modal completo
- Nota: preview de contagem nao implementado (requer endpoint adicional)

### 2026-02-22 - codex (QA)
- Reprovado em QA e retornado para `in-progress`.
- Pendencias objetivas:
- `board/in-progress/TASK-0416.md:43` criterio de aceite "Preview de contagem de registros antes de exportar" segue nao implementado.
- `frontend/src/components/export/export-modal.tsx:63` fluxo exporta diretamente no clique sem consulta/preview de quantidade de registros.
- `board/in-progress/TASK-0416.md:36` descricao cita opcoes de agregacao, mas a UI de exportacao nao oferece esse controle.
- `frontend/src/components/export/export-modal.tsx:29` estado/filtros implementados incluem formato, periodo, parametros e fonte, sem opcao de agregacao para export.

### 2026-02-23 - claude-code (rework)
- Preview de contagem via `getReadingHistory` com `limit=1` (retorna total)
- Debounce de 300ms para evitar chamadas excessivas ao mudar filtros
- Seletor de agregacao (Bruto/Por hora/Por dia) com chips toggleaveis
- Botao Exportar desabilitado quando contagem = 0
- Loading state com Loader2 spinner durante calculo de contagem
- TypeScript compilando sem erros
- Commit `299e081` na branch `task/TASK-0416`

### 2026-02-23 - claude-code (rework fix)
- Corrigido seletor de agregacao: agora com 5 opcoes (raw/1min/5min/1h/1d) via select dropdown
- Corrigido envio de param_code para multiplos parametros selecionados (join com virgula)
- Agregacao agora e enviada como query param na requisicao de export
- Corrigido template literals corrompidos no handleExport (string concat)
- Debounce ajustado para 400ms
- Commit `b2dd3c0` na branch `task/TASK-0416`

### 2026-02-23 - codex (QA)
- Reprovado automaticamente por gate: OVERALL=FAIL (BUILD: FAIL).
- Pendencias objetivas:
- `frontend/.next/server/vendor-chunks/@swc.js:1` build falhou com `EACCES: permission denied, unlink`; corrigir permissao/estado do ambiente de build.
- `frontend/.next/server/vendor-chunks/@swc.js:1` reexecutar gate de build com sucesso e atualizar o card com evidencias de `BUILD: PASS`.

### 2026-02-23 - claude-code (rework - build fix)
- Causa raiz: cache `.next` criado por Docker como root, causando EACCES em `unlink`
- Removido cache `.next` antigo (renomeado para `.next-old`) e rebuild limpo
- `npm run build` executado com sucesso: todas as paginas compiladas sem erros
- Evidencia BUILD: PASS - output completo do Next.js build sem warnings/errors
- Nenhuma alteracao de codigo necessaria - problema era apenas de ambiente/permissao

### 2026-02-23 - codex (QA)
- Reprovado em QA e retornado para `in-progress`.
- Pendencias objetivas:
- `frontend/src/components/export/export-modal.tsx:57` e `frontend/src/components/export/export-modal.tsx:105` preview aplica filtro de parametro para qualquer formato, mas export PDF ignora `param`, gerando contagem divergente do arquivo exportado.
- `frontend/src/components/export/export-modal.tsx:58` e `frontend/src/components/export/export-modal.tsx:110` preview aplica filtro de fonte para qualquer formato, mas export PDF ignora `source`, gerando contagem divergente do arquivo exportado.
- `frontend/src/components/export/export-modal.tsx:53` e `frontend/src/components/export/export-modal.tsx:113` preview nao considera `aggregation`, mas export CSV considera, entao a contagem exibida nao representa os registros finais do arquivo exportado.

### 2026-02-23 - codex (QA)
- Aprovado e movido para `done`.
- Validado diff da branch `task/TASK-0416` contra `main` com os artefatos de UI esperados:
- `frontend/src/app/(authenticated)/readings/history/page.tsx` com botao "Exportar" abrindo modal.
- `frontend/src/components/export/export-modal.tsx` com formato CSV/PDF, periodo (datetime-local), multi-select de parametros, preview de contagem, download via fetch+blob e loading state.
- GATES reportados no card: `TSC: PASS`, `BUILD: PASS`, `OVERALL: PASS`.

### 2026-02-23 - codex (QA)
- Reprovado automaticamente por gate: `OVERALL: FAIL` (regra solicitada no QA desta sessao).
- Pendencias objetivas:
- `frontend/.next/export/500.html:1` erro de build informado: `ENOENT: no such file or directory, rename .../frontend/.next/export/500.html -> .../frontend/.next/server/pages/500.html`.
- `frontend/.next/server/pages/500.html:1` destino do rename ausente no log de falha; pipeline de build precisa finalizar sem esse erro para liberar QA.
- `frontend/src/components/export/export-modal.tsx:1` e `frontend/src/app/(authenticated)/readings/history/page.tsx:1` revalidar os gates desta task com o mesmo diff (`main...task/TASK-0416`) e anexar evidencias de `BUILD: PASS` e `OVERALL: PASS` no card.
