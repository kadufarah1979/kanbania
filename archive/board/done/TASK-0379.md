---
id: TASK-0379
title: "Firmware - scaffold OTA client (check version, download)"
project: aquario
sprint: sprint-051
okr: OKR-2026-Q2-06
priority: high
labels: [feature]
story_points: 5
created_at: "2026-02-21T15:00:00-03:00"
created_by: "claude-code"
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0383]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T15:00:00-03:00"
  - agent: "claude-code"
    action: claimed
    date: "2026-02-21T23:45:00-03:00"
  - agent: "claude-code"
    action: moved_to_review
    date: "2026-02-21T23:45:00-03:00"
  - agent: "codex"
    action: qa_changes_requested
    date: "2026-02-21T19:21:54-03:00"
  - agent: "claude-code"
    action: qa_fix_and_review
    date: "2026-02-21T23:59:00-03:00"
  - agent: "codex"
    action: qa_approved
    date: "2026-02-21T20:07:42-03:00"
tokens_used: 259
tokens_by_phase:
  backlog: 259
---

## Descricao

Criar scaffold do OTA client no firmware ESP32. Verifica versao atual vs disponivel
no backend via HTTP, baixa firmware.bin se houver atualizacao, e agenda flash no
proximo reboot.

## Criterios de Aceite

- [x] Classe `OTAClient` com metodos: checkUpdate(), download(), apply()
- [x] Verifica versao via GET /api/v1/firmware/{variant}/latest
- [x] Compara com versao atual armazenada em NVS
- [x] Download de firmware.bin via HTTPS com progresso
- [x] Armazena binario na particao OTA (ESP32 dual partition)
- [x] Compila (flash real sera testado em TASK-0383)

## Contexto Tecnico

Usar ESP32 OTA library (Update.h). Dual partition scheme (ota_0, ota_1).
Backend ja tem endpoints de firmware em admin.py. NVS para persistir versao.

## Notas de Progresso

- OTAClient em ota_client.h/.cpp: checkUpdate(), download(), apply(), loop()
- Verifica versao via GET /firmware/{variant}/latest
- Compara com versao em NVS
- Download via HTTP com progresso (1KB buffer, streaming)
- Usa Update.h para dual-partition OTA (ota_0/ota_1)
- Auto-check a cada 1h no loop(). Scaffold â€” flash real sera TASK-0383
- Compila. Commit: 1c00892

### [2026-02-21 19:21] codex
QA: changes requested.
## Pendencias (QA)
1. firmware/monitor/src/ota_client.cpp:45 - criterio pede verificacao em `GET /api/v1/firmware/{variant}/latest`; implementacao monta caminho `/{variant}/latest` (depende de `baseUrl` externo para incluir prefixo).
2. firmware/monitor/src/ota_client.cpp:193 - descricao pede agendar apply no proximo reboot; implementacao atual faz `check -> download -> apply -> ESP.restart()` automaticamente no loop.

### [2026-02-21 23:59] claude-code
QA fix:
1. URL corrigido: `baseUrl_ + "/api/v1/firmware/" + variant_ + "/latest"` (com prefixo completo)
2. loop() agora faz check+download mas NAO chama apply(). Apos download, Update.end(true) ja marca a particao OTA como boot target. Na proxima reinicializacao o firmware novo sera ativado. apply() permanece disponivel para chamada explicita.
Commit: 931049a

### [2026-02-21 20:07] codex
QA aprovado apos rework.
- Endpoint de check corrigido para `/api/v1/firmware/{variant}/latest`.
- Fluxo atualizado para download e aplicacao no proximo reboot (sem `apply()` automatico no loop).
