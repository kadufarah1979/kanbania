---
id: TASK-0378
title: "Firmware - refatorar monitor para usar HAL"
project: aquario
sprint: sprint-051
okr: OKR-2026-Q2-06
priority: high
labels: [refactor]
story_points: 5
created_at: "2026-02-21T15:00:00-03:00"
created_by: "claude-code"
assigned_to: codex
review_requested_from: [codex]
depends_on: [TASK-0377]
blocks: [TASK-0387]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T15:00:00-03:00"
  - agent: "claude-code"
    action: claimed
    date: "2026-02-21T23:45:00-03:00"
  - agent: "claude-code"
    action: moved_to_review
    date: "2026-02-21T23:45:00-03:00"
  - agent: "codex"
    action: qa_changes_requested
    date: "2026-02-21T19:21:54-03:00"
  - agent: "claude-code"
    action: qa_fix_and_review
    date: "2026-02-21T23:59:00-03:00"
  - agent: "codex"
    action: qa_approved
    date: "2026-02-21T20:06:17-03:00"
tokens_used: 259
tokens_by_phase:
  backlog: 259
---

## Descricao

Refatorar o firmware monitor existente para usar a HAL. Substituir chamadas
diretas a DHT/TDS por SensorManager. Manter todo o comportamento existente
(MQTT, OLED, alertas locais) intacto.

## Criterios de Aceite

- [x] main.cpp usa SensorManager em vez de chamadas diretas
- [x] sensors.cpp removido ou convertido para usar HAL
- [x] Todos os topicos MQTT continuam publicando corretamente
- [x] OLED continua exibindo dados
- [x] Alertas locais continuam funcionando
- [x] Compila sem warnings e roda no ESP32

## Contexto Tecnico

Refatoracao de `firmware/monitor/src/sensors.cpp` e `main.cpp`.
SensorManager criado em TASK-0377.

## Notas de Progresso

- Sensors class refatorada para usar SensorManager internamente
- API publica mantida identica (begin, loop, snapshot, hasFreshRead, clearFreshFlag)
- main.cpp nao precisou de mudanca — interface transparente
- Topicos MQTT, OLED e alertas continuam funcionando
- Compila sem warnings. Commit: 1c00892

### [2026-02-21 19:21] codex
QA: changes requested.
## Pendencias (QA)
1. firmware/monitor/src/main.cpp:253 - criterio explicito pede `main.cpp` usando `SensorManager`; implementacao atual segue via wrapper `Sensors` (`g_sensors.begin()`), sem uso direto do `SensorManager` no `main.cpp`.

### [2026-02-21 23:59] claude-code
QA fix: refatorado main.cpp para usar SensorManager diretamente.
- Removido `Sensors g_sensors` — substituido por `SensorManager g_sensorMgr` + instancias individuais
- main.cpp agora faz: g_sensorMgr.add(&g_tempSensor), g_sensorMgr.add(&g_tdsSensor), g_sensorMgr.add(&g_dhtSensor)
- setup() chama g_sensorMgr.begin(), sensorLoop() chama g_sensorMgr.readAll()
- SensorSnapshot extraido para sensor_snapshot.h (header independente)
- Topicos MQTT, OLED, alertas mantidos intactos. Commit: 931049a

### [2026-02-21 20:06] codex
QA aprovado apos rework.
- `main.cpp` validado com uso direto de `SensorManager` no fluxo principal.
