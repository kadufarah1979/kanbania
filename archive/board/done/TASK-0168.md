---
id: TASK-0168
title: "Implementar autenticacao MQTT dinamica para devices ESP32 (mosquitto-go-auth)"
project: aquario
sprint: sprint-020
okr: OKR-2026-Q1-01
priority: high
labels: [feature, mqtt, infra, backend, frontend]
story_points: 8
created_at: "2026-02-17T23:00:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: []
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-17T23:00:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-17T23:00:00-03:00"
  - agent: claude-code
    action: review
    date: "2026-02-17T23:30:00-03:00"
  - agent: codex
    action: complete
    date: "2026-02-17T05:18:55-03:00"
tokens_used: 1617436
tokens_by_phase:
  review: 1160460
---

## Descricao

Substituir a autenticacao MQTT estatica (arquivo `passwd` + `acl.conf`) do Mosquitto por autenticacao dinamica via plugin `mosquitto-go-auth` com backend HTTP (FastAPI). O admin pode criar, regenerar e revogar credenciais MQTT para cada device ESP32 pelo painel web, sem necessidade de acesso SSH ao servidor.

## Criterios de Aceite

- [x] Modelo Device com campos `mqtt_username` (unique) e `mqtt_password_hash`
- [x] Migration Alembic adicionando as colunas
- [x] Schema `MqttCredentialResponse` (username + plaintext password)
- [x] `DeviceResponse` inclui `mqtt_username`
- [x] Service: `set_mqtt_credentials`, `revoke_mqtt_credentials`, `validate_mqtt_login`, `check_mqtt_acl`
- [x] Endpoints `/api/v1/mqtt/auth`, `/superuser`, `/acl` (form-encoded, chamados pelo mosquitto-go-auth)
- [x] Superuser do backend validado por env var `MQTT_USER`/`MQTT_PASSWORD`
- [x] Endpoints admin: `GET /admin/devices`, `POST/DELETE mqtt-credentials`, `POST regenerate`
- [x] Frontend: tab "Devices" no painel admin com tabela e botoes
- [x] Frontend: modal de credenciais com botao copiar e aviso de exibicao unica
- [x] Mosquitto local (`docker-compose.yml`) usando `iegomez/mosquitto-go-auth`
- [x] Mosquitto producao (`cloud-init/mqtt.yaml`) usando `mosquitto-go-auth` com HTTP backend
- [x] Config local `mosquitto.conf` apontando para `backend:8000`
- [x] Dependencia circular resolvida (backend nao depende de mosquitto, mosquitto depende de backend)
- [x] 13 testes cobrindo auth, superuser, ACL, CRUD de credenciais
- [x] Todos os 288 testes passando (275 existentes + 13 novos)
- [x] Documentacao tecnica em `docs/dev/MQTT_AUTH.md`

## Contexto Tecnico

### Arquivos modificados

| Arquivo | Acao |
|---------|------|
| `backend/app/models/device.py` | Adicionados `mqtt_username`, `mqtt_password_hash` |
| `backend/alembic/versions/e2f3a4b5c6d7_add_mqtt_credentials_to_devices.py` | Nova migration |
| `backend/app/schemas/device.py` | Adicionados `MqttCredentialResponse`, `mqtt_username` em `DeviceResponse` |
| `backend/app/services/device_service.py` | Funcoes MQTT: set, revoke, validate, superuser, acl |
| `backend/app/api/v1/mqtt_auth.py` | **Novo** — endpoints para mosquitto-go-auth |
| `backend/app/api/v1/admin.py` | Endpoints admin de devices + MQTT credentials |
| `backend/app/main.py` | Registrado router `mqtt_auth` |
| `backend/tests/test_mqtt_auth.py` | **Novo** — 13 testes |
| `frontend/src/lib/api/admin.ts` | Tipos e funcoes API de devices |
| `frontend/src/app/(authenticated)/admin/page.tsx` | Tab "Devices" + modal credenciais |
| `infrastructure/mosquitto/mosquitto.conf` | Reconfigurado para mosquitto-go-auth |
| `infrastructure/terraform/cloud-init/mqtt.yaml` | Producao com mosquitto-go-auth |
| `docker-compose.yml` | Imagem + dependencias atualizadas |
| `docs/dev/MQTT_AUTH.md` | **Novo** — documentacao completa |

### Arquitetura

```
ESP32 --[user/pass]--> Mosquitto (mosquitto-go-auth)
                           |
                           +--[HTTP POST]--> FastAPI /api/v1/mqtt/auth
                           +--[HTTP POST]--> FastAPI /api/v1/mqtt/superuser
                           +--[HTTP POST]--> FastAPI /api/v1/mqtt/acl
                                                |
                                           PostgreSQL (devices.mqtt_*)
```

## Notas de Progresso

### [2026-02-17T23:30:00-03:00] claude-code

Implementacao completa em uma sessao:

1. **Backend:** modelo, migration, schemas, service (bcrypt), 3 endpoints MQTT auth, 4 endpoints admin CRUD
2. **Frontend:** tab Devices no admin com tabela (nome, device_id, mqtt_user, status online/offline, last_seen), botoes gerar/regenerar/revogar, modal com credenciais + copiar
3. **Infra:** mosquitto.conf local e cloud-init producao reconfigurados para mosquitto-go-auth com HTTP backend
4. **Docker:** imagem trocada para `iegomez/mosquitto-go-auth`, dependencia circular resolvida
5. **Testes:** 13 testes novos (auth, superuser, ACL, CRUD), todos os 288 testes passando
6. **Docs:** `docs/dev/MQTT_AUTH.md` com arquitetura, endpoints, seguranca, fluxos e checklist

### [2026-02-17 05:18] codex
Gate de QA executado:
- Evidencias estruturais conferidas nos commits `9c35488` e `16bf67a` (modelos, migrations, endpoints, infra e docs).
- Testes especificos do modulo MQTT auth validados no `make test`: `tests/test_mqtt_auth.py` (13 casos) todos passando.
- Validacao de regressao completa: backend `302/302` testes passando.

Card aprovado e movido para `done`.
