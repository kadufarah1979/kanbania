---
id: TASK-0241
title: "Backend+Firmware: instrumentar medicao de latencia comando-a-atuacao"
project: aquario
sprint: sprint-030
okr: OKR-2026-Q1-02
priority: high
labels: [feature, backend, firmware]
story_points: 3
created_at: "2026-02-19T16:30:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: []
depends_on: []
blocks: []
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-19T16:30:00-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-19T02:49:33-03:00"
  - agent: codex
    action: move-to-review
    date: "2026-02-19T03:02:38-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-19T14:00:47-03:00"

tokens_used: 1575014
tokens_by_phase:
  in_progress: 1555358
---

## Descricao

Para atingir KR-03 (latencia < 2s), precisamos medir o tempo entre o envio do comando pelo backend e a confirmacao de atuacao pelo firmware. Implementar instrumentacao end-to-end.

## Criterios de Aceite

- [x] Firmware envia confirmacao MQTT apos atuar no rele (topico `aquario/{device_id}/relay/ack`)
- [x] Payload do ack inclui: channel, state, command_timestamp (recebido), ack_timestamp
- [x] Backend consumer processa ack e calcula latencia (ack_timestamp - command_timestamp)
- [x] Latencia registrada em log ou metrica (campo em RelayActionLog ou tabela separada)
- [x] Endpoint GET /api/v1/relays/latency retorna estatisticas (avg, p95, max)
- [x] Testes para o fluxo de medicao

## Contexto Tecnico

- Firmware ja publica /state com channel_states — o ack pode ser um topico separado ou extender o /state
- Backend precisa correlacionar comando enviado com ack recebido (usar command_timestamp como chave)
- Clock do ESP32 nao e preciso — usar timestamp do broker ou RTT approach

## Notas de Progresso

- 2026-02-19T03:13:10-03:00 (codex): Instrumentacao end-to-end de latencia comando->atuacao implementada.
  - Firmware (`firmware/relay_controller/src/main.cpp`): publicado ACK em `aquario/{device_id}/relay/ack` apos atuacao, com `channel`, `state`, `command_timestamp`, `ack_timestamp`.
  - Backend consumer (`backend/app/mqtt/consumer.py`, `backend/app/mqtt/handlers.py`): suporte ao tipo de topico `ack` e processamento de ACK com correlacao por canal/acao e timestamps.
  - Persistencia (`backend/app/models/relay_action_log.py`, migration `backend/alembic/versions/7c8d9e0f1a2b_add_relay_ack_latency_fields.py`): novos campos `command_timestamp`, `ack_timestamp`, `latency_ms`.
  - Servico/API (`backend/app/services/relay_service.py`, `backend/app/api/v1/relays.py`, `backend/app/schemas/automation.py`): registro de ACK e endpoint `GET /api/v1/relays/latency` com `avg_ms`, `p95_ms`, `max_ms`.
  - Ajuste complementar em `backend/app/services/automation_service.py` para publicar comando com `command_timestamp` e preencher log.
  - Evidencias:
    - `docker compose exec -T backend pytest -q tests/test_automation_service.py` => 51 passed.
    - `PLATFORMIO_CORE_DIR=/tmp/pio-core ../.venv/bin/pio run` => SUCCESS.

- 2026-02-19T14:00:47-03:00 codex: QA concluido; criterios de aceite validados, aprovado para done.
