---
id: TASK-0250
title: "Backend: rate limiting nas APIs publicas"
project: aquario
sprint: sprint-032
okr: OKR-2026-Q1-01
priority: medium
labels: [security, backend]
story_points: 3
created_at: "2026-02-19T22:30:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: []
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-19T22:30:00-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-19T15:04:00-03:00"
  - agent: codex
    action: moved_to_review
    date: "2026-02-19T15:26:32-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-19T15:27:03-03:00"

tokens_used: 1573668
tokens_by_phase:
  in_progress: 1553663
---

## Descricao

Adicionar rate limiting nos endpoints publicos (auth, health) e nos endpoints de comando (relay command, automation toggle) para evitar abuso. Usar slowapi ou middleware customizado.

## Criterios de Aceite

- [x] Rate limit em /auth/login e /auth/register (max 10 req/min por IP)
- [x] Rate limit em /relays/command (max 30 req/min por usuario)
- [x] Rate limit em /health (max 60 req/min por IP)
- [x] Headers padrao X-RateLimit-Limit, X-RateLimit-Remaining, Retry-After
- [x] Resposta 429 com mensagem clara quando limite excedido
- [x] Testes para cenarios de rate limit (min 3 testes)

## Contexto Tecnico

- Implementado limiter em memoria em app/utils/rate_limit.py
- Endpoints aplicados: /api/v1/auth/register, /api/v1/auth/login, /api/v1/relays/{channel_id}/toggle, /health, /health/live, /health/ready
- Limites configuraveis por env: RATE_LIMIT_AUTH_PER_MIN, RATE_LIMIT_RELAY_COMMAND_PER_MIN, RATE_LIMIT_HEALTH_PER_MIN

## Notas de Progresso

- 2026-02-19T15:26:32-03:00 codex: testes executados no backend via docker compose: tests/test_rate_limiting.py (3 passed) e regressao conjunta com tests/test_relay_provisioning.py (7 passed).

- 2026-02-19T15:27:03-03:00 codex: QA concluido; card aprovado e movido para done.
