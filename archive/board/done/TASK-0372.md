---
id: TASK-0372
title: "Backend - sistema de calibracao de cores por kit (admin)"
project: aquario
sprint: sprint-050
okr: OKR-2026-Q2-05
priority: high
labels: [feature]
story_points: 5
created_at: "2026-02-21T15:00:00-03:00"
created_by: "claude-code"
assigned_to: claude-code
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0373, TASK-0374]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T15:00:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-21T22:15:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-21T22:30:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-21T18:03:39-03:00"
tokens_used: 259
tokens_by_phase:
  backlog: 259
---

## Descricao

Criar sistema de calibracao de cores por kit de teste via admin. Cada kit tem uma
paleta de referencia (lista de cores CIELAB mapeadas para valores do parametro).
Admin pode cadastrar, editar e validar paletas.

## Criterios de Aceite

- [x] Model `test_kit_color_palette` com campos: kit_id, color_lab (L,a,b), parameter_value, position
- [x] Migration Alembic
- [x] Endpoints CRUD admin: POST/PUT/DELETE /admin/test-kits/{id}/palette
- [x] Endpoint GET /admin/test-kits/{id}/palette para listar paleta
- [x] Testes de integracao

## Contexto Tecnico

Extensao do modelo test_kit existente. CIELAB e o espaco de cor mais adequado para
color matching perceptual. Cada entrada da paleta mapeia um ponto de cor para um valor.

## Notas de Progresso

- Reutilizado modelo existente `TestKitColorScale` que ja possui campos CIELAB (lab_l, lab_a, lab_b), hex, RGB, value, sort_order, tolerance
- Nao necessario nova migration — modelo ja existia desde sprint-048
- 4 novos endpoints admin para CRUD individual de paleta:
  - GET /admin/test-kits/{kit_id}/palette — lista ordenada por sort_order
  - POST /admin/test-kits/{kit_id}/palette — adiciona entrada individual
  - PUT /admin/test-kits/{kit_id}/palette/{entry_id} — atualiza entrada
  - DELETE /admin/test-kits/{kit_id}/palette/{entry_id} — remove entrada
- 3 service functions: add_color_scale_entry, update_color_scale_entry, delete_color_scale_entry + get_color_scale_entry
- 7 testes de integracao: list, add (com CIELAB), update, delete, 404 nonexistent, 403 non-admin
- 21/21 testes passando. Commit: e865973

### [2026-02-21 18:03] codex
QA aprovado. Implementacao cobre CRUD admin de paleta com validacao de acesso e testes de integracao.
