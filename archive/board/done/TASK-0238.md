---
id: TASK-0238
title: "Frontend: atualizar automation page e store para novo schema do backend"
project: aquario
sprint: sprint-030
okr: OKR-2026-Q1-02
priority: critical
labels: [feature, frontend]
story_points: 5
created_at: "2026-02-19T16:30:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: []
depends_on: []
blocks: [TASK-0239, TASK-0242]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-19T16:30:00-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-19T02:36:47-03:00"
  - agent: codex
    action: move-to-review
    date: "2026-02-19T02:44:21-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-19T14:00:47-03:00"

tokens_used: 1604229
tokens_by_phase:
  in_progress: 1558748
  review: 25558
---

## Descricao

A sprint-028 refatorou o backend: `sensor_parameter` -> `sensor_type`, `target_device_id` + `target_channel` -> `target_channel_id` (FK RelayChannel), `cooldown_minutes` -> `cooldown_seconds`, `AutomationEvent` -> `RelayActionLog`. O frontend ainda usa os campos antigos e precisa ser atualizado.

## Criterios de Aceite

- [x] `automation-store.ts` atualizado para novos campos (sensor_type, target_channel_id, cooldown_seconds, last_triggered_at)
- [x] `lib/api/automation.ts` types e chamadas atualizadas para novo schema
- [x] `AutomationRuleForm` usa target_channel_id (select de RelayChannel) em vez de target_device_id + target_channel
- [x] Historico de eventos usa RelayActionLog response (relay_channel_id, triggered_by, rule_id, timestamp)
- [x] Pagina de automacao renderiza corretamente com novos campos
- [x] Testes frontend atualizados

## Contexto Tecnico

- Backend endpoints nao mudaram de URL, apenas o schema dos campos
- AutomationRuleResponse agora tem: sensor_type, target_channel_id, cooldown_seconds, last_triggered_at
- RelayActionLogResponse: relay_channel_id, action, triggered_by, rule_id, timestamp
- Buscar relay channels via GET /api/v1/relays/ para popular select no form

## Notas de Progresso

- 2026-02-19T02:43:58-03:00 (codex): Implementacao concluida no frontend com migracao para novo schema de automacao.
  - `frontend/src/lib/api/automation.ts`: tipos atualizados para `sensor_type`, `target_channel_id`, `cooldown_seconds` e historico `RelayActionLog`; adicionado `getAutomationRuleHistory` e `getRelayChannels`.
  - `frontend/src/stores/automation-store.ts`: estado/tipos atualizados, carga de `relayChannels` e historico agregado via `GET /automation-rules/{id}/history`.
  - `frontend/src/components/automation/automation-rule-form.tsx`: form migrado para selecionar `target_channel_id` e enviar `cooldown_seconds`.
  - `frontend/src/app/(authenticated)/automation/page.tsx`: renderizacao de regras/historico ajustada para novo schema e labels de canais de rele.
  - `frontend/src/__tests__/pages/automation-page.test.tsx`: testes atualizados para novo contrato.
  - Evidencias:
    - `npm run test -- src/__tests__/pages/automation-page.test.tsx src/__tests__/hooks/use-aquarium-ws.test.ts` => 17 passed.
    - `npx tsc --noEmit` => OK.

- 2026-02-19T14:00:47-03:00 codex: QA concluido; criterios de aceite validados, aprovado para done.
