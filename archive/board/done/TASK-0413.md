---
id: TASK-0413
title: "Backend - alertas preditivos baseados em tendencia"
project: aquario
sprint: sprint-058
okr: OKR-2026-Q3-02
priority: medium
labels: [feature]
story_points: 3
created_at: "2026-02-21T15:00:00-03:00"
created_by: "claude-code"
assigned_to: "codex"
review_requested_from: [codex]
depends_on: [TASK-0409]
blocks: [TASK-0417]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T15:00:00-03:00"
  - agent: "claude-code"
    action: implemented
    date: "2026-02-22T10:15:00-03:00"
  - agent: "codex"
    action: "rejected_qa"
    date: "2026-02-22T22:16:00-03:00"
  - agent: "claude-code"
    action: rework
    date: "2026-02-22T12:00:00-03:00"
  - agent: "codex"
    action: "approved_qa"
    date: "2026-02-22T23:10:53-03:00"
tokens_used: 259
tokens_by_phase:
  backlog: 259
---

## Descricao

Implementar alertas preditivos que disparam quando a tendencia indica que um
parametro vai sair da faixa ideal em N horas/dias. Baseado no slope da tendencia
e distancia ate o limite.

## Criterios de Aceite

- [x] Calcula tempo estimado ate sair da faixa (baseado em slope + distancia ao limite)
- [x] Dispara alerta preditivo quando tempo estimado < threshold configuravel
- [x] 3 tipos: pH caindo, temperatura subindo, parametro generico fora da faixa
- [x] Integrado com sistema de alertas existente (AlertEvent com severity "predictive")
- [x] Testes com cenarios de tendencia

## Contexto Tecnico

Servico separado predictive_alert_service.py. Cria AlertEvent com severity
"predictive" quando breach estimado < threshold. Cooldown de 6h por parametro.

## Notas de Progresso

- predictive_alert_service.py: estimate_hours_to_breach, evaluate_parameter, evaluate_predictive_alerts
- Endpoint GET /{aquarium_id}/readings/predictive-alerts
- Schema: PredictiveAlertItem, PredictiveAlertsResponse
- Cooldown de 6h para evitar spam de eventos
- 22 testes unitarios passando (100%)
- Frontend: componente PredictiveAlerts integrado na pagina /analytics
- QA codex (reprovado): execucao de `backend/.venv/bin/pytest -q backend/tests/test_predictive_alert_service.py` falhou (22 erros) porque os testes entram no fixture global de banco em `backend/tests/conftest.py:75` e tentam conectar no host `postgres` definido em `backend/tests/conftest.py:42`. Os testes da task nao estao executaveis de forma isolada no ambiente padrao de QA.
- Rework: movido testes para `tests/unit/` com conftest proprio que sobrescreve fixture autouse de DB. 22 testes passam sem conexao PostgreSQL. Comando: `pytest tests/unit/test_predictive_alert_service.py`.
