---
id: TASK-0147
title: "Testes backend: WebSocket hub (conexao, broadcast, auth)"
project: aquario
sprint: sprint-018
okr: OKR-2026-Q1-01
priority: high
labels: [test, backend, websocket]
story_points: 3
created_at: "2026-02-16T20:00:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: [TASK-0145]
blocks: [TASK-0148]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-16T20:00:00-03:00"
  - agent: claude-code
    action: in-progress
    date: "2026-02-16T22:00:00-03:00"
  - agent: claude-code
    action: review
    date: "2026-02-16T22:30:00-03:00"
  - agent: codex
    action: complete
    date: "2026-02-17T00:04:43-03:00"
tokens_used: 2911832
tokens_by_phase:
  backlog: 994786
  review: 756720
---

## Descricao

Criar testes para o WebSocket hub (`backend/app/ws/hub.py`). Validar autenticacao por token, subscribe por aquario, broadcast de eventos e reconexao.

## Criterios de Aceite

- [x] Teste de conexao com token valido
- [x] Teste de rejeicao com token invalido
- [x] Teste de subscribe por aquarium_id
- [x] Teste de broadcast de evento reading para clientes conectados
- [x] Teste de broadcast de evento alert
- [x] Teste de desconexao limpa
- [x] `make test` passa sem erros

## Notas de Progresso

### Cobertura existente (8 testes)
- broadcast_to_connected_client, broadcast_removes_dead_connections, broadcast_no_connections
- multiple_event_types (reading, alert, device_status, alert_ack)
- broadcast_only_to_target_aquarium (subscribe isolation)
- authenticate_valid_token, authenticate_invalid_token
- websocket_endpoint_exists

### Nova cobertura (6 testes)
- handle_connection_invalid_token_closes: token invalido → close(4001)
- handle_connection_no_ownership_closes: sem ownership → close(4003)
- add_and_remove_connection: _add incrementa, _remove decrementa
- remove_nonexistent_connection: _remove de conn desconhecida e no-op
- handle_connection_accepts_and_tracks: auth ok → accept → track → cleanup on disconnect
- handle_connection_ping_pong: client "ping" → server "pong"

### Resultado
- `make test`: **261 passed** em 44.94s, sem erros

### [2026-02-17 00:04] codex
QA concluido: criterios e evidencias validados; card aprovado para done.
