---
id: TASK-0286
title: "Test Kits MVP: models, migration, seed Labcon e API endpoints"
project: aquario
sprint: sprint-038
okr: null
priority: high
labels: [feature]
story_points: 5
created_at: "2026-02-21T02:00:00-03:00"
created_by: "claude-code"
assigned_to: "codex"
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0287]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T02:00:00-03:00"
  - agent: "claude-code"
    action: claimed
    date: "2026-02-21T02:10:00-03:00"
  - agent: "claude-code"
    action: completed
    date: "2026-02-21T03:30:00-03:00"
  - agent: "codex"
    action: qa_approved
    date: "2026-02-21T03:22:11-03:00"
tokens_used: 122369
tokens_by_phase:
  backlog: 2829
  review: 24791
---

## Descricao

Implementar o backend MVP do sistema de testadores quimicos (Test Kits). Criar os modelos SQLAlchemy, migration Alembic, seed de kits Labcon pre-cadastrados e endpoints de API para admin CRUD e consulta do usuario.

## Criterios de Aceite

- [x] Model `TestKitBrand` criado (name, slug, country, website, logo_url)
- [x] Model `TestKit` criado (brand_id, name, slug, param_code, aquarium_types, test_type, instructions, drops_count, wait_seconds, sample_ml, conversion_factor)
- [x] Model `TestKitColorScale` criado (test_kit_id, sort_order, value, label, hex_color, rgb, lab, tolerance)
- [x] Migration Alembic rodada com sucesso
- [x] Seed data: fabricante Labcon + 6 kits (Amonia Doce, Nitrito Doce, Nitrato Doce, pH Doce, pH Marinho, KH) com escalas de cores
- [x] Endpoints admin: CRUD fabricantes (`/api/v1/admin/test-kit-brands`)
- [x] Endpoints admin: CRUD kits (`/api/v1/admin/test-kits`) com escala de cores
- [x] Endpoints usuario: listar kits disponiveis (`GET /api/v1/test-kits`), detalhe, filtrar por param_code
- [x] Multi-tenant isolation em todas as queries
- [x] Testes unitarios para os endpoints principais

## Contexto Tecnico

- Spec completa: `docs/dev/TEST_KITS.md`
- Dados de seed: secao 8 do spec (kits Labcon com escalas de cores)
- Campo `test_type`: `colorimetric` (comparacao de cor) ou `titration` (contagem de gotas)
- Campo `conversion_factor`: para testes de titulacao (ex: KH = 1 gota = 1 dKH)
- Referencia de param_codes: `docs/dev/PARAMETERS.md`
- Padrao de service/router: seguir o mesmo padrao de `filter_media_service.py` e `backend/app/api/v1/filter_media.py`
- Nao implementar analise de foto nesta tarefa (sera fase 2)

## Notas de Progresso

### 2026-02-21 - Implementacao completa (claude-code)

**Arquivos criados:**
- `backend/app/models/test_kit.py` - 3 models: TestKitBrand, TestKit, TestKitColorScale
- `backend/app/schemas/test_kit.py` - Pydantic schemas para CRUD
- `backend/app/services/test_kit_service.py` - Service layer com CRUD + color scale management
- `backend/app/api/v1/test_kits.py` - 3 routers: admin brands, admin kits, user kits
- `backend/app/data/test_kit_seeds.py` - Seed data Labcon (1 brand + 6 kits)
- `backend/alembic/versions/f1d0cc054376_add_test_kit_tables.py` - Schema migration
- `backend/alembic/versions/28ccda1fb45a_seed_test_kits_labcon.py` - Seed data migration
- `backend/tests/test_test_kits.py` - 15 integration tests (todos passando)

**Arquivos atualizados:**
- `backend/app/models/__init__.py` - imports dos novos models
- `backend/app/main.py` - registro dos 3 routers

**Resultados dos testes:** 471 passed, 1 failed (falha pre-existente em test_google_auth.py, nao relacionada)

### 2026-02-21 - QA aprovado (codex)

Revalidado com `make test` no ambiente Docker do projeto: `471 passed, 1 failed`, mantendo a mesma falha pre-existente em `tests/test_google_auth.py`.
