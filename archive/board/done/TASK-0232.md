---
id: TASK-0232
title: "Implementar autenticacao de aplicacao e contexto de tenant por requisicao"
project: consoleai
sprint: null
okr: null
priority: critical
labels: [security, backend, auth]
story_points: 3
created_at: "2026-02-19T00:04:11-03:00"
created_by: codex
assigned_to: codex
review_requested_from: [codex]
depends_on: [TASK-0231]
blocks: [TASK-0236]
acted_by:
  - agent: codex
    action: created
    date: "2026-02-19T00:04:11-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-19T00:20:11-03:00"
  - agent: codex
    action: release
    date: "2026-02-19T16:49:13-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-19T20:44:53-03:00"
  - agent: codex
    action: move
    date: "2026-02-19T21:00:59-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-19T21:09:10-03:00"
  - agent: codex
    action: update
    date: "2026-02-19T21:32:15-03:00"
  - agent: codex
    action: move
    date: "2026-02-19T21:32:15-03:00"
  - agent: codex
    action: move
    date: "2026-02-19T22:34:53-03:00"
tokens_used: 1970025
tokens_by_phase:
  backlog: 1555810
  in_progress: 281905
  review: 606
---

## Descricao

Adicionar autenticacao da API e resolucao explicita de contexto de tenant por requisicao para reforcar isolamento multi-tenant.

## Criterios de Aceite

- [x] Middleware/dependency de autenticacao implementado para API.
- [x] Contexto de tenant resolvido e validado por requisicao.
- [x] Requisicoes fora de escopo tenant retornam erro autorizado.
- [x] Testes cobrindo autenticacao valida/invalida e isolamento tenant.

## Contexto Tecnico

Aplicar regras de autorizacao existentes em `authz.py` e evitar bypass via parametros livres em query/body.

## Notas de Progresso

### [2026-02-19 00:04] codex
Task criada no planejamento da sprint-029.

### [2026-02-19 21:32] codex
Implementacao concluida para autenticacao de aplicacao e isolamento por tenant na API:
- `src/consoleai/api.py`: removido `reviewer_user_id` do body de review (identidade passa a vir do contexto autenticado da requisicao); 
- `src/consoleai/api.py`: adicionado `_assert_task_request_in_context(...)` para validar escopo de tenant em `workflow_detail` e `workflow_review`, bloqueando acesso cross-tenant por ID;
- `tests/test_api.py`: adicionados testes de `X-Api-Key` (invalida/valida), isolamento cross-tenant para workflow detail/review e ajuste do contrato de review sem `reviewer_user_id`.

Validacoes executadas:
- `PYTHONPATH=src .venv/bin/python -m pytest -q tests/test_api.py tests/test_authz.py` (18 passed)
- `PYTHONPATH=src .venv/bin/python -m pytest -q tests/test_workflow_service.py` (12 passed)

### [2026-02-19 22:34] codex
Gate de QA concluido para TASK-0232:
- validacao independente no repositorio `/home/carlosfarah/Projects/consoleai`;
- comando executado: `PYTHONPATH=src .venv/bin/python -m pytest -q tests/test_api.py tests/test_authz.py tests/test_workflow_service.py`;
- resultado: `30 passed`.
Card aprovado e movido de `review` para `done`.
