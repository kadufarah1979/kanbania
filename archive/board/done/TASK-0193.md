---
id: TASK-0193
title: "Backend: Google Sign-In (OAuth2 / id_token)"
project: aquario
sprint: sprint-025
okr: OKR-2026-Q1-01
priority: high
labels: [backend, auth]
story_points: 5
created_at: "2026-02-18T18:00:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0194]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-18T18:00:00-03:00"
  - agent: codex
    action: update
    date: "2026-02-18T18:54:22-03:00"
  - agent: codex
    action: complete
    date: "2026-02-18T19:41:07-03:00"
tokens_used: 1737537
tokens_by_phase:
  backlog: 1553137
  in_progress: 184402
---

## Descricao

Implementar endpoint POST /auth/google que recebe id_token do Google, valida com google-auth, busca ou cria usuario no banco, e retorna JWT access+refresh tokens. Conforme docs/dev/GOOGLE_SIGN_IN.md.

## Criterios de Aceite

- [x] Endpoint POST /api/v1/auth/google aceita {id_token}
- [x] Valida id_token com google.oauth2.id_token.verify_oauth2_token
- [x] Cria usuario automaticamente se nao existe (email do Google, username gerado)
- [x] User.hashed_password nullable (usuarios Google nao tem senha)
- [x] Retorna access_token + refresh_token (mesmo formato do login normal)
- [x] Migration para tornar hashed_password nullable
- [x] Env vars: GOOGLE_CLIENT_ID configuravel
- [x] Testes unitarios com mock do Google API

## Contexto Tecnico

Backend: `/home/carlosfarah/Projects/aquario/backend/`
Doc: `docs/dev/GOOGLE_SIGN_IN.md`

Dependencia Python: `google-auth>=2.0.0`

Fluxo: Frontend envia id_token -> Backend valida com Google -> Busca user por email -> Se nao existe, cria com google_id e sem senha -> Retorna JWT

Model User existente em `backend/app/models/user.py`. Precisa adicionar campo `google_id` (VARCHAR, nullable, unique) e tornar `hashed_password` nullable.

## Notas de Progresso

### [2026-02-18 18:00] claude-code
Card criado para implementacao de Google Sign-In no backend.

### [2026-02-18 18:30] claude-code
Implementacao completa. Commit 5c51782. Arquivos:
- `backend/app/models/user.py`: Adicionados campos google_id (unique, nullable) e auth_provider (default "local"). hashed_password agora nullable.
- `backend/app/schemas/auth.py`: Adicionado GoogleAuthRequest schema
- `backend/app/api/v1/auth.py`: Endpoint POST /auth/google com validacao de id_token, busca/cria usuario, link de conta existente por email, geracao de JWT. Helper _verify_google_token e _generate_username.
- `backend/alembic/versions/b2c3d4e5f6a7_add_google_auth_fields.py`: Migration adicionando google_id, auth_provider e tornando hashed_password nullable
- `backend/pyproject.toml`: Adicionada dependencia google-auth>=2.0.0
- `backend/tests/test_google_auth.py`: 8 testes (novo usuario, link conta existente, login google existente, token invalido, nao configurado, sem email, usuario google nao faz login por senha)
364 testes passando.

### [2026-02-18 18:54] codex
QA reprovado e retornado para in-progress. Implementacao consta no commit informado, mas criterios de aceite seguem integralmente desmarcados no card em review. Atualizar checklist e anexar evidencia objetiva da execucao dos testes unitarios de Google Sign-In no ambiente alvo.

### [2026-02-18 19:05] claude-code
Revalidacao pos-QA. 8/8 testes passando (test_google_auth.py). Criterios marcados. Evidencia:
- Endpoint: `POST /auth/google` em `auth.py:116`
- Validacao: `verify_oauth2_token` em `auth.py:112`
- Auto-create user: `_generate_username` + create em handler
- `hashed_password` nullable: `user.py:19`
- `google_id` unique: `user.py:23`
- Migration: `b2c3d4e5f6a7_add_google_auth_fields.py`
- Env: `GOOGLE_CLIENT_ID` em `auth.py:95`
- Testes: 8 passed (new user, link existing, login existing, invalid token, not configured, no email, password blocked, username gen)

### [2026-02-18 19:41] codex
QA aprovado. Card normalizado e elegivel para done.
