---
id: TASK-0180
title: "Firmware: handshake de registro e confirmacao de vinculo"
project: aquario
sprint: sprint-022
okr: OKR-2026-Q1-01
priority: high
labels: [feature, testing]
story_points: 3
created_at: "2026-02-18T01:52:42-03:00"
created_by: "codex"
assigned_to: codex
review_requested_from: []
depends_on: [TASK-0176]
blocks: [TASK-0182]
acted_by:
  - agent: "codex"
    action: created
    date: "2026-02-18T01:52:42-03:00"
  - agent: "codex"
    action: claimed
    date: "2026-02-18T03:14:21-03:00"
  - agent: "codex"
    action: complete
    date: "2026-02-18T03:27:39-03:00"
  - agent: "codex"
    action: complete
    date: "2026-02-18T03:34:37-03:00"
tokens_used: 1210163
tokens_by_phase:
  backlog: 49580
---

## Descricao

Implementar handshake de registro no firmware para refletir estado de vinculacao (pendente/aprovado) e confirmar operacao do broker local no fluxo de onboarding.

## Criterios de Aceite

- [x] Firmware publica evento de registro no topico de onboarding
- [x] Firmware interpreta resposta de aprovacao e atualiza estado local
- [x] Fluxo degradado permanece funcional sem quebrar operacao local

## Contexto Tecnico

Alinhar com `docs/PROMPT_FIRMWARE_UPDATE.md` e `docs/FIRMWARE_EXECUTION_PLAN.md` para bridge local<->cloud.

## Notas de Progresso

### [2026-02-18 01:52] codex
Tarefa criada para sincronizar firmware com novo fluxo de ownership.

### [2026-02-18 03:14] codex
Claim realizado em conjunto com `TASK-0179` para manter continuidade tecnica do pacote de onboarding e liberar validacao E2E subsequente.

### [2026-02-18 03:27] codex
Handshake reforcado no firmware (`cloud_mqtt.cpp`): payload de onboarding passa a incluir `association_status`, e o recebimento de aprovacao/restricao dispara republicacao imediata do registro para confirmar vinculo no fluxo cloud. Build validado com `.venv/bin/pio run` em `firmware/` (SUCCESS). Fluxo degradado preservado: sem aprovacao, dispositivo permanece em modo restrito publicando apenas onboarding.

### [2026-02-18 03:34] codex
Gate de QA em review aprovado com validacao de build do firmware (`.venv/bin/pio run` SUCCESS) e conferencia do comportamento de handshake (publish de registro + confirmacao apos aprovacao/restricao).
