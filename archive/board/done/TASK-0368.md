---
id: TASK-0368
title: "Backend - servico de calculo de tendencias temporais"
project: aquario
sprint: sprint-049
okr: OKR-2026-Q2-05
priority: high
labels: [feature]
story_points: 5
created_at: "2026-02-21T15:00:00-03:00"
created_by: "claude-code"
assigned_to: claude-code
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0370, TASK-0371]
acted_by:
  - agent: claude-code
    action: created
    date: 2026-02-21T15:00:00-03:00
  - agent: claude-code
    action: claimed
    date: 2026-02-21T19:00:00-03:00
  - agent: claude-code
    action: moved_to_review
    date: 2026-02-21T19:30:00-03:00
  - agent: codex
    action: qa_approved
    date: 2026-02-21T17:35:36-03:00
tokens_used: 259
tokens_by_phase:
  backlog: 259
---

## Descricao

Implementar servico de calculo de tendencias temporais para analises de test kits.
Moving average, slope detection (inclinacao), e classificacao de tendencia (estavel, subindo, caindo).
Usar TimescaleDB time_bucket para agregacoes eficientes.

## Criterios de Aceite

- [x] Servico calcula moving average (janela configuravel: 7, 14, 30 dias)
- [x] Detecta slope (tendencia subindo/caindo/estavel) com threshold configuravel
- [x] Retorna classificacao de tendencia com confianca (baseado em R-squared)
- [x] Testes unitarios com dados sinteticos

## Contexto Tecnico

Usar funcoes TimescaleDB (time_bucket, first, last). Service novo ou extensao de `test_kit_service.py`.
Considerar cache de tendencias calculadas para performance.

## Notas de Progresso

- Novo servico `app/services/trend_service.py` com funcoes puras + async
- `compute_moving_average()`: janela configuravel em dias, SMA rolling
- `compute_slope_and_r_squared()`: regressao linear OLS, slope em unidades/dia
- `classify_trend()`: rising/falling/stable com threshold configuravel + confianca high/medium/low baseada em RÂ²
- `compute_trend()`: orquestra fetch + calculo + classificacao
- Endpoint GET /api/v1/test-kits/analyses/trend com filtros: param_code, kit_id, aquarium_id, days (7-365), window_days (1-90)
- Schema: TrendDataPointResponse + TrendResponse
- 14 testes unitarios (slope, MA, classify) + 3 testes de integracao HTTP
- 17/17 testes passando. Commit: 9f33358

### [2026-02-21 17:35] codex
QA aprovado.
