---
id: TASK-0051
title: "Marketplace schema + migration"
project: aquario
sprint: sprint-008
okr: OKR-2026-Q1-01
priority: critical
labels: [backend, database]
story_points: 3
created_at: "2026-02-15T04:30:00-03:00"
created_by: claude-code
assigned_to: null
review_requested_from: [codex]
depends_on: [TASK-0050]
blocks: [TASK-0052]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-15T04:30:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-15T05:00:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-15T06:00:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T01:50:12-03:00"
  - agent: claude-code
    action: approved
    date: "2026-02-15T15:00:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T02:26:41-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T02:27:20-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T02:33:50-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T02:37:07-03:00"
tokens_used: 2260733
tokens_by_phase:
  backlog: 1985537
  in_progress: 275228
---

## Descricao

Create Alembic migration with listings table, listing_media table, add user marketplace fields. Indexes for category+status, user_id, full-text Portuguese.

## Criterios de Aceite

- [ ] Migration file created
- [ ] listings table with all fields (id, user_id, title, description, category, condition, price, quantity, location_city, location_state, status, category_fields JSONB, photo_urls JSONB, views_count, expires_at, timestamps)
- [ ] listing_media table (id, listing_id, media_type, file_url, thumbnail_url, display_order, created_at)
- [ ] Users table: seller_rating, total_sales, is_store_owner columns added
- [ ] Indexes: category+status+created_at, user_id, full-text Portuguese

## Notas de Progresso

- 2026-02-15T01:50:12-03:00 — QA: changes requested (gate results: FAILED). Problemas reais: migration nao cria o indice exigido `category+status+created_at` (foi criado indice parcial em `category + created_at` com `WHERE status='active'`), e os campos `id` de `listings`/`listing_media` usam `default` em vez de `server_default` para `gen_random_uuid()`, deixando o banco sem default no DDL. Card mantido em `review` por ausencia de `acted_by: claude-code approved`.
- 2026-02-15T02:26:41-03:00 — QA: changes requested (gate results: FAILED). Problemas reais: migration `backend/alembic/versions/a1b2c3d4e5f6_marketplace_schema.py` nao criou indice dedicado de `user_id` (foi criado indice composto `user_id + created_at DESC`), e o `BACKEND_GATE` permanece em FAILED com 129 erros (nao-classificado como erro de ambiente/rede).
- 2026-02-15T02:27:20-03:00 — QA: changes requested (gate results: FAILED). Problemas reais: migration `backend/alembic/versions/a1b2c3d4e5f6_marketplace_schema.py` ainda nao cria indice dedicado de `user_id` (foi criado `idx_listings_user_id` em `user_id + created_at DESC`, divergindo do criterio), e o `BACKEND_GATE` segue FAILED com 214 erros (nao-classificado como erro de ambiente/rede).
- 2026-02-15T02:33:50-03:00 — QA: changes requested (gate results: FAILED). Revalidacao funcional: a migration `backend/alembic/versions/a1b2c3d4e5f6_marketplace_schema.py` agora atende os criterios de schema e indices do card (incluindo `user_id` dedicado). Entretanto, o pre-review informado permanece bloqueante com `BACKEND_GATE: FAILED — 129 errors in 27.60s` (nao classificado como ambiente/rede), portanto o gate final nao pode ser aprovado nesta rodada.
- 2026-02-15T02:37:07-03:00 — QA: aprovado (gate results: PASSED). Revalidacao final confirma que a migration `backend/alembic/versions/a1b2c3d4e5f6_marketplace_schema.py` atende todos os criterios de aceite (schema, colunas em `users`, indices `category+status+created_at`, `user_id` dedicado e full-text em portugues).
