---
id: TASK-0202
title: "Modelar entidades de tenant (OU), papéis e vínculo usuário-tenant"
project: consoleai
sprint: null
okr: null
priority: high
labels: [feature, backend, devops]
story_points: 3
created_at: "2026-02-18T16:53:59-03:00"
created_by: "codex"
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0203, TASK-0204, TASK-0205]
acted_by:
  - agent: "codex"
    action: created
    date: "2026-02-18T16:53:59-03:00"
  - agent: "codex"
    action: update
    date: "2026-02-19T16:07:47-03:00"
  - agent: "codex"
    action: update
    date: "2026-02-19T18:20:59-03:00"
  - agent: "codex"
    action: claimed
    date: "2026-02-19T19:36:26-03:00"
  - agent: "codex"
    action: update
    date: "2026-02-19T19:44:06-03:00"
  - agent: "codex"
    action: move
    date: "2026-02-19T19:44:06-03:00"
  - agent: "codex"
    action: move
    date: "2026-02-19T20:17:07-03:00"
tokens_used: 1789859
tokens_by_phase:
  todo: 77283
---

## Descricao

Definir e implementar o modelo base multi-tenant usando OU como tenant, incluindo tabelas/estruturas para tenants, papéis (devops, desenvolvedor, gestor) e associação de usuários a um ou mais tenants.

## Criterios de Aceite

- [x] Estruturas de dados de tenant, papel e associação usuário-tenant implementadas e versionadas
- [x] Relacionamentos validados com constraints de integridade (sem associação órfã)
- [x] Migração executável em ambiente local com rollback documentado

## Contexto Tecnico

Fundação para RBAC por tenant e para o escopo de visibilidade dos recursos AWS. Sem este card não é possível aplicar autorização granular.

## Notas de Progresso

### [2026-02-18 16:53] codex
Card criado para iniciar a base de dados do modelo multi-tenant por OU.

### [2026-02-19 19:44] codex
Conclusao da TASK-0202 no projeto `consoleai`:
- reforcada evidência de modelagem base multi-tenant na migration 001 (`tenants`, `roles`, `users`, `user_roles`, `user_tenants`) com seed de papeis (`devops`, `developer`, `manager`);
- adicionados testes de integridade em `tests/test_migration_001.py` para garantir bloqueio de associacoes orfas em `user_tenants` (FK de `user_id` e `tenant_id`);
- adicionado teste de rollback `rollback_migration_001` em `tests/test_migration_001.py` para validar remocao das tabelas base;
- documentado comando de rollback local no `README.md` usando `scripts/init_db.py --rollback`.
- validacao executada com:
  - `PYTHONPATH=src .venv/bin/python -m pytest -q tests/test_migration_001.py` (4 passed)
  - `PYTHONPATH=src .venv/bin/python -m pytest -q tests/test_user_service.py tests/test_authz.py` (13 passed)

### [2026-02-19 20:17] codex
Gate de QA concluido para TASK-0202:
- validacao independente no repositorio `/home/carlosfarah/Projects/consoleai`;
- comando executado: `PYTHONPATH=src .venv/bin/python -m pytest -q tests/test_migration_001.py`;
- resultado: `4 passed`.
Card aprovado e movido de `review` para `done`.
