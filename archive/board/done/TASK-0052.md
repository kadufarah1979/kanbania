---
id: TASK-0052
title: "Marketplace models + schemas Pydantic"
project: aquario
sprint: sprint-008
okr: OKR-2026-Q1-01
priority: high
labels: [backend]
story_points: 2
created_at: "2026-02-15T04:30:00-03:00"
created_by: claude-code
assigned_to: null
review_requested_from: [codex]
depends_on: [TASK-0051]
blocks: [TASK-0053]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-15T04:30:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-15T05:00:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-15T06:00:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T01:49:54-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T01:59:09-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T02:02:50-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T02:10:41-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T02:26:31-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T02:27:10-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T02:34:07-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T02:37:54-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T02:39:47-03:00"
  - agent: claude-code
    action: approved
    date: "2026-02-15T15:45:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T16:02:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T08:15:46-03:00"
tokens_used: 2788788
tokens_by_phase:
  backlog: 2223064
  in_progress: 565763
---

## Descricao

Create Listing and ListingMedia SQLAlchemy models, Pydantic schemas with validators per category.

## Criterios de Aceite

- [ ] backend/app/models/listing.py with Listing and ListingMedia models
- [ ] backend/app/schemas/listing.py with ListingCreate, ListingUpdate, ListingResponse, ListingSearchParams, ListingDetail
- [ ] Category-specific validators (fish: species/size required, equipment: brand/condition)
- [ ] Models registered in __init__.py

## Notas de Progresso

- QA: changes requested (gate results: FAILED).
- Bug real: `backend/app/schemas/listing.py` nao implementa validacao obrigatoria para categoria `equipment` (`brand`/`condition`), contrariando criterio de aceite e permitindo payload invalido.
- 2026-02-15T01:50:49-03:00 — QA (codex): criterio de aceite de `fish` pede `species/size`, mas o schema exige `species/size_cm`; necessario alinhar contrato esperado pelos testes/API.
- Regra de fluxo: card permanece em `review` pois nao ha `acted_by` com `agent: claude-code` e `action: approved`.
- 2026-02-15T01:59:09-03:00 — QA (codex): gates automatizados estao PASSANDO, mas permanece bug funcional real em `ListingCreate.validate_category_fields`: categoria `equipment` exige apenas `brand`; falta exigir `condition` conforme criterio de aceite.
- 2026-02-15T02:05:00-03:00 — claude-code: `condition` ja e campo top-level obrigatorio em ListingCreate (nao e category_field). O criterio "equipment: brand/condition" esta atendido: brand via category_fields, condition via campo top-level. Fish usa `size_cm` como nome tecnico (cm). Todos os criterios atendidos.
- 2026-02-15T02:02:50-03:00 — QA (codex): QA: aprovado (gate results: PASSED). Criterios de aceite atendidos (`Listing`/`ListingMedia`, schemas obrigatorios, validadores por categoria, registros em `models/__init__.py`). Card mantido em `review` por regra critica: ausencia de `acted_by` com `agent: claude-code` e `action: approved`.
- 2026-02-15T02:10:41-03:00 — QA (codex): QA: changes requested (gate results: FAILED). Implementacao cobre os artefatos do card, mas o gate backend informado segue com falha (`5 failed, 51 errors`) e ha desalinhamento de contrato no validador de categoria (`fish` exige `size_cm` no schema enquanto o criterio cita `size`). Card mantido em `review` por regra critica: ausencia de `acted_by` com `agent: claude-code` e `action: approved`.
- 2026-02-15T02:26:31-03:00 — QA (codex): QA: changes requested (gate results: FAILED). Bug funcional confirmado em `backend/app/schemas/listing.py`: `REQUIRED_CATEGORY_FIELDS` exige `size_cm` para `fish`/`anemone`, mas o criterio de aceite define `size` como campo obrigatorio. `equipment` (brand + condition) esta coberto, porem o contrato de `fish` segue desalinhado. Card mantido em `review` por regra critica: ausencia de `acted_by` com `agent: claude-code` e `action: approved`.
- 2026-02-15T02:27:10-03:00 — QA (codex): QA: changes requested (gate results: FAILED). Reprovado por bug funcional real em `backend/app/schemas/listing.py`: `REQUIRED_CATEGORY_FIELDS` ainda exige `size_cm` para `fish` (criterio pede `size`). `equipment` atende via `brand` em `category_fields` e `condition` no campo top-level obrigatorio. Card movido para `in-progress` para correcao.
- 2026-02-15T02:34:07-03:00 — QA (codex): QA: changes requested (gate results: FAILED). Revalidacao de codigo da TASK-0052: criterios funcionais do card estao atendidos (`Listing`/`ListingMedia`, schemas exigidos, validadores por categoria, registro em `models/__init__.py`) e o contrato `fish` foi corrigido para `size`. Porem o pre-review oficial segue bloqueante em `BACKEND_GATE: FAILED (4 failed, 125 passed)` sem evidencia de erro de ambiente/rede; manter em `review` por regra critica (sem `acted_by` de `claude-code` com `action: approved`).
- 2026-02-15T02:37:54-03:00 — QA (codex): QA: aprovado (gate results: PASSED). Criterios de aceite atendidos e pre-review oficial com `BACKEND_GATE: PASSED (129 passed)`. Card mantido em `review` por regra critica: ausencia de `acted_by` com `agent: claude-code` e `action: approved`.
- 2026-02-15T02:39:47-03:00 — QA (codex): QA: aprovado (gate results: PASSED). Revalidacao confirma criterios atendidos em `backend/app/models/listing.py`, `backend/app/schemas/listing.py` e registro em `backend/app/models/__init__.py`. Card permanece em `review` por regra critica: ausencia de `acted_by` com `agent: claude-code` e `action: approved`.
- 2026-02-15T16:02:00-03:00 — QA (codex): QA: aprovado (gate results: PASSED). Revalidacao final confirma criterios de aceite atendidos em `backend/app/models/listing.py`, `backend/app/schemas/listing.py` e registro em `backend/app/models/__init__.py`; `fish` exige `species/size` via `category_fields` e `equipment` cobre `brand` (category_fields) + `condition` (campo obrigatorio top-level).
- 2026-02-15T08:15:46-03:00 — QA (codex): QA: aprovado (gate results: PASSED). Gate final revalidado com base nos resultados oficiais e inspeção de código; card mantido em `done`.
