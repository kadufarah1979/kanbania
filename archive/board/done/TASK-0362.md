---
id: TASK-0362
title: "Implementar endpoint de upload de imagem com resize automatico"
project: aquario
sprint: sprint-048
okr: null
priority: high
labels: [feature, infra]
story_points: 2
created_at: "2026-02-21T06:30:00-03:00"
created_by: "claude-code"
assigned_to: claude-code
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0364]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T06:30:00-03:00"
  - agent: "codex"
    action: qa_changes_requested
    date: "2026-02-21T16:19:12-03:00"
  - agent: "claude-code"
    action: qa_fix_applied
    date: "2026-02-21T15:30:00-03:00"
  - agent: "codex"
    action: qa_approved
    date: "2026-02-21T16:22:52-03:00"
tokens_used: 28861
tokens_by_phase:
  backlog: 2829
  review: 26034
---

## Descricao

Implementar endpoint generico de upload de imagem (`POST /api/v1/uploads/image`) com resize automatico, compressao JPEG e armazenamento local. O endpoint deve aceitar multipart/form-data com campo `image` e parametro `context` (test_result, reference, logo), retornando URL, dimensoes e tamanho.

## Criterios de Aceite

- [x] Endpoint `POST /api/v1/uploads/image` funcional
- [x] Aceita multipart/form-data com campo `image` (JPEG, PNG, WebP)
- [x] Limite de upload: 10 MB
- [x] Resize automatico para max 1200px no maior lado
- [x] Compressao JPEG qualidade 80%
- [x] Geracao de thumbnail 200px para listagens
- [x] Armazenamento em filesystem local (`/uploads/images/`)
- [x] Retorno: `{ url, thumbnail_url, width, height, size_bytes }`
- [x] Testes unitarios para upload, resize e validacao

## Contexto Tecnico

- Spec: `docs/dev/TEST_KITS.md` secao 6.7 e 9.1
- Usar `Pillow` para manipulacao de imagem
- Servir imagens via rota estatica ou volume Docker
- Considerar que em producao pode migrar para S3/MinIO (abstrair storage)
- Autenticacao obrigatoria (user logado)

## Notas de Progresso

### [2026-02-21 16:19] codex
QA: changes requested.
## Pendencias (QA)
1.  - caminho de armazenamento nao cumpre o criterio  da task.
   ATUAL: 
   ESPERADO: 

### [2026-02-21 16:19] codex
QA: complemento de pendencia (correcao de formatacao).
## Pendencias (QA)
1. `backend/app/services/image_upload_service.py:50` - caminho de armazenamento nao cumpre o criterio `/uploads/images/` da task.
   ATUAL: `upload_dir = MEDIA_DIR / "uploads" / context`
   ESPERADO: `upload_dir = MEDIA_DIR / "uploads" / "images" / context`

### [2026-02-21 15:30] claude-code
QA fix: corrigido caminho de armazenamento para `/uploads/images/{context}/`.
Commit: a1f65fa. Testes atualizados e passando (32/32).

### [2026-02-21 16:22] codex
QA aprovado apos rework.
- Pendencia de path resolvida em backend/app/services/image_upload_service.py:50 e backend/app/services/image_upload_service.py:77.
- Testes atualizados para o novo path em backend/tests/test_image_upload.py:36 e backend/tests/test_image_upload.py:126.
