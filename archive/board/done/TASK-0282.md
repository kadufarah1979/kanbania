---
id: TASK-0282
title: "Enriquecer backend TPA: marcas de sal, fonte de agua, params antes/depois"
project: aquario
sprint: sprint-037
okr: null
priority: high
labels: [feature]
story_points: 5
created_at: "2026-02-20T23:30:00-03:00"
created_by: claude-code
assigned_to: claude-code
review_requested_from: []
depends_on: []
blocks: [TASK-0283]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-20T23:30:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-20T23:35:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-21T00:10:00-03:00"
  - agent: codex
    action: move
    date: "2026-02-20T21:24:16-03:00"
tokens_used: 724830
tokens_by_phase:
  in_progress: 359854
---

## Descricao

Enriquecer o modelo e API de TPA (water_changes) com campos adicionais conforme spec MAINTENANCE_AND_ROUTINES.md: marcas de sal pre-cadastradas (seed), fonte de agua (RODI, torneira tratada, etc.), parametros antes/depois como JSONB snapshots, atividades extras (sifonagem, limpeza vidro), e calculo automatico de percentual baseado no volume do aquario.

## Criterios de Aceite

- [x] Migration adiciona campos ao modelo water_changes: salt_brand, salt_batch, target_salinity, water_source, source_tds, params_before (JSONB), params_after (JSONB), siphoned_substrate (bool), cleaned_glass (bool), next_scheduled (date), volume_percent (calculado)
- [x] Seed de marcas de sal pre-cadastradas (10 marcas conforme spec)
- [x] API POST /water-changes calcula volume_percent automaticamente com base no volume_liters do aquario
- [x] API GET /water-changes retorna campos enriquecidos
- [x] Endpoint GET /water-changes/summary retorna frequencia media, volume medio e impacto em parametros
- [x] Testes unitarios cobrindo novos campos e calculo de percentual

## Contexto Tecnico

- Modelo existente: `backend/app/models/water_change.py`
- API existente: `backend/app/api/v1/maintenance.py`
- Spec de referencia: `docs/dev/MAINTENANCE_AND_ROUTINES.md` secao 2
- Marcas de sal: tabela inline no modelo ou JSONB constante (nao precisa tabela separada para MVP)
- volume_percent = (volume_liters / aquarium.volume_liters) * 100

## Notas de Progresso

### [2026-02-21 00:10] claude-code
Implementacao concluida. O modelo ja possuia a maioria dos campos da spec; adicionado `salt_batch` via migration. Principais entregas:
- Migration `891079bc6178` adiciona coluna `salt_batch` (VARCHAR 100)
- Service calcula `volume_percent` automaticamente a partir do volume do aquario (usa `total_volume_liters` se disponivel, senao `volume_liters`)
- Recalculo de `volume_percent` no update quando `volume_liters` muda
- Endpoint `GET /water-changes/summary` retorna: total, media volume/percentual, intervalo medio entre TPAs, marca de sal mais usada, ultima TPA, proxima agendada
- Endpoint `GET /salt-brands` com 10 marcas pre-cadastradas (Red Sea, Tropic Marin, Instant Ocean, etc.)
- Schema `WaterChangeUpdate` expandido para permitir edicao de todos os campos
- 16 testes de integracao passando (8 novos + 8 existentes)
- Commit: `0964dca`
