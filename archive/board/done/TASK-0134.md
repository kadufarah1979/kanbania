---
id: TASK-0134
title: "Corrigir atualizacao dinamica do frontend do kanban"
project: kanbania
sprint: sprint-016
okr: null
priority: high
labels: [bug, frontend]
story_points: 3
created_at: "2026-02-16T11:37:03-03:00"
created_by: "codex"
assigned_to: null
review_requested_from: [kadufarah]
depends_on: []
blocks: []
acted_by:
  - agent: codex
    action: created
    date: "2026-02-16T11:37:03-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-16T11:37:33-03:00"
  - agent: codex
    action: update
    date: "2026-02-16T11:39:26-03:00"
  - agent: codex
    action: review_requested
    date: "2026-02-16T11:39:26-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-16T12:44:09-03:00"
  - agent: codex
    action: update
    date: "2026-02-16T12:44:52-03:00"
  - agent: codex
    action: review_requested
    date: "2026-02-16T12:44:52-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-16T12:47:22-03:00"
  - agent: codex
    action: update
    date: "2026-02-16T12:47:43-03:00"
  - agent: codex
    action: review_requested
    date: "2026-02-16T12:47:43-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-16T12:54:29-03:00"
  - agent: codex
    action: update
    date: "2026-02-16T12:55:23-03:00"
  - agent: codex
    action: review_requested
    date: "2026-02-16T12:55:23-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-16T12:57:40-03:00"
  - agent: codex
    action: update
    date: "2026-02-16T12:58:14-03:00"
  - agent: codex
    action: review_requested
    date: "2026-02-16T12:58:14-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-16T13:05:05-03:00"
  - agent: codex
    action: update
    date: "2026-02-16T13:05:46-03:00"
  - agent: codex
    action: review_requested
    date: "2026-02-16T13:05:46-03:00"
  - agent: codex
    action: complete
    date: "2026-02-16T15:19:17-03:00"
tokens_used: 1157563
tokens_by_phase:
  backlog: 76402
  review: 108038
---

## Descricao

Investigar e corrigir o problema em que o dashboard frontend do kanban nao reflete alteracoes de forma dinamica.

## Criterios de Aceite

- [x] Alteracoes em tarefas/board aparecem sem precisar refresh manual
- [x] Atualizacao de sprint e activity feed reflete mudancas recentes
- [x] Solucao documentada em notas de progresso

## Contexto Tecnico

- App: `dashboard/` (Next.js)
- Hooks de dados em `dashboard/src/lib/hooks/`
- Possivel dependencia de websocket/polling e invalidacao de cache

## Notas de Progresso

### [2026-02-16 11:39] codex
Corrigido fluxo de atualizacao dinamica no dashboard: ajuste do hook websocket para URL fallback baseada no hostname atual (nao fixa em localhost), reconexao segura sem loop apos unmount, e callback via ref para evitar stale handler. Hooks de dados (`useBoard`, `useActivity`, `useStats`, `useSprint`, `useProjects`, `useAgents`) passaram a usar `fetch(..., { cache: "no-store" })` para impedir cache no browser durante refetch por evento WS. Tambem corrigido efeito colateral no `KanbanBoard` trocando `useState` indevido por `useEffect` ao propagar status de conexao.

### [2026-02-16 12:44] codex
Aplicada correcao adicional para conectividade websocket em acesso remoto: o hook agora tenta multiplas URLs candidatas com failover e ignora `NEXT_PUBLIC_WS_URL` local (`ws://localhost`) quando o dashboard esta aberto fora do host local. Isso evita conexao quebrada no browser remoto e restaura atualizacao dinamica sem F5.

### [2026-02-16 12:47] codex
Ajustada configuracao local para nao forcar endpoint websocket em localhost no cliente: `dashboard/.env.local` deixou `NEXT_PUBLIC_WS_URL` comentado com orientacao de uso opcional. Com isso, o hook usa autodeteccao por hostname e evita necessidade de F5 em acesso remoto.

### [2026-02-16 12:55] codex
Corrigido stale de status em \"Agentes em tempo real\": a API `/api/agents/status` deixou de depender somente de `agents/*.status.json` e agora deriva estado atual a partir das tasks no board (`in-progress` e `review_requested_from`) com fallback para arquivos `.status.json`. A barra de agentes tambem passou a refetchar em eventos websocket de `board` e `logs`, alem de `agents`.

### [2026-02-16 12:58] codex
Investigacao de ambiente mostrou conflito de porta websocket (`8766`) ocupada por `docker-proxy`, potencialmente desviando a conexao WS para outro servico. Implementado fallback de polling a cada 3s em `useBoard` e `useAgents` para garantir atualizacao sem F5 mesmo com websocket indisponivel ou incorreto.

### [2026-02-16 13:05] codex
Aplicada troca da porta websocket padrao para `8788` no servidor (`dashboard/server.ts`) e no cliente (`dashboard/src/lib/hooks/use-websocket.ts`) para evitar conflito com `8766` ocupado por container externo. Mantido fallback de polling ativo.
