---
id: TASK-0188
title: "Backend: notification dispatcher + push endpoint"
project: aquario
sprint: sprint-024
okr: OKR-2026-Q1-01
priority: high
labels: [backend, notifications, api]
story_points: 5
created_at: "2026-02-18T14:00:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: []
depends_on: []
blocks: [TASK-0187, TASK-0189]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-18T14:00:00-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-18T10:33:43-03:00"
  - agent: codex
    action: completed
    date: "2026-02-18T10:38:59-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-18T12:49:50-03:00"
tokens_used: 2897867
tokens_by_phase:
  in_progress: 1162677
---

## Descricao

Implementar no backend o dispatcher de notificacoes com suporte a Web Push (VAPID). Inclui model PushSubscription, endpoints para registrar/remover subscriptions, e servico dispatcher que envia push quando alerta dispara.

## Criterios de Aceite

- [x] Model PushSubscription com migration
- [x] POST /push-subscriptions para registrar
- [x] DELETE /push-subscriptions/{id} para remover
- [x] Servico NotificationDispatcher com metodo send_push
- [x] Testes unitarios do dispatcher

## Contexto Tecnico

Backend: `/home/carlosfarah/Projects/aquario/backend/`

Stack: FastAPI, SQLAlchemy 2.0 (async), aiomqtt

Implementar:
1. Model em `backend/app/models/push_subscription.py`
   - Fields: user_id, endpoint, p256dh, auth, created_at
   - Unico por (user_id, endpoint)

2. Schema em `backend/app/schemas/notification.py` (novo)
   - PushSubscriptionCreate
   - PushSubscriptionResponse

3. Service em `backend/app/services/notification_service.py` (novo)
   - NotificationDispatcher com metodo send_push(subscriptions, title, body, data)
   - Usar biblioteca `pywebpush` ou `py-vapid`
   - Configurar VAPID private/public keys (env vars)

4. Endpoints em `backend/app/api/v1/notifications.py` (novo)
   - POST /push-subscriptions
   - DELETE /push-subscriptions/{id}

5. Tests em `backend/tests/test_notification_service.py` (novo)
   - Teste unitario do dispatcher

## Notas de Progresso

### [2026-02-18 14:00] claude-code
Card criado para implementacao de notification dispatcher backend.

### [2026-02-18 10:38] codex
Implementacao concluida: model + migration de push_subscriptions, schemas, endpoints POST/DELETE, NotificationDispatcher (VAPID/pywebpush) e integracao no fluxo de alertas para notify_push.

### [2026-02-18 10:38] codex
Testes adicionados em `backend/tests/test_notification_service.py` para dispatcher e endpoints de push subscription. Validacao de sintaxe feita com AST; execucao de pytest nao foi possivel no ambiente atual (pytest indisponivel).

### [2026-02-18 10:47] codex
Revalidacao executada em container local (`docker compose exec -T backend`): `tests/test_notification_service.py` (12 passed) e `tests/test_notification_e2e.py` (14 passed). Tentativa de instalacao direta do pytest na `.venv` da sessao falhou por DNS sem resolucao para indice de pacotes.

### [2026-02-18 12:49] codex
QA: aprovado. Criterios de aceite verificados no card e evidencias de implementacao/validacao registradas.
