---
id: TASK-0442
title: "[CI/CD] Corrigir erro de migration no pipeline (#25524)"
project: aquario
sprint: sprint-057
okr: null
priority: critical
labels: [cicd-fix, automated]
story_points: 3
created_at: "2026-02-22T20:50:01-03:00"
created_by: cicd-webhook
assigned_to: claude-code
review_requested_from: []
depends_on: []
blocks: []
cicd_pipeline_id: 25524
cicd_pipeline_url: "http://git.lab.tectoylabs.com.br/carlos.farah/aquabook/-/pipelines/25524"
cicd_commit_sha: "94bff8b0"
cicd_error_category: "migration_error"
acted_by:
  - agent: cicd-webhook
    action: created
    date: "2026-02-22T20:50:01-03:00"
  - agent: cicd-webhook
    action: claimed
    date: "2026-02-22T20:50:01-03:00"
  - agent: claude-code
    action: complete
    date: "2026-02-22T20:55:00-03:00"
  - agent: claude-code
    action: review_requested
    date: "2026-02-22T20:55:00-03:00"
  - agent: proprietario
    action: approved
    date: "2026-02-22T21:00:00-03:00"
---

## Descricao

O pipeline CI/CD do projeto aquario falhou. O agente deve analisar o erro, corrigir o codigo e fazer push para main.

- **Pipeline**: [#25524](http://git.lab.tectoylabs.com.br/carlos.farah/aquabook/-/pipelines/25524)
- **Job**: deploy-production
- **Categoria**: migration_error
- **Commit**: `94bff8b0`

## Erro Detectado

```
2026-02-22T22:40:40.949418Z 01E ERROR [alembic.util.messaging] Multiple head revisions are present for given argument 'head'; please specify a specific target revision, '<branchname>@head' to narrow t
```


## Log de Erro (contexto)

```
2026-02-22T22:40:32.279931Z 01O $ mkdir -p ~/.ssh
2026-02-22T22:40:32.281187Z 01O $ echo "$DEPLOY_SSH_KEY" | base64 -d > ~/.ssh/id_ed25519
2026-02-22T22:40:32.282407Z 01O $ chmod 600 ~/.ssh/id_ed25519
2026-02-22T22:40:32.283102Z 01O $ ssh-keyscan -p 22 $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null
2026-02-22T22:40:32.998459Z 01O $ chmod +x infrastructure/scripts/deploy.sh
2026-02-22T22:40:32.999324Z 01O $ bash infrastructure/scripts/deploy.sh
2026-02-22T22:40:33.002793Z 01O >>> Deploying to [MASKED]...
2026-02-22T22:40:35.364309Z 01O Login Succeeded
2026-02-22T22:40:35.374027Z 01O >>> Pulling latest images...
2026-02-22T22:40:35.612111Z 01E  Image [MASKED]/aquario-frontend:latest Pulling 
2026-02-22T22:40:35.612131Z 01E  Image [MASKED]/aquario-backend:latest Pulling 
2026-02-22T22:40:36.150599Z 01E  Image [MASKED]/aquario-backend:latest Pulled 
2026-02-22T22:40:36.250617Z 01E  Image [MASKED]/aquario-frontend:latest Pulled 
2026-02-22T22:40:36.396361Z 01O >>> Starting updated containers...
2026-02-22T22:40:36.588751Z 01E  Container aquario-frontend-1 Recreate 
2026-02-22T22:40:36.588764Z 01E  Container aquario-backend-1 Recreate 
2026-02-22T22:40:37.085676Z 01E  Container aquario-frontend-1 Recreated 
2026-02-22T22:40:37.782699Z 01E  Container aquario-backend-1 Recreated 
2026-02-22T22:40:37.813294Z 01E  Container aquario-frontend-1 Starting 
2026-02-22T22:40:37.813370Z 01E  Container aquario-backend-1 Starting 
2026-02-22T22:40:38.115993Z 01E  Container aquario-backend-1 Started 
2026-02-22T22:40:38.184006Z 01O >>> Running database migrations...
2026-02-22T22:40:38.184112Z 01E  Container aquario-frontend-1 Started 
2026-02-22T22:40:40.550108Z 01E INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
2026-02-22T22:40:40.550131Z 01E INFO  [alembic.runtime.migration] Will assume transactional DDL.
2026-02-22T22:40:40.949418Z 01E ERROR [alembic.util.messaging] Multiple head revisions are present for given argument 'head'; please specify a specific target revision, '<branchname>@head' to narrow to a specific head, or 'heads' for all heads
2026-02-22T22:40:40.949952Z 01O FAILED: Multiple head revisions are present for given argument 'head'; please specify a specific target revision, '<branchname>@head' to narrow to a specific head, or 'heads' for all heads
2026-02-22T22:40:41.690123Z 00O section_end:1771800041:step_script
2026-02-22T22:40:41.690134Z 00O+section_start:1771800041:after_script
2026-02-22T22:40:41.690501Z 00O+Running after_script
2026-02-22T22:40:41.998479Z 01O Running after script...
2026-02-22T22:40:41.998522Z 01O $ if [ "$CI_JOB_STATUS" = "success" ]; then # collapsed multi-line command
2026-02-22T22:40:41.998525Z 01O Deploy FAILED - aquabook (94bff8b0) - http://git.lab.tectoylabs.com.br/carlos.farah/aquabook/-/pipelines/25524
2026-02-22T22:40:42.193241Z 00O section_end:1771800042:after_script
2026-02-22T22:40:42.193259Z 00O+section_start:1771800042:cleanup_file_variables
2026-02-22T22:40:42.194392Z 00O+Cleaning up project directory and file based variables
2026-02-22T22:40:42.850234Z 00O section_end:1771800042:cleanup_file_variables
2026-02-22T22:40:42.850249Z 00O+
2026-02-22T22:40:43.285844Z 00O ERROR: Job failed: exit code 255
```


## Criterios de Aceite

- [x] Causa raiz identificada
- [x] Correcao implementada e commitada em main
- [ ] Pipeline re-executado com sucesso (automatico apos aprovacao codex)

## Notas de Progresso

### [2026-02-22 20:55] claude-code
Causa: duas migrations (`l5m6n7o8p9q0` seed_default_badges e `m6n7o8p9q0r1` add_showcase_badge_ids) com mesmo `down_revision` (`k4l5m6n7o8p9`), criando heads paralelas.
Fix: `m6n7o8p9q0r1.down_revision` alterado para `l5m6n7o8p9q0` (cadeia linear).
Commit `11e03b9` pushado em main no aquario. Pipeline disparado automaticamente.

- 2026-02-22 (QA codex): Reprovado. Revisao obrigatoria deve ocorrer na branch `task/TASK-0442` do projeto (`/home/carlosfarah/Projects/aquario`), mas a branch nao existe (apenas `main`).
- 2026-02-22 (QA codex): Reprovado. Criterio de aceite final permanece pendente no card: `Pipeline re-executado com sucesso` esta desmarcado (`[ ]`). Pendencia: anexar evidencia objetiva do pipeline #25524 (ou novo pipeline) concluido com sucesso e reenviar para review.
