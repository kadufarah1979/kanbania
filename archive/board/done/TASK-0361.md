---
id: TASK-0361
title: "Criar model test_kit_analyses, migration e schemas Pydantic"
project: aquario
sprint: sprint-048
okr: null
priority: high
labels: [feature]
story_points: 2
created_at: "2026-02-21T06:30:00-03:00"
created_by: "claude-code"
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0364]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T06:30:00-03:00"
  - agent: "claude-code"
    action: claim
    date: "2026-02-21T17:30:00-03:00"
  - agent: "claude-code"
    action: move
    date: "2026-02-21T17:35:00-03:00"
  - agent: "codex"
    action: qa_approved
    date: "2026-02-21T15:53:21-03:00"
tokens_used: 69541
tokens_by_phase:
  backlog: 2829
  review: 66714
---

## Descricao

Criar o model SQLAlchemy `TestKitAnalysis`, migration Alembic e schemas Pydantic para a tabela `test_kit_analyses` conforme spec `docs/dev/TEST_KITS.md` secao 2.1. Esta tabela registra cada analise de foto feita pelo usuario, incluindo metodo de analise, cor detectada, valor sugerido, confianca e valor final confirmado.

## Criterios de Aceite

- [x] Model `TestKitAnalysis` criado com todos os campos da spec (tenant_id, aquarium_id, test_kit_id, user_id, image_url, analysis_method, detected_color_hex, detected_lab_*, matched_scale_id, suggested_value, confidence, final_value, user_adjusted, reading_id, ai_response, processing_ms, notes)
- [x] Migration Alembic criada e rodando com sucesso
- [x] Schemas Pydantic: `TestKitAnalysisCreate`, `TestKitAnalysisResponse`, `TestKitAnalysisConfirm`
- [x] Model registrado em `backend/app/models/__init__.py`
- [x] Multi-tenant isolation (tenant_id obrigatorio)

## Contexto Tecnico

- Spec: `docs/dev/TEST_KITS.md` secao 2.1 (tabela test_kit_analyses)
- Padrao de model: seguir `backend/app/models/test_kit.py`
- Padrao de schema: seguir `backend/app/schemas/test_kit.py`
- FK para test_kits(id) e test_kit_color_scales(id)
- Campo reading_id sera preenchido apos confirmacao (nullable)

## Notas de Progresso

### [2026-02-21 17:35] claude-code
Implementacao concluida:
- Model `TestKitAnalysis` em `backend/app/models/test_kit.py` com todos os campos da spec
- Migration `d737a9d7bc12` criada e rodada com sucesso
- Schemas `TestKitAnalysisCreate`, `TestKitAnalysisConfirm`, `TestKitAnalysisResponse` em `backend/app/schemas/test_kit.py`
- Model registrado em `__init__.py`
- Indices: aquarium_id, user_id, test_kit_id, tenant_id
- FK para test_kits(id) CASCADE e test_kit_color_scales(id) SET NULL
- reading_id sem FK declarativa (hypertable TimescaleDB)
- Testes: 471 passed, 1 failed (pre-existente em test_google_auth.py, nao relacionado)

### [2026-02-21 15:53] codex
QA aprovado.
- Criterios de aceite validados por inspecao de codigo em , ,  e .
- Tentativas de execucao local de / falharam por ambiente (resolucao do host  e configuracao de driver), sem evidencia de defeito funcional na implementacao da task.

### [2026-02-21 15:54] codex
Correcao de registro de QA (ajuste de formatacao da nota anterior):
- Criterios de aceite validados por inspecao de codigo em backend/app/models/test_kit.py, backend/alembic/versions/d737a9d7bc12_.py, backend/app/schemas/test_kit.py e backend/app/models/__init__.py.
- Tentativas de execucao local de pytest e alembic falharam por ambiente (resolucao do host postgres e configuracao de driver), sem evidencia de defeito funcional na implementacao da task.
