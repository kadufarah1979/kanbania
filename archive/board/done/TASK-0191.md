---
id: TASK-0191
title: "Backend: notificacoes in-app (model + CRUD + WS)"
project: aquario
sprint: sprint-025
okr: OKR-2026-Q1-01
priority: high
labels: [backend, notifications]
story_points: 5
created_at: "2026-02-18T18:00:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0192]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-18T18:00:00-03:00"
  - agent: codex
    action: update
    date: "2026-02-18T16:54:22-03:00"
  - agent: codex
    action: complete
    date: "2026-02-18T17:37:55-03:00"
tokens_used: 184400
tokens_by_phase:
  in_progress: 184402
---

## Descricao

Implementar modelo InAppNotification, servico CRUD, endpoints REST e broadcast via WebSocket para notificacoes in-app. Conforme documentado em docs/dev/NOTIFICACOES.md secao "Notificacoes In-App".

## Criterios de Aceite

- [x] Model InAppNotification criado (id, user_id, event_type, title, body, url, is_read, created_at)
- [x] Migration Alembic gerada e aplicavel
- [x] Endpoints: GET /notifications/in-app (paginado), GET /notifications/in-app/unread-count, PUT /notifications/in-app/{id}/read, PUT /notifications/in-app/read-all
- [x] Servico cria notificacao in-app automaticamente ao despachar alerta
- [x] Broadcast de nova notificacao via WebSocket (tipo "notification")
- [x] Testes unitarios para servico e endpoints (9 testes passando)

## Contexto Tecnico

Backend: `/home/carlosfarah/Projects/aquario/backend/`
Doc de referencia: `docs/dev/NOTIFICACOES.md` secoes "Notificacoes In-App" e "Backend -- Endpoints"

Schema SQL de referencia (do doc):
- in_app_notifications (id, user_id, event_type, title, body, url, is_read, created_at)
- Indices: idx_in_app_notif_user (user_id, is_read, created_at DESC)

Integrar com notification_service.py existente â€” ao final de dispatch_alert_notification, criar registro in-app.

## Notas de Progresso

### [2026-02-18 18:00] claude-code
Card criado para backend de notificacoes in-app.

### [2026-02-18 19:00] claude-code
Implementacao completa. Commit c3c6024. Arquivos:
- `backend/app/models/in_app_notification.py`: Model InAppNotification com campos id, user_id, event_type, title, body, url, is_read, created_at. Index composto (user_id, is_read, created_at).
- `backend/app/models/user.py`: Adicionada relationship in_app_notifications
- `backend/app/models/__init__.py`: Export do novo model
- `backend/alembic/versions/abba4012d7db_add_in_app_notifications.py`: Migration criada e aplicada
- `backend/app/schemas/notification.py`: InAppNotificationResponse, InAppNotificationList, UnreadCountResponse
- `backend/app/services/notification_service.py`: Funcoes create, get_paginated, get_unread_count, mark_read, mark_all_read. dispatch_alert_notification agora cria notificacao in-app automaticamente e faz broadcast WS.
- `backend/app/api/v1/notifications.py`: GET /in-app, GET /in-app/unread-count, PUT /in-app/{id}/read, PUT /in-app/read-all
- `backend/app/ws/hub.py`: Novo metodo broadcast_to_user para envio por user_id
- `backend/tests/test_in_app_notifications.py`: 9 testes unitarios
Total: 356 testes passando.

### [2026-02-18 16:54] codex
QA reprovado e retornado para in-progress. Motivo: inconsistencia entre criterio de aceite e contrato implementado de endpoints (`/notifications/...` no card vs `/notifications/in-app/...` no codigo). Ajustar criterios/documentacao para refletir contrato final e anexar evidencia objetiva de validacao dos testes do card no ambiente atual.

### [2026-02-18 23:40] claude-code
Corrigido: criterios de aceite atualizados para refletir endpoints reais com prefixo `/in-app/`. Evidencia: 9 testes em `test_in_app_notifications.py` passando. Total: 364 testes backend passando.

### [2026-02-18 17:37] codex
QA aprovado para fechamento apos correcoes no card. Criterios e contrato de endpoint agora coerentes (`/notifications/in-app/...`) com evidencia registrada no proprio card.
