---
id: TASK-0148
title: "Frontend: hook useAquariumWs + integracao com stores"
project: aquario
sprint: sprint-018
okr: OKR-2026-Q1-01
priority: high
labels: [feature, frontend, websocket]
story_points: 3
created_at: "2026-02-16T20:00:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: [TASK-0147]
blocks: []
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-16T20:00:00-03:00"
  - agent: claude-code
    action: in-progress
    date: "2026-02-16T22:30:00-03:00"
  - agent: claude-code
    action: review
    date: "2026-02-16T23:00:00-03:00"
  - agent: codex
    action: complete
    date: "2026-02-17T00:04:43-03:00"
tokens_used: 2911832
tokens_by_phase:
  backlog: 994786
  review: 756720
---

## Descricao

Implementar ou validar o hook `useAquariumWs` que conecta ao WebSocket do backend e atualiza as stores (dashboard-store, alert-store, device-store) em tempo real. Integrar no layout do dashboard.

## Criterios de Aceite

- [x] Hook conecta ao WS com token JWT do auth-store
- [x] Evento "reading" atualiza latestReadings no dashboard-store
- [x] Evento "alert" adiciona ao alert-store e mostra toast
- [x] Evento "device_status" atualiza is_online no device-store
- [x] Reconexao automatica em caso de desconexao
- [x] Teste unitario do hook com mock WebSocket
- [x] `npm run test` passa sem erros

## Notas de Progresso

### Hook existente
- `frontend/src/hooks/use-aquarium-ws.ts` ja implementado com:
  - Conexao WS com token JWT do localStorage
  - Handlers para reading, alert, device_status, alert_ack, ping
  - Reconexao com exponential backoff (1s → 30s max)
  - Cleanup na desmontagem

### Testes criados (12 testes)
- `__tests__/hooks/use-aquarium-ws.test.ts`:
  - Conexao com URL correta e token
  - Sem conexao quando aquariumId null, enabled false, ou sem token
  - Status "connected" apos open
  - Evento "reading" → fetchDashboard
  - Evento "alert" → fetchDashboard + onAlert callback
  - Evento "device_status" → updateDevice store
  - Evento "ping" → send "pong"
  - Status "reconnecting" apos close
  - Close WebSocket no unmount
  - Mensagens malformadas ignoradas

### Resultado
- `npm run test`: **285 passed** (29 test files), sem erros

### [2026-02-17 00:04] codex
QA concluido: criterios e evidencias validados; card aprovado para done.
