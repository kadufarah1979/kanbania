---
id: TASK-0053
title: "Listing service (CRUD + busca + validacao)"
project: aquario
sprint: sprint-008
okr: OKR-2026-Q1-01
priority: high
labels: [backend]
story_points: 3
created_at: "2026-02-15T04:30:00-03:00"
created_by: claude-code
assigned_to: null
review_requested_from: [codex]
depends_on: [TASK-0052]
blocks: [TASK-0054]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-15T04:30:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-15T05:00:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-15T06:00:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T01:50:38-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T01:59:21-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T02:10:51-03:00"
  - agent: claude-code
    action: approved
    date: "2026-02-15T15:00:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T02:26:42-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T02:27:16-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T02:33:51-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T02:37:45-03:00"
tokens_used: 2461330
tokens_by_phase:
  backlog: 2136627
  in_progress: 324738
---

## Descricao

Service layer with CRUD, search with filters, rolling window limit, kit detection.

## Criterios de Aceite

- [ ] backend/app/services/listing_service.py
- [ ] create_listing() with rolling window limit (3/30d for regular users)
- [ ] search_listings() with filters (category, price, location, condition, full-text)
- [ ] get_listing(), update_listing(), delete_listing() (soft delete)
- [ ] get_my_listings() for seller panel
- [ ] Kit detection Layer 1 (keyword blocking)

## Notas de Progresso

- 2026-02-15T01:50:38-03:00 - QA: changes requested (gate results: FAILED). O gate backend retornou `129 errors` (nao classificado como erro de ambiente/rede) e permanece bloqueante. Codigo do `listing_service` cobre os criterios de aceite, mas o card nao foi movido por regra critica: ausencia de `acted_by` com `claude-code approved`.
- 2026-02-15T01:50:53-03:00 - QA: changes requested (code issue). Em `backend/app/api/v1/marketplace.py:135`, a criacao manual de `ListingSearchParams` com `category/condition/sort` recebidos como `str` permite `pydantic.ValidationError` nao tratada para valores invalidos, retornando 500 no endpoint de busca em vez de 422 de validacao.
- 2026-02-15T01:59:21-03:00 - QA: changes requested (gate results: FAILED). Revalidacao de codigo: problema anterior de validacao no endpoint de busca foi corrigido (agora retorna 422 para parametros invalidos), e os criterios funcionais do service estao cobertos; porem o `BACKEND_GATE` segue bloqueante com `129 errors` (nao ambiente/rede). Regra critica aplicada: card mantido em `review` por ausencia de `acted_by` com `claude-code approved`.
- 2026-02-15T02:10:51-03:00 - QA: changes requested (gate results: FAILED). Revisao de codigo confirma cobertura dos criterios do `listing_service` e correcao da validacao no endpoint de busca; entretanto o pre-review permanece bloqueante com `9 failed, 76 passed, 128 errors` no `BACKEND_GATE` (nao ambiente/rede). Regra critica aplicada: card mantido em `review` por ausencia de `acted_by` com `claude-code approved`.
- 2026-02-15T02:26:42-03:00 - QA: changes requested (gate results: FAILED). Revisao funcional confirma cobertura dos criterios de aceite do `listing_service` e tratamento de validacao no endpoint de busca; porem o pre-review continua bloqueante com `10 failed, 113 passed, 12 errors` no `BACKEND_GATE` (nao ambiente/rede). Card retornado para `in-progress` para correcoes.
- 2026-02-15T02:27:16-03:00 - QA: changes requested (gate results: FAILED). Revalidacao final: criterios funcionais do `listing_service` continuam atendidos (CRUD, busca com filtros, janela 3/30d para usuario comum, soft delete, painel do vendedor e bloqueio de kit), sem nova falha funcional evidente no endpoint. Entretanto o pre-review reporta `43 passed, 213 errors` no `BACKEND_GATE` (nao classificado como ambiente/rede), mantendo bloqueio para aprovacao.
- 2026-02-15T02:33:51-03:00 - QA: changes requested (gate results: FAILED). Revisao de codigo confirma que os criterios funcionais de `TASK-0053` permanecem atendidos (`create_listing` com janela 3/30d, `search_listings` com filtros/full-text, `get/update/delete` com soft delete, `get_my_listings` e bloqueio de kit), sem nova regressao evidente no endpoint de busca. Contudo o pre-review atual reporta `129 errors` no `BACKEND_GATE` (nao classificado como erro de ambiente/rede), mantendo bloqueio para aprovacao e retorno para `in-progress`.
- 2026-02-15T02:37:45-03:00 - QA: aprovado (gate results: PASSED). Revisao final de codigo confirma atendimento dos criterios de aceite de `TASK-0053` (`create_listing` com janela 3/30d para usuario comum, `search_listings` com filtros e full-text, `get/update/delete` com soft delete, `get_my_listings` para painel do vendedor e bloqueio de kit). `BACKEND_GATE` reportado como `PASSED (129 passed)`.
