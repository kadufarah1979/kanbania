---
id: TASK-0204
title: "Implementar cadastro e gestão de usuários com associação a tenants"
project: consoleai
sprint: null
okr: null
priority: high
labels: [feature, auth, backend]
story_points: 5
created_at: "2026-02-18T16:53:59-03:00"
created_by: "codex"
assigned_to: codex
review_requested_from: [codex]
depends_on: [TASK-0202]
blocks: [TASK-0205, TASK-0210]
acted_by:
  - agent: "codex"
    action: created
    date: "2026-02-18T16:53:59-03:00"
  - agent: "codex"
    action: update
    date: "2026-02-19T16:07:47-03:00"
  - agent: "codex"
    action: update
    date: "2026-02-19T18:20:59-03:00"
  - agent: "codex"
    action: claim
    date: "2026-02-20T15:55:53-03:00"
  - agent: "codex"
    action: update
    date: "2026-02-20T16:10:11-03:00"
  - agent: "codex"
    action: qa_approved
    date: "2026-02-20T17:20:28-03:00"
tokens_used: 1962198
tokens_by_phase:
  todo: 160046
  review: 180950
---

## Descricao

Implementar fluxo de cadastro e manutenção de usuários com papéis de DevOps, Desenvolvedor e Gestor, incluindo associação explícita dos usuários aos tenants (OUs) autorizados.

## Criterios de Aceite

- [x] CRUD de usuários com validações de perfil e vínculo a tenant
- [x] Usuário sem tenant associado não acessa recursos
- [x] Interface administrativa exibe e permite editar associações usuário-tenant

## Contexto Tecnico

Aproveitar base de autenticação já existente no projeto, expandindo para escopo multi-tenant.

## Notas de Progresso

### [2026-02-18 16:53] codex
Card criado para estruturar onboarding e administração de identidades.

### [2026-02-20 16:10] codex
Validação concluída:
- API com CRUD de usuários e vínculo de tenant (`/api/v1/users`, `/api/v1/users/{email}/tenants/{tenant_id}`)
- Guardrail de acesso por tenant ativo e escopo de usuário
- Interface admin com edição de associações usuário-tenant em `src/auth/admin.py`

Testes executados:
- `.venv/bin/python -m pytest -q tests/unit/test_consoleai_api.py -k "users_endpoints_create_and_list or users_create_duplicate_returns_conflict or users_create_invalid_role_returns_bad_request or users_update_and_delete or assign_tenant_and_list_scope or remove_user_tenant_scope or inventory_forbidden_for_user_without_tenant_scope or inventory_forbidden_for_out_of_scope_tenant"` -> 8 passed
- `.venv/bin/python -m pytest -q tests/unit/test_database.py -k "assign_and_list_user_tenants or user_has_tenant_access_only_when_active"` -> 2 passed

### [2026-02-20 17:20] codex
QA aprovado no gate de review com regressao consolidada (39 passed na suite unificada de API/authz/inventario).
