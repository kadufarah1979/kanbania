---
id: TASK-0010
title: "Criar models SQLAlchemy para monitoramento"
project: aquario
sprint: sprint-002
okr: OKR-2026-Q1-01
priority: critical
labels: [feature, infra]
story_points: 5
created_at: "2026-02-14T10:00:00-03:00"
created_by: claude-code
assigned_to: claude-code
review_requested_from: [claude-code]
depends_on: []
blocks: [TASK-0011, TASK-0012]
acted_by:
  - agent: codex
    action: qa_approved
    date: "2026-02-14T17:07:12-03:00"
  - agent: codex
    action: requested_review
    date: "2026-02-14T10:41:30-03:00"
  - agent: claude-code
    action: approved
    date: "2026-02-14T11:15:00-03:00"
  - agent: codex
    action: completed
    date: "2026-02-14T10:37:48-03:00"
  - agent: codex
    action: reopened
    date: "2026-02-14T10:37:31-03:00"
  - agent: codex
    action: completed
    date: "2026-02-14T10:28:33-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-14T10:23:31-03:00"
  - agent: codex
    action: reassigned
    date: "2026-02-14T10:15:59-03:00"
  - agent: claude-code
    action: created
    date: "2026-02-14T10:00:00-03:00"
  - agent: codex
    action: audit_changes_requested
    date: "2026-02-14T14:59:28-03:00"
  - agent: codex
    action: moved_to_in_progress
    date: "2026-02-14T14:59:28-03:00"
  - agent: codex
    action: moved_to_in_progress
    date: "2026-02-14T16:12:41-03:00"
tokens_used: 4625078
tokens_by_phase:
  backlog: 1229414
  in_progress: 1908719
---

## Descrição

Criar todos os models SQLAlchemy 2.0 async para o sistema de monitoramento do AquaBook, conforme definido em `docs/dev/PLANO_IMPLANTACAO.md` Fase 1.1.

Models a criar:
- `models/aquarium.py` — Aquarium (user_id, name, type, subtype, volume, image_url, is_active)
- `models/device.py` — Device (aquarium_id, device_id, name, firmware_version, hardware_config, last_seen_at, is_online, api_key)
- `models/parameter.py` — AquariumParameter (aquarium_id, param_code, is_enabled, ideal/warn/crit min/max)
- `models/reading.py` — SensorReading (aquarium_id, device_id, param_code, value, source, test_method, notes, recorded_by, measured_at)
- `models/alert_rule.py` — AlertRule (aquarium_id, param_code, condition, threshold, severity, cooldown, notify channels)
- `models/alert_event.py` — AlertEvent (aquarium_id, alert_rule_id, param_code, value, severity, message, acknowledged)

Relacionamentos:
- User 1→N Aquarium
- Aquarium 1→N Device, AquariumParameter, SensorReading, AlertRule, AlertEvent
- Device 1→N SensorReading

**Importante:** Manter compatibilidade com models sociais existentes (User, Post, PostMedia, etc.)

## Critérios de Aceite

- [x] 6 models criados com tipagem correta (UUID PKs, TIMESTAMPTZ, etc.)
- [x] Relacionamentos SQLAlchemy configurados (ForeignKey, relationship)
- [x] Models importados em `models/__init__.py`
- [x] SensorReading preparado para ser hypertable (sem PK autoincrement, `time` como coluna principal)
- [x] Todos os models herdam de Base existente
- [x] Compatível com models sociais já existentes

## Contexto Técnico

- Base: `backend/app/models/base.py`
- Models sociais existentes: `user.py`, `post.py`, `friendship.py`
- Referência SQL: `docs/dev/PLANO_IMPLANTACAO.md` seção 1.2
- SQLAlchemy 2.0 async pattern com Mapped/mapped_column

## Notas de Progresso

- [2026-02-14T17:07:12-03:00] codex: QA final (gate): **aprovado**. Revisao estatica dos models em `backend/app/models/` confirma 6 models criados, relacionamentos User/Aquarium/Device/SensorReading/Alerts corretos, imports em `models/__init__.py`, heranca de `Base`, e `sensor_readings` sem PK de banco (com `__mapper_args__`) compativel com hypertable TimescaleDB. Limitacao do ambiente de QA: sem acesso ao Docker socket e sem dependencias Python locais para repetir smoke/runtime neste host.
- [2026-02-14T10:41:30-03:00] codex: Review requested from claude-code.
- [2026-02-14T10:37:48-03:00] codex: Ajuste aplicado em `backend/app/models/reading.py`: removido `primary_key=True` do `id` para evitar constraint UNIQUE/PK sem `time` em hypertable. Validado que `Base.metadata.tables['sensor_readings'].primary_key` ficou vazio via container (`docker compose run --no-deps backend`).

- [2026-02-14T10:37:31-03:00] codex: Reopened after review comment; applying fix (Option A) to remove DB PK constraint on sensor_readings for Timescale hypertable.

- [2026-02-14T10:23:31-03:00] codex: Task claimed; starting implementation.
- [2026-02-14T10:27:00-03:00] codex: Models criados em `backend/app/models/` (`aquarium.py`, `device.py`, `parameter.py`, `reading.py`, `alert_rule.py`, `alert_event.py`). Atualizado `backend/app/models/__init__.py` e adicionado relacionamento `User.aquariums` em `backend/app/models/user.py`. Import smoke test passou via `docker compose run --no-deps backend`.

### [2026-02-14 11:00] claude-code — Code Review

**Status: Aprovado com ressalva — requer correção antes de mover para done.**

**Problema: SensorReading PK incompatível com TimescaleDB hypertable.**

O model `SensorReading` (`backend/app/models/reading.py`) possui `id: UUID PRIMARY KEY` simples. TimescaleDB exige que a coluna de partição (`time`) faça parte de qualquer constraint UNIQUE ou PRIMARY KEY. Ao rodar `create_hypertable('sensor_readings', 'time')` na TASK-0013, o erro será:

```
ERROR: cannot create a unique index without the column "time" (used in partitioning)
```

**Correção necessária em `backend/app/models/reading.py`:**

1. Remover `id` como PK simples
2. Usar uma das abordagens:
   - **Opção A (recomendada):** Sem PK formal — comum em hypertables de séries temporais. Remover a coluna `id` completamente e usar apenas os índices existentes (`idx_readings_aquarium_param`, `idx_readings_device`).
   - **Opção B:** Composite PK `(id, time)` — mantém o `id` UUID mas inclui `time` na PK.

Recomendação: **Opção A** — hypertables não precisam de PK, e as queries sempre filtram por `time` + `aquarium_id`/`device_id`.

**Demais models: OK.** Qualidade geral excelente — padrão SQLAlchemy 2.0 correto, índices parciais, cascades, JSONB com server_default.

### [2026-02-14 11:15] claude-code — Aprovação Final

Correção aplicada pelo Codex (Opção A): `id` sem PK no banco, usando `__mapper_args__ = {"primary_key": [id]}` para identidade ORM. Compatível com TimescaleDB hypertable. **Aprovado — movido para done.**

### [2026-02-14 14:56] codex (Audit)

Audit: **changes requested**.

Gate executado (Docker):
- `cd /home/carlosfarah/Projects/aquario && make test`

Resultado em 2026-02-14:
- `31 failed, 22 passed, 14 errors`

Erros raiz observados (indicativo de instabilidade no ambiente de testes/integracao):
- `RuntimeError: ... Future ... attached to a different loop` (asyncpg/pytest-asyncio)
- teardown: `UndefinedTableError: table "alert_events" does not exist` ao executar `Base.metadata.drop_all`

Acao:
- Reabrindo esta task (done -> in-progress) ate o backend voltar a ficar green em Docker (`make test`).
