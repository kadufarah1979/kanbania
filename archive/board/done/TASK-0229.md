---
id: TASK-0229
title: "Migrar persistência do ConsoleAI de SQLite para PostgreSQL"
project: consoleai
sprint: sprint-026
okr: null
priority: critical
labels: [backend, database, migration]
story_points: 5
created_at: "2026-02-18T18:59:10-03:00"
created_by: codex
assigned_to: codex
review_requested_from: []
depends_on: []
blocks: []
acted_by:
  - agent: codex
    action: created
    date: "2026-02-18T18:59:10-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-18T18:59:10-03:00"
  - agent: codex
    action: update
    date: "2026-02-18T19:13:20-03:00"
tokens_used: 1553137
tokens_by_phase:
  backlog: 1553137
---

## Descricao

Migrar a camada de persistencia do ConsoleAI de SQLite para PostgreSQL, incluindo adaptacao de conexao, migracoes, operacoes CRUD e validacoes automatizadas.

## Criterios de Aceite

- [x] Aplicacao roda com PostgreSQL como backend principal
- [x] Migracoes e servicos funcionam em PostgreSQL
- [x] Testes automatizados cobrindo fluxo principal passam

## Contexto Tecnico

Evolucao de banco para suportar multiusuario e operacao de producao.

## Notas de Progresso

### [2026-02-18 18:59] codex
Task criada por solicitacao direta para migracao de SQLite para PostgreSQL com execucao imediata.

### [2026-02-18 18:59] codex
Task claimada e movida para in-progress para executar a migracao imediatamente.

### [2026-02-18 19:13] codex
Migração executada em `/home/carlosfarah/Projects/consoleai`:
- `db.py` convertido para adapter multi-engine com foco em PostgreSQL e compatibilidade de placeholders.
- `migrations.py` adaptado para SQL por dialeto (SQLite/PostgreSQL) nas migrações 001/002/003.
- `requirements.txt` atualizado com `psycopg[binary]`.
- README atualizado com uso de `DATABASE_URL`.
- Teste novo `tests/test_db_adapter.py` e suíte consolidada verde (`36 tests OK`).
- Smoke test real em PostgreSQL (Docker + .venv) executado com sucesso:
  - apply migrations: OK
  - tabelas criadas: roles, tenants, users, user_roles, user_tenants, task_requests, task_request_events, task_request_sync_jobs
  - rollback migrations: OK
