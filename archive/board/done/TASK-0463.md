---
id: TASK-0463
title: "Implementar export CSV do relatorio de custo e inventario por tenant"
project: consoleai
sprint: sprint-063
okr: OKR-2026-Q1-03
priority: medium
labels: [feature]
story_points: 2
created_at: "2026-02-23T10:40:00-03:00"
created_by: "claude-code"
assigned_to: claude-code
review_requested_from: []
depends_on: []
blocks: []
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-23T10:40:00-03:00"
  - agent: "claude-code"
    action: claim
    date: "2026-02-24T10:45:00-03:00"
  - agent: "claude-code"
    action: move
    date: "2026-02-24T11:00:00-03:00"
  - agent: "codex"
    action: move
    date: "2026-02-24T10:47:45-03:00"
    detail: "QA aprovado; criterios atendidos para export CSV no unified_dashboard; card movido para done"
  - agent: "codex"
    action: normalize
    date: "2026-02-24T10:48:25-03:00"
    detail: "Normalizacao de board: removidas copias duplicadas em in-progress/review, mantendo estado final em done"
---

## Descricao

Adicionar botao de export no `unified_dashboard.py` que gera um CSV com: custo mensal do tenant (ultimos 3 meses), lista de instancias EC2 com tipo/estado, lista de load balancers. O arquivo e disponibilizado para download direto no Streamlit.

## Criterios de Aceite

- [x] Botao "Exportar relatorio CSV" disponivel no unified_dashboard
- [x] CSV gerado contem: periodo, tenant_id, custo_usd, recursos_ec2, recursos_elb
- [x] Download iniciado automaticamente ao clicar (st.download_button)
- [x] Nome do arquivo: `relatorio_{tenant_id}_{YYYY-MM}.csv`
- [x] Audit event registrado ao exportar (quem exportou e quando)

## Contexto Tecnico

- Usar `pandas.DataFrame.to_csv()` e `st.download_button()`
- Dados do custo via cost_service (cache), inventario via inventory_service
- Registrar evento de export no audit_service

## Notas de Progresso

2026-02-24: Implementacao concluida, aguardando codex review.
- `unified_dashboard.py`: adicionada funcao `_generate_csv_report` + botao `st.download_button`.
- CSV usa `csv.writer` (stdlib, pandas nao disponivel) com colunas: periodo, tenant_id, custo_usd, recursos_ec2, recursos_elb.
- Filename: `relatorio_{tenant_id}_{YYYY-MM}.csv`.
- Audit event registrado via `record_audit_event` se `db_conn` em `st.session_state`.
- `tests/unit/test_csv_export.py`: 15 testes (6 unit + 7 integration + 2 audit), todos passando.
- Suite completa: 261/261 passando.
- Branch: task/TASK-0463, commit: be753a3.

### 2026-02-24 — codex (QA)

**Decisao:** Aprovado (`review -> done`)

**Validacao objetiva:**
- `src/pages/unified_dashboard.py:264` botao `st.download_button` com label "Exportar relatorio CSV" e download de CSV.
- `src/pages/unified_dashboard.py:37` CSV com colunas `periodo, tenant_id, custo_usd, recursos_ec2, recursos_elb`.
- `src/pages/unified_dashboard.py:261` filename no formato `relatorio_{tenant_id}_{YYYY-MM}.csv`.
- `src/pages/unified_dashboard.py:275` registro de audit event na exportacao (`event_type=export`, `action=csv_export`).
- GATES do card informados como `OVERALL: PASS` (sem rerun de testes, conforme protocolo).

### 2026-02-24 — codex (normalizacao)

- Removidas entradas duplicadas de `TASK-0463` em `board/in-progress` e `board/review`.
- Estado canonico mantido: `board/done/TASK-0463.md`.
