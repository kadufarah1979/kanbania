---
id: TASK-0371
title: "Backend - deteccao de desvio e notificacao de tendencia"
project: aquario
sprint: sprint-049
okr: OKR-2026-Q2-05
priority: medium
labels: [feature]
story_points: 3
created_at: "2026-02-21T15:00:00-03:00"
created_by: "claude-code"
assigned_to: claude-code
review_requested_from: [codex]
depends_on: [TASK-0368]
blocks: []
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T15:00:00-03:00"
  - agent: "claude-code"
    action: claimed
    date: "2026-02-21T20:30:00-03:00"
  - agent: "claude-code"
    action: moved_to_review
    date: "2026-02-21T21:00:00-03:00"
  - agent: "codex"
    action: qa_changes_requested
    date: "2026-02-21T17:43:34-03:00"
  - agent: claude-code
    action: qa_fix_applied
    date: "2026-02-21T22:00:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-21T22:00:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-21T17:51:13-03:00"
tokens_used: 259
tokens_by_phase:
  backlog: 259
---

## Descricao

Implementar deteccao automatica de desvio de tendencia e enviar notificacao
quando um parametro mostra tendencia de saida da faixa ideal (ex: pH caindo
consistentemente nos ultimos 3 test kits).

## Criterios de Aceite

- [x] Detecta quando tendencia indica saida da faixa ideal em N analises consecutivas
- [x] Envia notificacao in-app com detalhes da tendencia
- [x] Configuravel: numero de analises para trigger, sensibilidade
- [x] Testes com cenarios de desvio crescente e estavel

## Contexto Tecnico

Integrar com notification_service.py existente. Avaliar apos cada nova analise salva.
Configuracao via parametros do aquario ou settings globais.

## Notas de Progresso

- Novo servico `app/services/deviation_service.py`
- `check_deviation_after_analysis()`: busca ultimas N analises, calcula slope, verifica se direcao aponta para warn/crit range
- Parametros configuraveis: min_analyses (default 3), slope_threshold (default 0.005/dia)
- Notificacao via `create_in_app_notification()` com event_type `trend_warning`
- URL da notificacao aponta para historico filtrado pelo parametro
- Integrado no `confirm_analysis()` (non-blocking, try/except)
- 8 testes unitarios: no_kit, no_param, no_ranges, too_few, rising_deviation, falling_deviation, stable_no_notif, rising_within_ideal
- 8/8 testes passando. Commit: 3a83972

### [2026-02-21 17:43] codex
QA: changes requested.
## Pendencias (QA)
1. ~~backend/app/services/deviation_service.py:83 - a deteccao atual usa apenas slope agregado para classificar tendencia e nao valida "N analises consecutivas".~~
   RESOLVIDO: Adicionado helper `_count_consecutive_direction()` que conta incrementos/decrementos consecutivos do final da serie. Agora exige N-1 passos consecutivos na mesma direcao antes de notificar. Teste de cenario zig-zag (8.2→8.6→8.3→8.7) confirma que NAO envia notificacao. 6 testes unitarios para o helper + 1 teste zig-zag end-to-end. 15/15 testes passando. Commit: 118f67f

### [2026-02-21 17:51] codex
QA aprovado apos validacao da regra de consecutividade e do teste zig-zag.
