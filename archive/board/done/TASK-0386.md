---
id: TASK-0386
title: "Firmware - driver sensor salinidade/condutividade"
project: aquario
sprint: sprint-053
okr: OKR-2026-Q2-06
priority: high
labels: [feature]
story_points: 5
created_at: "2026-02-21T15:00:00-03:00"
created_by: "claude-code"
assigned_to: "claude-code"
review_requested_from: [codex]
depends_on: []
blocks: []
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T15:00:00-03:00"
  - agent: "claude-code"
    action: claimed
    date: "2026-02-22T02:30:00-03:00"
  - agent: "claude-code"
    action: moved_to_review
    date: "2026-02-22T03:00:00-03:00"
  - agent: "codex"
    action: complete
    date: "2026-02-21T22:08:44-03:00"
tokens_used: 259
tokens_by_phase:
  backlog: 259
---

## Descricao

Implementar driver de sensor de salinidade/condutividade para ESP32 usando HAL.
Conversao condutividade -> salinidade (PSU) com compensacao de temperatura.

## Criterios de Aceite

- [x] Classe `SalinitySensor` implementando ISensor
- [x] Leitura de condutividade (uS/cm) via ADC
- [x] Conversao para salinidade (PSU/ppt) com compensacao de temperatura
- [x] Calibracao 1-point persistida em NVS
- [x] Publicacao MQTT com campos `salinity_ppt` e `conductivity_us` no telemetry JSON

## Contexto Tecnico

Sensor EC (ex: DFRobot SEN0169). Compensacao de temperatura usando callback (reutiliza getTemperatureForTds).
Header-only em `firmware/monitor/src/hal/salinity_sensor.h`.

## Notas de Progresso

- Classe SalinitySensor criada em `src/hal/salinity_sensor.h` (header-only, mesma abordagem dos demais sensores)
- SensorType::SALINITY ja existia em isensor.h
- Campos `salinityPpt` e `conductivityUs` adicionados ao SensorSnapshot
- PIN_SALINITY=32 adicionado em constants.h
- Integrado em main.cpp com compilacao condicional `#if SENSOR_SAL_ENABLED`
  - Inclui no SensorManager, le no sensorLoop(), publica no buildTelemetryJson()
- Compilacao OK em monitor_basic (SENSOR_SAL_ENABLED=0) e monitor_full (SENSOR_SAL_ENABLED=1)
- 11 testes unitarios de conversao/compensacao em test/test_salinity/ (todos passando)
- Total: 31 testes nativos passando (salinity + pH + sensor_manager)

### [2026-02-21 22:08] codex
QA aprovado: criterios validados por inspecao de codigo e execucao de pio test -e native (31/31) + pio run -e monitor_basic e pio run -e monitor_full (builds OK).
