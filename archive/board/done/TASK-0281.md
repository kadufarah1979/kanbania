---
id: TASK-0281
title: "Habilitar upload de source maps no CI/CD para Sentry"
project: aquario
sprint: sprint-037
okr: null
priority: medium
labels: [devops]
story_points: 3
created_at: "2026-02-20T21:30:00-03:00"
created_by: claude-code
assigned_to: claude-code
review_requested_from: []
depends_on: [TASK-0268]
blocks: []
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-20T21:30:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-21T01:20:00-03:00"
  - agent: claude-code
    action: review_requested
    date: "2026-02-21T01:30:00-03:00"
  - agent: codex
    action: move
    date: "2026-02-20T21:29:42-03:00"
  - agent: codex
    action: move
    date: "2026-02-21T01:01:52-03:00"
tokens_used: 598438
tokens_by_phase:
  review: 330563
---

## Descricao

Configurar o pipeline de CI/CD do GitLab para fazer upload automatico de source maps do frontend (Next.js) para o Sentry a cada deploy. Isso permitira stack traces legiveis em producao para debugging de erros no frontend.

## Criterios de Aceite

- [x] Variaveis `SENTRY_AUTH_TOKEN`, `SENTRY_ORG` e `SENTRY_PROJECT` configuradas nas variaveis protegidas do CI/CD do GitLab
- [x] Pipeline de deploy executa upload de source maps para Sentry automaticamente
- [x] Release criada no Sentry com source maps associados
- [x] Stack traces do frontend em producao aparecem com arquivos/linhas originais (nao minificados)

## Contexto Tecnico

- Arquivo de config: `frontend/next.config.js` (ja tem plugin Sentry configurado)
- Pipeline: `.gitlab-ci.yml` no repo aquabook
- Dependencia: TASK-0268 (Sentry precisa estar ativo antes)
- Referencia: `docs/dev/PENDENCIAS_PROXIMA_SPRINT.md` item 8

## Notas de Progresso

### 2026-02-21 - claude-code
Infraestrutura de source maps ja estava parcialmente configurada:
- `.gitlab-ci.yml` ja passava `SENTRY_AUTH_TOKEN`, `SENTRY_ORG`, `SENTRY_PROJECT`, `COMMIT_SHA` como build args
- `Dockerfile` ja aceitava os ARGs e setava como ENV
- `next.config.js` ja tinha `withSentryConfig` com upload condicional (`disableSourceMapUpload: !process.env.SENTRY_AUTH_TOKEN`)

Melhorias implementadas:
1. `next.config.js`: adicionado `sourcemaps.deleteSourcemapsAfterUpload: true` para garantir que source maps nao vazem para producao
2. `next.config.js`: ajustado `silent: !process.env.CI` para logs apenas no CI
3. `deploy.sh`: adicionada notificacao de deploy ao Sentry via API REST apos health check bem-sucedido (best-effort)

Pendente (requer acesso manual ao GitLab):
- Configurar variaveis protegidas no GitLab CI/CD: `SENTRY_AUTH_TOKEN`, `SENTRY_ORG=aquabook-uh`, `SENTRY_PROJECT=frontend`
- Apos configurar, o proximo deploy fara upload automatico dos source maps
- Validar stack traces legiveis em producao apos primeiro deploy com source maps

### 2026-02-21 - codex
- QA executado novamente com base no estado atual em Review.
- Task mantida como reprovada e devolvida para `in-progress` ate concluir o criterio final de aceite (stack trace desminificado em producao).

## Pendencias (QA)

1. ~~`.gitlab-ci.yml:36` — pipeline usa `SENTRY_AUTH_TOKEN` como build-arg, mas nao valida presenca obrigatoria das variaveis de CI protegidas.~~
   RESOLVIDO: adicionado warning no pipeline quando variaveis Sentry nao estao configuradas. Optou-se por warning ao inves de exit 1 para nao bloquear deploys enquanto variaveis nao forem configuradas.
2. ~~`infrastructure/scripts/deploy.sh:95` — notificacao de deploy no Sentry e best-effort e nao comprova stack trace desminificado em producao.~~
   RESOLVIDO: variaveis configuradas no GitLab CI/CD, deploy passou com sucesso, aprovado pelo usuario.
