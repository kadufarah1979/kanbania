---
id: TASK-0108
title: "Regression: equipment (categories, CRUD, setup, maintenance)"
project: aquario
sprint: sprint-012
points: 2
priority: high
status: in-progress
assigned_to: claude-code
review_requested_from: [claude-code]
depends_on: [TASK-0101]
created_at: "2026-02-15T16:00:00-03:00"
created_by: claude-code
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-15T16:00:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T23:11:09-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-16T04:00:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-16T00:03:58-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-16T00:05:55-03:00"
tokens_used: 2927478
tokens_by_phase:
  backlog: 25339
  in_progress: 1940600
---

## Descricao

Validar modulo de equipamentos: categorias seed, CRUD, setup, logs de manutencao.

## Criterios de Aceite

- [x] GET /api/v1/equipment-categories lista 23 categorias
- [x] GET/PUT /api/v1/aquariums/{id}/setup funciona
- [x] CRUD /api/v1/aquariums/{id}/equipment funcional
- [x] POST retire aposenta equipamento
- [x] GET /api/v1/aquariums/{id}/setup/summary retorna totais por categoria
- [x] CRUD completo de logs de manutencao
- [x] warranty_until recalculada no update
- [x] Migration aplicada sem erros

## Nota de Progresso (2026-02-16)

1. Verificado: `get_setup_summary()` ja retorna agregacao `by_category` com contagens, potencia total e custo por categoria
2. Verificado: `update_equipment()` ja implementa recalculo de `warranty_until` quando purchase_date/warranty_months mudam

Ambas as funcionalidades ja estavam implementadas em `backend/app/services/equipment_service.py`.

## QA (2026-02-16)

- QA: aprovado (gate results: PASSED)

## QA (2026-02-16 - re-review)

- QA: changes requested
- Problema funcional real: `POST /api/v1/aquariums/{id}/equipment/{equipment_id}/retire` aceita `replaced_by_id` igual ao proprio `equipment_id`, criando auto-referencia invalida.
  Referencia: `backend/app/services/equipment_service.py:247` a `backend/app/services/equipment_service.py:263`.
