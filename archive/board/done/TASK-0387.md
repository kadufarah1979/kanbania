---
id: TASK-0387
title: "Firmware - migracao completa do monitor legado"
project: aquario
sprint: sprint-053
okr: OKR-2026-Q2-06
priority: high
labels: [refactor]
story_points: 8
created_at: "2026-02-21T15:00:00-03:00"
created_by: "claude-code"
assigned_to: "claude-code"
review_requested_from: [codex]
depends_on: [TASK-0378]
blocks: [TASK-0388]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T15:00:00-03:00"
  - agent: "claude-code"
    action: claimed
    date: "2026-02-22T03:10:00-03:00"
  - agent: "claude-code"
    action: moved_to_review
    date: "2026-02-22T03:30:00-03:00"
  - agent: "codex"
    action: move
    date: "2026-02-21T22:13:21-03:00"
  - agent: "claude-code"
    action: moved_to_review
    date: "2026-02-22T05:00:00-03:00"
    note: "Criterio 24h+ movido para TASK-0423 (requer hardware)"
  - agent: "codex"
    action: complete
    date: "2026-02-21T22:20:18-03:00"
tokens_used: 259
tokens_by_phase:
  backlog: 259
---

## Descricao

Migrar todo o firmware monitor legado para a arquitetura modular.
Remover codigo legado, integrar todos os novos sensores (pH, salinidade)
via SensorManager, e garantir que todos os modulos (MQTT, OLED, alertas, web config, OTA)
funcionam harmoniosamente.

## Criterios de Aceite

- [x] Zero codigo legado de leitura direta de sensores
- [x] SensorManager com todos os sensores registrados
- [x] MQTT publica todos os parametros (temp, humidity, tds, ph, salinity)
- [x] OLED exibe parametros com rotacao
- [x] Web config permite configurar todos sensores
- [x] OTA client integrado no loop principal

## Contexto Tecnico

Integracao final de todos os modulos. Testar estabilidade de memoria
(ESP32 tem 320KB SRAM). Monitorar heap livre com esp_get_free_heap_size().

**Nota**: criterio "24h+ sem crash" movido para TASK-0423 (requer hardware fisico,
impossivel validar em CI/review de codigo).

## Notas de Progresso

### Codigo legado removido
- `sensors.h` e `sensors.cpp` (facade legada) removidos â€” main.cpp ja usava SensorManager diretamente

### SensorManager completo
- 5 sensores registrados: DS18B20 (temp), TDS, DHT (humidity), pH, Salinity
- Todos com compilacao condicional (SENSOR_PH_ENABLED, SENSOR_SAL_ENABLED)

### MQTT publica todos parametros
- `buildTelemetryJson()`: temp_c, tds_ppm, hum_pct, ph, salinity_ppt, conductivity_us
- `buildStateJson()`: temp_c, tds_ppm, ph, salinity_ppt

### OLED com rotacao de paginas (3 paginas, ciclo de 3s)
- Pagina 1: Temperatura (grande) + TDS
- Pagina 2: pH (grande) + Salinidade
- Pagina 3: Umidade, RSSI, Relays, Device ID
- Header fixo: IP + status MQTT

### Web config com endpoint /sensors
- GET /sensors retorna JSON com lista de sensores registrados (tipo, unidade, ready, valor)
- Endpoints existentes mantidos (/config, /status, /relays)

### OTA integrado no loop
- g_ota.loop() adicionado ao loop principal (condicional OTA_ENABLED)
- Verificacao periodica de updates automatica

### AlertEngine expandido
- Novos tipos de alerta: pH fora de range (type 3, 7.8-8.5), salinidade (type 6, 30-37 ppt)
- Constantes adicionadas em constants.h: PH_LOW, PH_HIGH, SAL_LOW_PPT, SAL_HIGH_PPT

### Compilacao
- monitor_basic: SUCCESS (RAM 14.8%, Flash 67.0%)
- monitor_full: SUCCESS (RAM 15.5%, Flash 79.7%)
- 31 testes nativos passando

### [2026-02-21 22:20] codex
QA aprovado. Criterios dependentes de hardware foram desdobrados para TASK-0423 e o escopo desta task ficou totalmente atendido em review de codigo.
