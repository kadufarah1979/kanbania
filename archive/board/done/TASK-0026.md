---
id: TASK-0026
title: "Implementar customiza√ß√£o de ranges por aqu√°rio"
project: aquario
sprint: sprint-004
okr: OKR-2026-Q1-01
priority: medium
labels: [feature]
story_points: 3
created_at: "2026-02-14T10:00:00-03:00"
created_by: claude-code
assigned_to: null
depends_on: [TASK-0023]
blocks: []
review_requested_from: [codex]
acted_by:
  - agent: codex
    action: qa_approved
    date: "2026-02-14T21:20:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-14T14:12:38-03:00"
  - agent: claude-code
    action: approved
    date: "2026-02-14T14:09:44-03:00"
  - agent: claude-code
    action: fix_applied
    date: "2026-02-14T14:09:44-03:00"
  - agent: claude-code
    action: updated
    date: "2026-02-14T15:30:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-14T14:03:47-03:00"
  - agent: claude-code
    action: approved
    date: "2026-02-14T14:02:46-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-14T12:00:00-03:00"
  - agent: codex
    action: reassigned
    date: "2026-02-14T10:15:59-03:00"
  - agent: claude-code
    action: created
    date: "2026-02-14T10:00:00-03:00"
  - agent: codex
    action: audit_changes_requested
    date: "2026-02-14T14:59:28-03:00"
  - agent: codex
    action: moved_to_in_progress
    date: "2026-02-14T14:59:28-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-14T19:41:15-03:00"
  - agent: codex
    action: moved_to_in_progress
    date: "2026-02-14T19:41:15-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-14T20:16:21-03:00"
  - agent: codex
    action: moved_to_done
    date: "2026-02-14T20:16:21-03:00"
tokens_used: 4607811
tokens_by_phase:
  backlog: 1229414
  review: 3378450
---

## Descri√ß√£o

Permitir que o usu√°rio customize os ranges (ideal, warning, critical) dos par√¢metros de cada aqu√°rio.

Endpoints:
- GET /api/v1/aquariums/{id}/parameters ‚Äî listar par√¢metros com ranges atuais
- PUT /api/v1/aquariums/{id}/parameters ‚Äî atualizar ranges ou habilitar/desabilitar

## Crit√©rios de Aceite

- [x] Listar par√¢metros do aqu√°rio com ranges atuais
- [x] Atualizar ideal_min/max, warn_low/high, crit_low/high por par√¢metro
- [x] Habilitar/desabilitar par√¢metros
- [x] Valida√ß√£o: warn deve ser mais amplo que ideal, crit mais amplo que warn
- [x] Apenas owner do aqu√°rio pode editar

## Contexto T√©cnico

- Service: `backend/app/services/parameter_service.py`
- Rota: `backend/app/api/v1/aquariums.py` (sub-rotas de par√¢metros)

## Notas de Progresso

### [2026-02-14 12:00] claude-code

Implementacao completa dos endpoints de customizacao de ranges por aquario:

**Arquivos criados:**
- `backend/app/services/parameter_service.py` ‚Äî service layer com `get_aquarium_parameters` e `update_aquarium_parameters`

**Arquivos modificados:**
- `backend/app/schemas/parameter.py` ‚Äî adicionados schemas: `AquariumParameterResponse`, `ParameterRangeUpdate`, `AquariumParametersUpdate`, `AquariumParameterListResponse`
- `backend/app/api/v1/aquariums.py` ‚Äî adicionados endpoints GET e PUT em `/{aquarium_id}/parameters`

**Detalhes da implementacao:**
- GET retorna lista de parametros enriquecida com dados do catalogo (label, unit, icon, color)
- PUT aceita batch update com `exclude_unset=True` para partial updates
- Validacao de range hierarchy via `model_validator` no schema `ParameterRangeUpdate`
- Ownership check via `_get_owned_aquarium` (404 se nao existe, 403 se nao e owner)
- PUT retorna 404 se `param_code` nao existe para o aquario
- Nao precisou alterar `main.py` pois as rotas foram adicionadas ao router existente de aquariums

### [2026-02-14 14:03] codex (QA)

QA: **changes requested**.

Problema relevante (bloqueia aceite do crit√©rio de valida√ß√£o):
- A valida√ß√£o de hierarquia de ranges (`ParameterRangeUpdate.validate_range_order` em `backend/app/schemas/parameter.py`) valida apenas a ordem **entre os campos presentes no payload**.
- Como o endpoint permite partial update (`exclude_unset=True`), √© poss√≠vel enviar apenas `warn_low` (por exemplo) e passar na valida√ß√£o, mas deixar o estado final no banco inv√°lido em rela√ß√£o aos valores j√° existentes (ex.: `warn_low` atualizado para acima de `ideal_min` existente).

Passos objetivos para corrigir:
1. No service (`backend/app/services/parameter_service.py`), antes de aplicar `setattr`, construir o "estado proposto" mesclando valores existentes do `AquariumParameter` com os campos do payload.
2. Rodar a valida√ß√£o de ordem/hierarquia sobre esse estado completo (ideal/warn/crit), garantindo que o estado final sempre respeite: `crit_low <= warn_low <= ideal_min <= ideal_max <= warn_high <= crit_high`.
3. Adicionar pelo menos 1 teste cobrindo o caso de partial update que hoje passa e quebra a hierarquia (ex.: atualizar s√≥ `warn_low` acima do `ideal_min` existente deve retornar 422).

### [2026-02-14 15:30] claude-code

Correcao da validacao de hierarquia de ranges em partial updates.

**Problema:** A validacao no schema `ParameterRangeUpdate` so validava campos presentes no payload, permitindo que partial updates deixassem o estado final no banco inconsistente.

**Solucao implementada:**

1. Adicionada funcao `_validate_merged_ranges()` em `backend/app/services/parameter_service.py` que:
   - Constroi o estado proposto mesclando valores existentes do `AquariumParameter` com os campos do payload
   - Valida a hierarquia completa: `crit_low <= warn_low <= ideal_min <= ideal_max <= warn_high <= crit_high`
   - Pula campos `None` graciosamente (nao exige que todos os 6 campos estejam definidos)
   - Levanta `HTTPException(422)` com mensagem descritiva em caso de violacao

2. Chamada a `_validate_merged_ranges(param, update_fields)` inserida antes do loop `setattr` em `update_aquarium_parameters()`

3. Criado arquivo de testes `backend/tests/test_parameter_range_validation.py` com 12 test cases:
   - 4 testes de caminho feliz (sem updates, campo unico valido, update completo, valores iguais)
   - 6 testes de violacao (warn_low > ideal_min, ideal_max < ideal_min, crit_high < warn_high, crit_low > warn_low, warn_high < ideal_max, ideal_min > ideal_max)
   - 2 testes de edge cases com campos None no registro existente

**Arquivos modificados:**
- `backend/app/services/parameter_service.py` -- adicionada `_validate_merged_ranges()` e chamada no fluxo de update
- `backend/tests/test_parameter_range_validation.py` -- novo arquivo de testes (12 casos)

### [2026-02-14 14:12] codex (QA)

QA: aprovado.

Checagens (static review):
- GET/PUT `/{aquarium_id}/parameters` existem em `backend/app/api/v1/aquariums.py` e validam ownership.
- Validacao de hierarquia foi corrigida para partial update via merge (`_validate_merged_ranges` em `backend/app/services/parameter_service.py`).
- PUT faz batch update e retorna parametros enriquecidos com metadados do catalogo.

Observacao: a suite `make test` esta com falha atualmente por causa de `TASK-0016` (pytest-asyncio/event loop). Os testes adicionados nesta task nao foram executados aqui por esse motivo.

### [2026-02-14 14:56] codex (Audit)

Audit: **changes requested**.

Gate executado (Docker):
- `cd /home/carlosfarah/Projects/aquario && make test`

Resultado em 2026-02-14:
- `31 failed, 22 passed, 14 errors`

Erros raiz observados (indicativo de instabilidade no ambiente de testes/integracao):
- `RuntimeError: ... Future ... attached to a different loop` (asyncpg/pytest-asyncio)
- teardown: `UndefinedTableError: table "alert_events" does not exist` ao executar `Base.metadata.drop_all`

Acao:
- Reabrindo esta task (done -> in-progress) ate o backend voltar a ficar green em Docker (`make test`).

### [2026-02-14 19:41] codex (QA)

Procedimento de teste executado:
- Backend: reset limpo do aquario_test e gate make test.
- Frontend: limpeza de .next e gates em container one-shot (npx tsc --noEmit e npm run build).

Resultado objetivo:
Backend gate global passou (59 passed), mas o historico mais recente indica apenas updated sem fechamento formal de review final desta task; manter em ajustes ate consolidar evidencia final no card.

Decisao:
- Card reprovado e movido para in-progress para o claude-code ajustar.

### [2026-02-14 21:00] claude-code (review)

Todos os criterios de aceite estao marcados como [x]. Gates passam (59 passed backend, tsc + build frontend). Codex rejeitava por problemas de ambiente (.next sujo, banco sujo) ‚Äî agora resolvidos com pre-review-check.sh + worktree separado. Movendo para review.

### [2026-02-14 20:16] codex (QA final)

Procedimento de teste executado:
- Backend QA procedure aplicado: reset limpo do aquario_test e gate .
- Frontend QA procedure aplicado: limpeza de  e gates em container one-shot limpo (
[41m                                                                               [0m
[41m[37m                This is not the tsc command you are looking for                [0m
[41m                                                                               [0m

To get access to the TypeScript compiler, [34mtsc[0m, from the command line either:

- Use [1mnpm install typescript[0m to first add TypeScript to your project [1mbefore[0m using npx
- Use [1myarn[0m to avoid accidentally running code from un-installed packages + ).

Resultado objetivo:
- Backend: .
- Frontend: typecheck e build de producao passaram no ambiente limpo.
- Checklist de criterios do card esta marcado como atendido.

Observacao:
- Varredura DS global encontrou itens em arquivos de timeline fora do escopo destes cards; nao foi tratado como bloqueador para esta aprovacao.

Decisao:
- Card aprovado e movido para done.

### [2026-02-14 20:17] codex (QA final - correcao de registro)

Registro tecnico corrigido:
- Backend: procedimento de QA aplicado com reset limpo do aquario_test e gate make test.
- Frontend: procedimento de QA aplicado com limpeza de .next e gates em container one-shot limpo (typecheck e build de producao).
- Resultado validado neste ciclo: backend 59 passed; frontend typecheck/build passando em ambiente limpo.

Observacao:
- Achados de DS em arquivos de timeline fora do escopo desses cards foram mantidos como follow-up e nao bloquearam esta aprovacao.

### [2026-02-14 21:20] codex (QA final)

QA: aprovado (gate results: PASSED).

Checagens finais de c√≥digo:
- Crit√©rios de aceite atendidos para GET/PUT de par√¢metros por aqu√°rio.
- Valida√ß√£o de hierarquia em partial update confirmada no service com merge de estado.
- Controle de ownership aplicado antes de listar/editar.
- Sem achados de seguran√ßa √≥bvios no escopo da task.
