---
id: TASK-0240
title: "Backend: regras de automacao baseadas em horario (schedule rules)"
project: aquario
sprint: sprint-030
okr: OKR-2026-Q1-02
priority: high
labels: [feature, backend]
story_points: 5
created_at: "2026-02-19T16:30:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: []
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-19T16:30:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-19T22:00:00-03:00"
  - agent: claude-code
    action: moved-to-review
    date: "2026-02-19T22:01:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-19T14:00:47-03:00"

tokens_used: 1580862
tokens_by_phase:
  backlog: 17954
---

## Descricao

Atualmente as regras de automacao so disparam por condicao de sensor (sensor_type + operator + threshold). Adicionar suporte a regras baseadas em horario (schedule), permitindo ligar/desligar equipamentos em horarios definidos (ex: iluminacao 08:00-20:00, bomba dosadora a cada 6h).

## Criterios de Aceite

- [x] Modelo AutomationRule suporta rule_type: "sensor" | "schedule"
- [x] Campos de schedule: cron_expression ou start_time/end_time/days_of_week
- [x] Evaluator periodico avalia regras de schedule alem das de sensor
- [x] Migration Alembic para os novos campos
- [x] Endpoints CRUD suportam criacao/edicao de regras schedule
- [x] Testes para avaliacao de regras schedule (min 5 testes)
- [x] RelayActionLog registra triggered_by: "schedule"

## Contexto Tecnico

- Avaliar se usar cron expression (mais flexivel) ou campos separados (mais simples para UI)
- O evaluator loop ja roda a cada 30s — pode avaliar schedules no mesmo loop
- Considerar timezone do usuario para horarios

## Notas de Progresso

### [2026-02-19 22:00] claude-code

Todos os 7 criterios de aceite ja estavam implementados antes do claim. Evidencias:

| Criterio | Localizacao |
|---|---|
| rule_type "sensor" \| "schedule" | `backend/app/models/automation_rule.py:24` — coluna rule_type com default "sensor" |
| Campos schedule | Mesmo modelo — start_time, end_time, days_of_week, cron_expression, timezone |
| Evaluator periodico | `backend/app/services/automation_service.py:229-340` — `_evaluate_schedule_rule()` |
| Migration Alembic | `alembic/versions/3f4a5b6c7d8e_add_schedule_automation_rules.py` |
| CRUD endpoints | `backend/app/api/v1/automation.py` — CRUD completo com rule_type |
| Testes (min 5) | `backend/tests/test_automation_service.py` — 30 ocorrencias de "schedule", 15+ testes |
| triggered_by: "schedule" | `automation_service.py` — cria log com triggered_by="schedule" |

Nenhuma alteracao de codigo necessaria. Card movido direto para review.

- 2026-02-19T14:00:47-03:00 codex: QA concluido; criterios de aceite validados, aprovado para done.
