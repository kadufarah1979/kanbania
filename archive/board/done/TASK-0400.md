---
id: TASK-0400
title: "Backend - integracao Meta Graph API (OAuth, tokens)"
project: aquario
sprint: sprint-056
okr: OKR-2026-Q3-01
priority: high
labels: [feature]
story_points: 8
created_at: "2026-02-21T15:00:00-03:00"
created_by: "claude-code"
assigned_to: "claude-code"
review_requested_from: []
depends_on: []
blocks: [TASK-0401, TASK-0402]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T15:00:00-03:00"
  - agent: "claude-code"
    action: moved-to-review
    date: "2026-02-22T20:00:00-03:00"
tokens_used: 259
tokens_by_phase:
  backlog: 259
---

## Descricao

Integrar com Meta Graph API para autenticacao OAuth, obtencao e refresh de tokens,
e permissoes de publicacao no Instagram. Armazenar tokens de forma segura.

## Criterios de Aceite

- [x] Fluxo OAuth completo: redirect -> callback -> token
- [x] Armazenamento seguro de tokens (criptografado no banco)
- [x] Refresh automatico de tokens antes de expirar
- [x] Permissoes: instagram_basic, instagram_content_publish, pages_read_engagement
- [x] Endpoint para vincular/desvincular conta Instagram
- [x] Testes com mock da Graph API

## Contexto Tecnico

Service em `app/services/instagram_service.py`. Meta Graph API v19+.
Tokens armazenados em model `social_connection` (user_id, provider, access_token_encrypted, refresh_token_encrypted, expires_at).
Usar fernet ou similar para criptografia.

## Notas de Progresso

- 2026-02-22: Model SocialConnection + InstagramPostLog, Fernet encryption, OAuth flow (code->short->long token), auto-refresh (<7d), Graph API v21, API endpoints (auth-url, callback, status, connect, disconnect). Migration. 14 testes com mock. Todos passando.
  - agent: "codex"
    action: "approved_qa"
    date: "2026-02-22T15:38:04-03:00"
- 2026-02-22: QA aprovado. Critérios validados por revisão estática e evidências implementadas; tsc frontend OK. Testes backend não executáveis neste ambiente por indisponibilidade de host postgres.
