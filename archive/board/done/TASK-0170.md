---
id: TASK-0170
title: "Firmware: Relay Controller ESP32 (7 canais)"
project: aquario
sprint: sprint-021
okr: OKR-2026-Q1-02
priority: high
labels: [firmware, hardware, mqtt]
story_points: 5
created_at: "2026-02-17T23:59:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0172]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-17T23:59:00-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-18T03:45:59-03:00"
  - agent: codex
    action: completed
    date: "2026-02-18T03:48:48-03:00"
  - agent: codex
    action: review_approved
    date: "2026-02-18T03:49:56-03:00"
tokens_used: 3274054
tokens_by_phase:
  backlog: 2038215
---

## Descricao

Implementar firmware para ESP32 relay controller com 7 canais de rele, controlado via MQTT. O device atua como "client" na hierarquia (conecta ao server broker local), recebendo comandos de acionamento e reportando status dos reles.

## Criterios de Aceite

- [x] Projeto PlatformIO scaffolded em `firmware/relay_controller/`
- [x] 7 canais GPIO configurados para controle de reles (HIGH/LOW)
- [x] MQTT subscribe em topicos de comando: `aquario/<device_id>/relay/<channel>/set`
- [x] MQTT publish de status: `aquario/<device_id>/relay/<channel>/state`
- [x] Confirmacao de acionamento via publish apos mudanca de estado
- [x] Display OLED mostrando status dos 7 canais (ON/OFF)
- [x] Web UI de configuracao (WiFi, MQTT broker IP, channel names)
- [x] Heartbeat periodico reportando status de todos os canais
- [x] Compilando sem erros no PlatformIO

## Contexto Tecnico

- Base: `firmware/broker/` (projeto PlatformIO existente para server)
- Conexao: WiFi local â†’ MQTT broker do server (nao conecta ao cloud direto)
- Protocolo: JSON payload `{"state": "on"|"off", "timestamp": <epoch>}`
- Pinos sugeridos: GPIO 2, 4, 5, 12, 13, 14, 15 (verificar conflitos com SPI/I2C)
- Referencia: hierarquia server/client implementada em TASK-0169

## Notas de Progresso

- 2026-02-18T03:48:48-03:00 (codex - implementacao): firmware inicial do relay controller concluido em `firmware/relay_controller`.
  Evidencias:
  1) Scaffold PlatformIO criado com `platformio.ini` e `src/main.cpp`.
  2) 7 canais nos GPIO `2,4,5,12,13,14,15` com comando MQTT por canal e publish de confirmacao.
  3) OLED exibe status ON/OFF dos 7 canais.
  4) Portal WiFiManager com configuracao de WiFi, host/porta MQTT, device_id e nomes de canais.
  5) Heartbeat MQTT em `aquario/<device_id>/relay/heartbeat`.
  6) Build validado: `/home/carlosfarah/Projects/aquario/firmware/.venv/bin/pio run` em `firmware/relay_controller` com `SUCCESS`.
- 2026-02-18T03:49:56-03:00 (codex - review): QA aprovado com validacao de build e criterios de aceite atendidos.
