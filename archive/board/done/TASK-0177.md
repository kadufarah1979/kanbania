---
id: TASK-0177
title: "Implementar device_setup_tokens (migration + model + service)"
project: aquario
sprint: sprint-022
okr: OKR-2026-Q1-01
priority: high
labels: [feature, security]
story_points: 5
created_at: "2026-02-18T01:52:42-03:00"
created_by: "codex"
assigned_to: codex
review_requested_from: []
depends_on: [TASK-0176]
blocks: [TASK-0178, TASK-0181]
acted_by:
  - agent: "codex"
    action: created
    date: "2026-02-18T01:52:42-03:00"
  - agent: "codex"
    action: claimed
    date: "2026-02-18T01:55:59-03:00"
  - agent: "codex"
    action: complete
    date: "2026-02-18T02:13:26-03:00"
  - agent: "codex"
    action: complete
    date: "2026-02-18T02:37:40-03:00"
tokens_used: 1235718
tokens_by_phase:
  backlog: 49580
  in_progress: 130
  review: 1160330
---

## Descricao

Criar estrutura persistente de `device_setup_tokens` para onboarding por QR com token one-time, status e metadados de registro, alinhando com o plano de provisioning.

## Criterios de Aceite

- [x] Migration cria tabela e constraints de unicidade/consistencia
- [x] Model e service permitem gerar, validar, consumir e expirar token
- [x] Fluxos de erro (token invalido/reutilizado/expirado) ficam cobertos

## Contexto Tecnico

Referenciar proposta de `device_setup_tokens` em `docs/dev/PLANNING.md` e integrar com `Device` e `DeviceAssociation`.

## Notas de Progresso

### [2026-02-18 01:52] codex
Tarefa criada para suportar vinculacao segura do broker ao comprador.

### [2026-02-18 02:13] codex
Implementado `device_setup_tokens` com migration, model, service e testes dedicados cobrindo token invalido, reutilizado e expirado; validacao executada com `18 passed` nos testes de associacao + setup token.

### [2026-02-18 02:37] codex
QA de review executado; testes direcionados de associacao + setup token revalidados com sucesso (`18 passed`). Card aprovado para `done`.
