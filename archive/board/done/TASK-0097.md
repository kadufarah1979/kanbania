---
id: TASK-0097
title: "Equipment: service layer + API endpoints"
project: aquario
sprint: sprint-011
points: 3
priority: high
status: review
assigned_to: null
review_requested_from: [codex]
depends_on: [TASK-0096]
created_at: "2026-02-15T14:10:00-03:00"
created_by: claude-code
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-15T14:10:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T23:11:09-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-16T04:00:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-16T00:01:19-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-16T05:00:00-03:00"
tokens_used: 2471807
tokens_by_phase:
  backlog: 2590
  in_progress: 958787
---

## Descricao

Service layer e API endpoints para setup e equipamentos:
- equipment_service: CRUD equipamentos, retire com motivo/substituto, list com filtros
- equipment_maintenance_service: CRUD registros de manutencao
- aquarium_service: GET/PUT setup (dimensoes, sump, substrato, rocha, datas)

API: GET/PUT setup, CRUD equipment, POST retire, CRUD maintenance, GET categories, GET summary.

## Criterios de Aceite

- [x] Service layer com CRUD completo de equipamentos
- [x] Service de manutencao com CRUD
- [x] Setup endpoints (GET/PUT) funcionais
- [x] Equipment CRUD endpoints funcionais
- [x] Categories endpoint com filtro por tipo de aquario
- [x] Summary endpoint retorna ficha completa
- [x] Todas as queries filtram por owner/aquarium correto
- [x] make test passa

## Nota de Progresso (2026-02-16)

Verificado: `update_equipment()` em `backend/app/services/equipment_service.py` ja implementa recalculo de `warranty_until` quando `purchase_date` ou `warranty_months` sao alterados. A logica estava presente desde a implementacao original.

## Contexto Tecnico

- Ref: docs/dev/AQUARIUM_SETUP.md secao 7
- warranty_until = purchase_date + warranty_months

## Revisao Codex (2026-02-15T23:11:09-03:00)

- Resultado: reprovado; retorno para in-progress.
- Acao: fix warranty_until recalc no update e reenviar para review.

## Revisao Codex (2026-02-16T00:01:19-03:00)

- QA: changes requested (gate results: PASSED).
- Problema funcional real: `GET /api/v1/aquariums/{aquarium_id}/setup/summary` pode falhar em runtime.
  Em `backend/app/services/equipment_service.py`, o resumo usa `e.category.name`, mas `EquipmentCategory` expoe `name_pt` e `name_en` (nao existe campo `name` no model/schema).
- Impacto: viola criterio "Summary endpoint retorna ficha completa" quando houver equipamentos.
- Acao solicitada: ajustar summary para usar campo valido (`name_pt`/`name_en`) e reenviar para review.

## Nota de Progresso (2026-02-16 05:00) claude-code

Corrigido: summary endpoint agora usa `category.name_pt` em vez de `category.name` no equipment summary. O campo `name` nao existe no model EquipmentCategory; o correto e `name_pt` para exibicao em portugues.
