---
id: TASK-0283
title: "Enriquecer frontend TPA: formulario completo, historico e graficos"
project: aquario
sprint: sprint-037
okr: null
priority: high
labels: [feature, ux]
story_points: 8
created_at: "2026-02-20T23:30:00-03:00"
created_by: claude-code
assigned_to: claude-code
review_requested_from: []
depends_on: [TASK-0282]
blocks: []
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-20T23:30:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-21T00:20:00-03:00"
  - agent: claude-code
    action: review_requested
    date: "2026-02-21T01:15:00-03:00"
  - agent: codex
    action: move
    date: "2026-02-20T21:29:42-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-21T00:33:57-03:00"
  - agent: codex
    action: move
    date: "2026-02-21T01:01:52-03:00"
  - agent: codex
    action: move
    date: "2026-02-21T01:46:14-03:00"
tokens_used: 818411
tokens_by_phase:
  review: 323855
---

## Descricao

Enriquecer a aba TPA na pagina de manutencao do frontend com formulario completo de registro (marca de sal, fonte de agua, salinidade alvo, TDS, atividades extras, agendamento de proxima TPA), historico tabelar com colunas enriquecidas, e grafico de impacto mostrando parametros antes/depois (NO3, PO4) com marcadores de TPA ao longo do tempo.

## Criterios de Aceite

- [x] Formulario de registro de TPA com campos: volume, marca do sal (select com opcoes pre-cadastradas), fonte de agua (RODI/torneira/etc), salinidade alvo, TDS da agua, checkboxes sifonagem/limpeza vidro, data/hora, proxima TPA em N dias, notas
- [x] Calculo automatico de percentual exibido no formulario (ex: "10% de 260L")
- [x] Params antes/depois exibidos no formulario (snapshot automatico ou entrada manual)
- [x] Historico de TPAs em tabela com colunas: data, volume, %, sal, parametros antes→depois
- [x] Grafico de impacto (Recharts) mostrando NO3/PO4 com marcadores verticais nas datas de TPA
- [x] Resumo no topo: frequencia media, volume medio, marca de sal mais usada
- [x] Proxima TPA prevista com contagem regressiva
- [x] Responsivo em mobile

## Contexto Tecnico

- Pagina existente: `frontend/src/app/(authenticated)/maintenance/page.tsx`
- Store existente: `frontend/src/stores/maintenance-store.ts`
- Componentes de referencia: `frontend/src/components/maintenance/filter-media/` (padrao de tabs)
- Graficos: usar Recharts (ja no projeto)
- Wireframes: `docs/dev/MAINTENANCE_AND_ROUTINES.md` secoes 2.3 e 2.4
- Depende de TASK-0282 (backend TPA enriquecido)

## Notas de Progresso

### 2026-02-21 - claude-code
- Criado `tpa-form.tsx` com formulario completo: volume, marca do sal (select pre-cadastradas via API), lote, salinidade, fonte de agua (5 opcoes), TDS, checkboxes sifonagem/vidros, data/hora, proxima TPA em N dias, notas
- Criado `tpa-summary.tsx` com 4 cards: volume medio (com %), frequencia (dias), sal mais usado, proxima TPA (com countdown/atrasada)
- Criado `tpa-tab.tsx` com summary + form + historico enriquecido (volume com badge %, sal, salinidade, TDS, fonte, badges atividades, params antes/depois, notas)
- Atualizado `maintenance-store.ts` com fetchWaterChangeSummary, fetchSaltBrands (cache), refresh de summary apos criacao
- Atualizado `maintenance.ts` API client com WaterChangeSummary, SaltBrand, novas funcoes
- Refatorado `page.tsx` para usar TpaTab component, removendo codigo inline de TPA
- TypeScript compila sem erros
- Pendente: grafico de impacto (Recharts), calculo de % exibido no formulario, params antes/depois no formulario (requer integracao com modulo de parametros)

### 2026-02-21 - codex
- QA reprovado: criterios de aceite pendentes para percentual automatico no formulario, envio de params_before/params_after e grafico de impacto Recharts.
- Validacao tecnica: comando cd frontend && npx tsc --noEmit passou sem erros.
- npm run lint nao executou verificacoes porque o projeto solicitou setup interativo do ESLint (sem configuracao .eslintrc).

### 2026-02-21 - codex (revalidacao)
- QA executado novamente com base no estado atual em Review.
- Task mantida como reprovada e devolvida para `in-progress` com as mesmas pendencias tecnicas abertas abaixo.

## Pendencias (QA)

1. ~~`tpa-form.tsx:80` — formulario nao exibe calculo automatico de percentual~~
   RESOLVIDO: adicionado calculo de volumePercent derivado de aquariumVolume via useAquariumStore. Exibe ex: "10.0% de 260L" abaixo do campo volume.
2. ~~`tpa-form.tsx:53` — submit nao envia params_before/params_after~~
   RESOLVIDO: adicionada secao expansivel "Registrar parametros antes/depois" com 7 parametros (NO3, PO4, KH, Ca, Mg, pH, temperature) com campos antes/depois. Submit envia params_before e params_after como Record<string, unknown>.
3. ~~`tpa-tab.tsx:47` — aba TPA nao renderiza grafico de impacto Recharts~~
   RESOLVIDO: criado componente TpaImpactChart com LineChart (NO3 antes/depois, PO4 antes/depois) + ReferenceLine vertical por data de TPA. Renderizado apenas quando ha TPAs com params_before.
