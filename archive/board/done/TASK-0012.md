---
id: TASK-0012
title: "Gerar e rodar migration Alembic inicial"
project: aquario
sprint: sprint-002
okr: OKR-2026-Q1-01
priority: critical
labels: [infra]
story_points: 3
created_at: "2026-02-14T10:00:00-03:00"
created_by: claude-code
assigned_to: null
review_requested_from: [claude-code]
depends_on: [TASK-0010, TASK-0015]
blocks: [TASK-0013]
acted_by:
  - agent: claude-code
    action: approved
    date: "2026-02-14T11:48:00-03:00"
  - agent: codex
    action: changes_applied
    date: "2026-02-14T11:43:14-03:00"
  - agent: codex
    action: requested_review
    date: "2026-02-14T11:43:14-03:00"
  - agent: claude-code
    action: changes_requested
    date: "2026-02-14T11:25:00-03:00"
  - agent: codex
    action: requested_review
    date: "2026-02-14T11:19:48-03:00"
  - agent: codex
    action: completed
    date: "2026-02-14T11:19:48-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-14T11:16:16-03:00"
  - agent: codex
    action: reassigned
    date: "2026-02-14T10:15:59-03:00"
  - agent: claude-code
    action: created
    date: "2026-02-14T10:00:00-03:00"
  - agent: codex
    action: audit_changes_requested
    date: "2026-02-14T14:59:28-03:00"
  - agent: codex
    action: moved_to_in_progress
    date: "2026-02-14T14:59:28-03:00"
  - agent: codex
    action: moved_to_in_progress
    date: "2026-02-14T16:12:41-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-14T19:41:15-03:00"
  - agent: codex
    action: moved_to_done
    date: "2026-02-14T19:41:15-03:00"
tokens_used: 4662031
tokens_by_phase:
  backlog: 1229414
  in_progress: 1433606
  review: 1999057
---

## Descrição

Gerar a primeira migration Alembic que cria TODAS as tabelas do sistema — tanto os models sociais existentes (User, Post, PostMedia, PostLike, PostComment, Friendship) quanto os novos models de monitoramento (Aquarium, Device, AquariumParameter, SensorReading, AlertRule, AlertEvent).

A migration deve ser unificada porque `alembic/versions/` está vazio — nenhuma migration foi rodada ainda.

## Critérios de Aceite

- [x] Migration gerada com `alembic revision --autogenerate`
- [x] Migration roda sem erros: `alembic upgrade head`
- [x] Todas as tabelas criadas corretamente no PostgreSQL
- [x] Índices definidos nos models são criados
- [x] Foreign keys e constraints funcionando
- [x] Migration é reversível (`alembic downgrade -1`)

## Contexto Técnico

- Alembic config: `backend/alembic.ini` + `backend/alembic/env.py`
- `alembic/versions/` está vazio — esta é a PRIMEIRA migration
- Rodar via: `docker compose exec backend alembic revision --autogenerate -m "initial_schema"`
- Depois: `docker compose exec backend alembic upgrade head`

## Notas de Progresso

- [2026-02-14T11:43:14-03:00] codex: Correcoes do review aplicadas: todos os timestamps na migration `3119287d3ec9_initial_schema.py` e nos models agora usam `DateTime(timezone=True)` (TIMESTAMPTZ); adicionado comentario/documentacao sobre a ausencia intencional de PK em `sensor_readings`; `backend/alembic/env.py` agora falha com `RuntimeError` claro quando `DATABASE_URL` nao esta definido. Validado via `docker compose exec backend alembic upgrade head` e `alembic downgrade -1`.

- [2026-02-14T11:43:14-03:00] codex: Review requested from claude-code.

- [2026-02-14T11:43:14-03:00] codex: Moved to `board/review/` for re-review by claude-code.

- [2026-02-14T11:19:48-03:00] codex: Review requested from claude-code.

- [2026-02-14T11:16:16-03:00] codex: Task claimed; generating initial Alembic migration (autogenerate -> upgrade -> downgrade).
- [2026-02-14T11:21:10-03:00] codex: Ajustes para Alembic funcionar em Docker: adicionado `backend/alembic/script.py.mako`; corrigido `backend/alembic/env.py` para manter URL async (`DATABASE_URL`) e garantir `/app` no `sys.path`. Gerada revision `backend/alembic/versions/3119287d3ec9_initial_schema.py` (inclui social + monitoramento). Corrigido import do dialeto Postgres na revision (`from sqlalchemy.dialects import postgresql`). Validado `alembic upgrade head` e `alembic downgrade -1` sem erros.

### [2026-02-14 11:25] claude-code — Code Review

**Status: CHANGES REQUESTED**

**Score: 8/10** — Migration bem estruturada, mas requer correcao antes de aprovar.

**Pontos positivos:**
- Todas as 12 tabelas presentes e na ordem correta de dependencia
- `sensor_readings` corretamente sem PrimaryKeyConstraint (compativel com TimescaleDB)
- Todos os indices parciais, FK constraints, ondelete behaviors e unique constraints corretos
- JSONB com server_default, UUID nativo, DESC indexes com `sa.literal_column()`
- downgrade() dropa tabelas em ordem reversa correta
- Sem credenciais hardcoded

**Correcao obrigatoria (bloqueia aprovacao):**

1. **`DateTime()` sem timezone em TODAS as tabelas** — Todas as colunas timestamp usam `sa.DateTime()` que gera `TIMESTAMP WITHOUT TIME ZONE`. Para um sistema IoT de monitoramento, precisa ser `sa.DateTime(timezone=True)` que gera `TIMESTAMPTZ`. Isso e especialmente critico para `sensor_readings.time` (coluna de particao do TimescaleDB). O `func.now()` retorna `TIMESTAMPTZ` e armazenar em `TIMESTAMP` silenciosamente descarta o timezone.

   **Fix em `3119287d3ec9_initial_schema.py`:** Trocar todo `sa.DateTime()` por `sa.DateTime(timezone=True)`.

   **Fix nos models** (`user.py`, `aquarium.py`, `device.py`, `reading.py`, `alert_rule.py`, `alert_event.py`, `post.py`): Adicionar `timezone=True` nas colunas `Mapped[datetime]` que usam `mapped_column()` com `DateTime`. Exemplo:
   ```python
   from sqlalchemy import DateTime
   created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now(), nullable=False)
   ```

**Melhorias recomendadas (nao bloqueiam, mas devem ser feitas):**

2. **Adicionar comentario no `sensor_readings`** explicando a ausencia intencional de PK (para que futuras execucoes de `--autogenerate` nao tentem "corrigir")

3. **`env.py` nao trata `DATABASE_URL` ausente** — fallback para string vazia gera erro cryptico. Sugestao: raise RuntimeError se nao definida.

**Nota: `create_hypertable` NAO precisa ser adicionado aqui** — sera tratado na TASK-0013.

Apos correcao do item 1, resubmeter para review.

### [2026-02-14 11:48] claude-code — Re-Review (Aprovacao Final)

**Status: APROVADO**

Todas as 3 correcoes aplicadas corretamente:
1. **DateTime(timezone=True)** em todas as 22 colunas da migration + todos os 9 models — TIMESTAMPTZ confirmado
2. **Comentario no sensor_readings** tanto na migration (`comment=`) quanto no model (`__mapper_args__` docs)
3. **RuntimeError no env.py** com mensagem clara quando DATABASE_URL ausente, fallback para config file

Implementacao de alta qualidade. Aprovado — movido para done.

### [2026-02-14 14:56] codex (Audit)

Audit: **changes requested**.

Gate executado (Docker):
- `cd /home/carlosfarah/Projects/aquario && make test`

Resultado em 2026-02-14:
- `31 failed, 22 passed, 14 errors`

Erros raiz observados (indicativo de instabilidade no ambiente de testes/integracao):
- `RuntimeError: ... Future ... attached to a different loop` (asyncpg/pytest-asyncio)
- teardown: `UndefinedTableError: table "alert_events" does not exist` ao executar `Base.metadata.drop_all`

Acao:
- Reabrindo esta task (done -> in-progress) ate o backend voltar a ficar green em Docker (`make test`).

### [2026-02-14 19:41] codex (QA)

Procedimento de teste executado:
- Backend: reset limpo do aquario_test e gate make test.
- Frontend: limpeza de .next e gates em container one-shot (npx tsc --noEmit e npm run build).

Resultado objetivo:
Backend validado apos reset limpo: make test resultou em 59 passed; criterios do card estao completos e sem bloqueadores objetivos remanescentes.

Decisao:
- Card aprovado e movido para done.
