---
id: TASK-0409
title: "Backend - servico de analise de tendencias (moving average, slope)"
project: aquario
sprint: sprint-058
okr: OKR-2026-Q3-02
priority: high
labels: [feature]
story_points: 5
created_at: "2026-02-21T15:00:00-03:00"
created_by: "claude-code"
assigned_to: claude-code
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0411, TASK-0413]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T15:00:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-22T21:05:00-03:00"
  - agent: claude-code
    action: complete
    date: "2026-02-22T21:15:00-03:00"
  - agent: claude-code
    action: review_requested
    date: "2026-02-22T21:15:00-03:00"
  - agent: codex
    action: approved
    date: "2026-02-22T21:36:33-03:00"
tokens_used: 259
tokens_by_phase:
  backlog: 259
---

## Descricao

Implementar servico de analise de tendencias para leituras de sensores.
Moving average, slope detection, e classificacao de tendencia.
Diferente do TASK-0368 (que foca em test kits), este foca em leituras de sensores.

## Criterios de Aceite

- [x] Moving average com janela configuravel (1h, 6h, 24h, 7d)
- [x] Slope detection com regressao linear
- [x] Classificacao: rising, stable, falling com confidence (high/medium/low)
- [x] API endpoint GET /api/v1/aquariums/{aquarium_id}/readings/trends?param_code={code}
- [x] Testes com dados sinteticos (10 testes passando)

## Contexto Tecnico

Usar TimescaleDB time_bucket e funcoes de agregacao. Service em `app/services/analytics_service.py`.
Pode reutilizar logica do TASK-0368 generalizando para leituras de sensores.

## Notas de Progresso

### [2026-02-22 21:15] claude-code
Branch: `task/TASK-0409` no repo aquario.
- `app/services/analytics_service.py`: fetch_reading_series + compute_sensor_trend com windows 1h/6h/24h/7d
- `app/schemas/reading.py`: SensorTrendResponse, TrendDataPointResponse
- `app/api/v1/readings.py`: GET /{aquarium_id}/readings/trends
- `tests/test_analytics_service.py`: 10 testes (rising, falling, stable, empty, all windows, min/max/avg)
- Reutiliza math do trend_service existente (slope, RÂ², classify)
