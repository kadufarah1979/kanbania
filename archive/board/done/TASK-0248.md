---
id: TASK-0248
title: "Backend: endpoint de health-check e metricas operacionais"
project: aquario
sprint: sprint-032
okr: OKR-2026-Q1-01
priority: medium
labels: [feature, backend, infra]
story_points: 3
created_at: "2026-02-19T22:30:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: []
depends_on: []
blocks: []
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-19T22:30:00-03:00"
  - agent: codex
    action: claimed
    date: "2026-02-19T11:32:47-03:00"
  - agent: codex
    action: move-to-review
    date: "2026-02-19T11:46:13-03:00"
  - agent: codex
    action: complete
    date: "2026-02-19T12:21:59-03:00"
tokens_used: 1809543
tokens_by_phase:
  in_progress: 1553663
---

## Descricao

Criar endpoint /api/v1/health que retorna status dos servicos dependentes (DB, MQTT broker, TimescaleDB) e metricas operacionais basicas. Util para monitoramento externo e para o frontend exibir status do sistema.

## Criterios de Aceite

- [x] GET /api/v1/health retorna status de cada dependencia (db, mqtt, timescale)
- [x] Resposta inclui uptime, versao da API e timestamp
- [x] Status code 200 se tudo ok, 503 se alguma dependencia falhar
- [x] Endpoint nao requer autenticacao
- [x] Testes para cenarios ok e degraded (min 4 testes)

## Contexto Tecnico

- Verificar conexao DB via SQLAlchemy async
- Verificar conexao MQTT via client ping
- Tempo de resposta < 500ms

## Notas de Progresso

### [2026-02-19T11:46:13-03:00] codex
Implementacao concluida do endpoint operacional de health-check:
- Adicionado `GET /api/v1/health` sem autenticacao com status de dependencias `db`, `mqtt`, `timescale`.
- Resposta inclui `uptime_seconds`, `api_version`, `timestamp`, `metrics` e status de tarefas de background.
- HTTP status: `200` quando saudavel, `503` quando qualquer dependencia retorna `error`.
- Integracao no app: novo router `backend/app/api/v1/health.py` registrado em `backend/app/main.py`.
- Testes adicionados: `backend/tests/test_health_api.py` cobrindo cenario ok e 3 cenarios degraded (db, mqtt, timescale).
- Evidencias:
  - `docker compose exec -T backend pytest -q tests/test_health_api.py tests/test_smoke.py` => 8 passed.

### [2026-02-19T12:21:59-03:00] codex
QA gate executado para fechamento Review -> Done.
- Evidencia: docker compose exec -T backend pytest -q tests/test_health_api.py tests/test_smoke.py => 8 passed.
- Criterios de aceite validados para `/api/v1/health` (dependencias, metrica operacional, status 200/503 e endpoint publico).
