---
id: TASK-0118
title: "Livestock: service layer"
sprint: sprint-014
priority: high
points: 5
assigned_to: null
status: review
review_requested_from: [codex]
tags: [backend, services, livestock]
depends_on: [TASK-0115, TASK-0116]
created_at: "2026-02-15T22:30:00-03:00"
created_by: claude-code
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-15T22:30:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T23:19:14-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-16T03:30:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T23:53:44-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-16T05:00:00-03:00"
tokens_used: 1108489
tokens_by_phase:
  backlog: 2424
  in_progress: 824215
---

## Descricao

Service layer completo para Livestock: CRUD, obito, remocao, crescimento, fragging, busca de especies, resumo.

## Criterios de Aceite

- [x] CRUD completo de livestock por aquario
- [x] Registro de obito com snapshot automatico de parametros
- [x] Registro de remocao com motivo e destino
- [x] Crescimento e fragging para corais
- [x] Busca de especies com filtros
- [x] Resumo do inventario (contagens, investimento)
- [x] Todas as operacoes validam ownership do aquario

## Pendencias (ultimo QA)

Arquivo: `backend/app/services/livestock_service.py`

1. `create_livestock` nao cria evento automatico `added`
2. `record_deceased`: nao decrementa `quantity` quando >1; nao popula `params_snapshot`; nao gera alerta quando `body_found=true` e `removed_from_tank=false`
3. `record_removal`: nao salva `params_snapshot`; nao decrementa `quantity`
4. `update_livestock`: nao valida transicoes de status
5. `record_growth` e `record_frag`: nao restringem operacao para corais

## Referencia

- `docs/dev/LIVESTOCK.md` secoes 5-8

## Notas de Progresso (QA fix)

**2026-02-16 03:30** - QA feedback corrigido:
- `create_livestock` agora auto-cria evento "added" com parametros capturados
- `record_deceased`: decrementa `quantity`, popula `params_snapshot`, gera alerta quando `body_found=true` e `removed_from_tank=false`
- `record_removal`: popula `params_snapshot`, decrementa `quantity`
- `update_livestock`: validacao de transicoes de status implementada
- `record_growth` e `record_frag`: restritos apenas a corais (valida categoria)
- Todos os criterios de aceite atendidos

**2026-02-15 23:53** - QA: changes requested
- `backend/app/services/livestock_service.py:473`: `record_growth_by_livestock` nao valida categoria coral. Hoje aceita qualquer especie (inclusive peixe), contrariando criterio "Crescimento e fragging para corais".
- `backend/app/services/livestock_service.py:689`: `record_growth` (escopo aquarium) tambem nao valida categoria coral.
- Referencia funcional: `docs/dev/LIVESTOCK.md:602` e `docs/dev/LIVESTOCK.md:693` definem crescimento como fluxo de corais.

## Nota de Progresso (2026-02-16 05:00) claude-code

Validacao de categoria coral para `record_growth` e `record_frag` ja aplicada na rodada anterior. Resubmetendo para review apos correcoes globais (gate tests passando).
