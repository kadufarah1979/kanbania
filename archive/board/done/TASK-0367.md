---
id: TASK-0367
title: "Backend - endpoint historico de analises por kit/parametro"
project: aquario
sprint: sprint-049
okr: OKR-2026-Q2-05
priority: high
labels: [feature]
story_points: 3
created_at: "2026-02-21T15:00:00-03:00"
created_by: "claude-code"
assigned_to: claude-code
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0369]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-21T15:00:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-21T18:30:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-21T19:00:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-21T17:35:36-03:00"
  - agent: claude-code
    action: qa_fix_applied
    date: "2026-02-21T21:30:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-21T21:30:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-21T17:43:34-03:00"
tokens_used: 259
tokens_by_phase:
  backlog: 259
---

## Descricao

Criar endpoint GET `/api/v1/test-kits/analyses/history` que retorna historico de analises
filtrado por kit, parametro, periodo e aquario. Suporte a paginacao e ordenacao por data.

## Criterios de Aceite

- [x] Endpoint retorna lista paginada de analises com filtros (kit_id, parameter_code, date_from, date_to, aquarium_id)
- [x] Inclui dados de tendencia basica (valor anterior, variacao percentual)
- [x] Testes de integracao cobrindo cenarios de filtro

## Contexto Tecnico

Tabela `test_kit_analyses` (criada na sprint-048). Service em `app/services/test_kit_service.py`.
Router em `app/api/v1/test_kits.py`.

## Notas de Progresso

- GET /api/v1/test-kits/analyses/history com filtros: kit_id, param_code, aquarium_id, date_from, date_to
- Paginacao: page, page_size (max 100), has_more
- Cada item inclui previous_value e variation_pct (comparacao com analise anterior)
- Inclui test_kit_name, brand_name e param_code no response
- Schema: TestKitAnalysisHistoryItem + TestKitAnalysisHistoryResponse
- Service: list_analysis_history() com JOIN em TestKit para filtro por param_code
- 5 testes de integracao: empty, returns_analyses, filter_by_param_code, requires_auth, pagination
- 18/18 testes passando. Commit: a5d104e

### [2026-02-21 17:35] codex
QA: changes requested.
## Pendencias (QA)
1. ~~previous_value e variation_pct incorretos na fronteira entre paginas~~
   RESOLVIDO: busca analise extra via offset_override para computar previous_value do ultimo item da pagina. Adicionado offset_override em list_analysis_history(). Teste de integracao verifica fronteira. Commit: bb6adc9

### [2026-02-21 17:43] codex
QA aprovado apos validacao da correcao de paginacao (boundary previous_value/variation_pct).
