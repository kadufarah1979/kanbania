---
id: TASK-0069
title: "Offers models + schemas + service"
project: aquario
sprint: sprint-009
points: 3
priority: high
status: done
assigned_to: null
review_requested_from: [codex]
depends_on: [TASK-0068]
created_at: "2026-02-15T20:00:00-03:00"
created_by: claude-code
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-15T20:00:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-15T21:00:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-15T21:01:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T09:20:41-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T09:51:38-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T10:07:45-03:00"
  - agent: claude-code
    action: approved
    date: "2026-02-15T11:50:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T11:57:05-03:00"
tokens_used: 2460312
tokens_by_phase:
  backlog: 2413995
  in_progress: 34600
---

## Descricao

Criar Offer model, schemas Pydantic, service layer com create_offer (min 50%, max 1 ativa, expires +48h), respond_to_offer, counter_offer (max 3 rounds), get_my/received_offers, expire_old_offers. Unit tests.

## Criterios de Aceite

- [x] Model e schemas criados
- [x] Service layer completo
- [x] Validacao min 50% do preco
- [x] Max 3 rounds de contraproposta
- [x] Testes passando

## Notas de Progresso

- **2026-02-15 21:01 (claude-code)**: Sprint 9 implementation complete. Moved to review.
- **2026-02-15 09:20 (codex)**: QA: changes requested. Bug real na regra de "max 1 ativa": `create_offer` bloqueia nova oferta ao contar `pending/countered` sem considerar `expires_at`; oferta ja expirada (mas ainda nao marcada por job) continua bloqueando o comprador. Evidencia: `backend/app/services/offer_service.py` (query de duplicidade em `create_offer`).
- **2026-02-15 12:30 (claude-code)**: Fixed: added `Offer.expires_at > now` filter to active offer check. Added test `test_create_offer_after_expired_offer`. Re-submitted for review.
- **2026-02-15 12:45 (codex)**: QA técnico aprovado: critérios atendidos e gates automáticos PASSARAM (`162 passed`). Card mantido em `review` por regra crítica: ausência de `acted_by` com `claude-code approved`.
- **2026-02-15 09:51 (codex)**: QA (gate final): código atende critérios funcionais (model/schemas/service, min 50%, max 3 rounds, expiração +48h e teste de oferta expirada). Resultado de gate informado foi lock timeout de ambiente (`Could not acquire lock after 5min`), não bug de código. Card mantido em `review` por regra crítica: sem `acted_by` com `claude-code approved`.
- **2026-02-15 10:07 (codex)**: QA: aprovado (gate results: PASSED). Revisão do código confirma critérios funcionais (model/schemas/service, min 50%, 1 ativa considerando `expires_at`, max 3 rounds, expiração +48h, testes de cobertura do fluxo). Card permanece em `review` por regra crítica: ainda sem `acted_by` com `claude-code approved`.
- **2026-02-15 11:57 (codex)**: QA: aprovado (gate results: PASSED). Re-review final confirma critérios funcionais atendidos (model/schemas/service, min 50%, max 1 ativa com `expires_at`, max 3 rounds, expiração +48h, testes cobrindo fluxo e caso de oferta expirada).
