---
id: TASK-0222
title: "Backend: galeria de fotos do aquario com snapshot de parametros"
project: aquario
sprint: sprint-027
okr: OKR-2026-Q1-01
priority: medium
labels: [backend, feature, gallery]
story_points: 5
created_at: "2026-02-18T23:50:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0223]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-18T23:50:00-03:00"
  - agent: claude-code
    action: move
    date: "2026-02-18T00:00:00-03:00"
  - agent: codex
    action: update
    date: "2026-02-18T18:28:32-03:00"
  - agent: codex
    action: comment
    date: "2026-02-18T18:51:25-03:00"
  - agent: codex
    action: complete
    date: "2026-02-18T18:53:56-03:00"
tokens_used: 1555483
tokens_by_phase:
  backlog: 68202
---

## Descricao

Implementar backend de galeria de fotos por aquario conforme doc `docs/dev/AQUARIUM_GALLERY.md`. Cada foto e associada a um snapshot dos parametros da agua no momento do upload.

## Criterios de Aceite

- [x] Model AquariumPhoto (id, aquarium_id, user_id, image_url, caption, tags, parameter_snapshot JSONB, created_at)
- [x] Upload de imagem para DigitalOcean Spaces (S3-compatible) com presigned URL
- [x] Ao salvar foto, capturar automaticamente leituras mais recentes do aquario como snapshot
- [x] Endpoints: POST /aquariums/{id}/photos (upload), GET /aquariums/{id}/photos (listagem paginada), DELETE /aquariums/{id}/photos/{photo_id}
- [x] Migration Alembic gerada
- [x] Testes unitarios (minimo 5)

## Contexto Tecnico

Backend: `/home/carlosfarah/Projects/aquario/backend/`
Doc: `docs/dev/AQUARIUM_GALLERY.md`
Usar boto3 para upload ao Spaces. Env vars: SPACES_BUCKET, SPACES_REGION, SPACES_KEY, SPACES_SECRET.

## Notas de Progresso

### [2026-02-18 23:50] claude-code
Card criado para backend de galeria.

### [2026-02-18 18:51] codex
Checklist de QA realizado por inspeção técnica:
- Modelo confirmado: `aquarium_photos` com `parameter_snapshot`.
- Rotas confirmadas: POST/GET/DELETE em `/aquariums/{id}/photos`.
- Migração confirmada: `5a6b7c8d9e0f_add_aquarium_photos.py`.
- Serviço com integração Spaces (S3-compatible) e captura de snapshot de parâmetros.
- Cobertura de testes existente: 7 testes em `backend/tests/test_aquarium_photos.py` (>= 5), incluindo snapshot.
- Verificação de sintaxe do backend: `python -m compileall -q app` OK.

Limite do ambiente nesta sessão:
- Não foi possível executar `pytest` porque não está instalado na `.venv`.
- Instalação de dependências de teste falhou por indisponibilidade de rede (sem acesso ao índice do pip).

Gate de review:
- Aprovado para `done` com ressalva operacional registrada acima.
