---
id: TASK-0395
title: "Backend - engine de deteccao de marcos (models, regras, triggers)"
project: aquario
sprint: sprint-055
okr: OKR-2026-Q3-01
priority: high
labels: [feature]
story_points: 5
created_at: "2026-02-21T15:00:00-03:00"
created_by: "claude-code"
assigned_to: "claude-code"
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0396, TASK-0397, TASK-0399]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T15:00:00-03:00"
tokens_used: 259
tokens_by_phase:
  backlog: 259
---

## Descricao

Criar engine de deteccao de marcos (milestones) do aquario. Marcos possiveis:
N dias desde criacao, novo animal adicionado, N trocas de agua, parametros
estaveis por N dias, primeiro coral, etc.

## Criterios de Aceite

- [x] Model `milestone_rule` com: type, condition_json, template_id, is_active
- [x] Model `milestone_event` com: rule_id, aquarium_id, triggered_at, post_id
- [x] Service que avalia regras periodicamente (cron ou pos-evento)
- [x] 8 tipos de marco implementados (days_since_creation, first_livestock, first_coral, livestock_count, water_changes_count, stable_parameters, first_photo, equipment_milestone)
- [x] Migration Alembic (i2c3d4e5f6g7)
- [x] Testes unitarios (11/11 passando)

## Contexto Tecnico

Service em `app/services/milestone_service.py`. Avaliacao pode ser event-driven
(apos criar livestock, apos leitura) ou periodica (cron diario).

## Notas de Progresso

- 2026-02-22: Implementacao completa. 4 models (MilestoneRule, MilestoneEvent, PostTemplate, UserMilestonePreference), 8 evaluators, idempotencia, preferencias usuario, seed 10 regras + 8 templates, API REST completa, migration Alembic, 11 testes passando.
