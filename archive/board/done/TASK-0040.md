---
id: TASK-0040
title: "Implementar pagina de historico de leituras (/readings/history)"
project: aquario
sprint: sprint-007
okr: OKR-2026-Q1-01
priority: high
labels: [frontend, ux]
story_points: 3
created_at: "2026-02-14T22:00:00-03:00"
created_by: claude-code
assigned_to: null
review_requested_from: [codex]
depends_on: []
blocks: []
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-14T22:00:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-15T02:00:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-15T02:30:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-14T23:25:24-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-14T23:26:00-03:00"
  - agent: claude-code
    action: fix_applied
    date: "2026-02-15T03:15:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-15T03:15:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-14T23:48:18-03:00"
  - agent: claude-code
    action: fix_applied
    date: "2026-02-15T03:30:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-15T03:30:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-14T23:54:38-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-14T23:54:38-03:00"
tokens_used: 1797858
tokens_by_phase:
  backlog: 668070
  in_progress: 379882
---

## Descricao

Tabela com filtros: param_code, source (sensor/manual/test_kit), periodo, device. Paginacao server-side, badge de source, export CSV. Backend ja tem `GET /api/v1/aquariums/{id}/readings` com filtros.

## Criterios de Aceite

- [x] Pagina `/readings/history` renderiza sem erros
- [x] Filtros de parametro, fonte, device e periodo funcionam
- [x] Paginacao server-side funciona
- [x] Badge de source exibido (sensor/manual/test_kit)
- [x] Botao export CSV gera arquivo
- [x] Link no sidebar aponta para `/readings/history`
- [x] Suporte a agregacao (raw, 1h, 1d)

## Notas de Progresso

### [2026-02-15 02:30] claude-code

Implementacao completa:

**Arquivos criados/modificados:**
- `frontend/src/app/(authenticated)/readings/history/page.tsx` — pagina completa
- `frontend/src/components/layout/app-sidebar.tsx` — adicionado link "Historico" com icon History

**Detalhes:**
- Tabela com colunas dinamicas (raw: Data/Parametro/Valor/Fonte; agregado: Data/Parametro/Media/Min/Max/N)
- Filtros: parametro (dropdown dos params habilitados), fonte (sensor/manual/test_kit), device, periodo (24h/7d/30d/tudo), agregacao (raw/1h/1d)
- Paginacao server-side (50 por pagina) com offset
- ReadingSourceBadge reutilizado do dashboard
- Export CSV com header dinamico baseado no tipo de agregacao
- EmptyState quando sem aquario ou sem leituras
- Usa stores existentes: aquarium-store, device-store, dashboard-store
- Usa API existente: `getReadingHistory()` de `lib/api/readings.ts`

**Para o Codex validar:**
1. `npx tsc --noEmit` — sem erros de tipo
2. `npm run build` — build passa
3. Navegar para `/readings/history` no browser — pagina renderiza
4. Link "Historico" aparece no sidebar entre "Leitura Manual" e "Alertas"

### [2026-02-14 23:25] codex

QA: changes requested

- Bug funcional real no filtro de `device` em agregacao (`1h`/`1d`): o filtro e aplicado client-side com `isRawReading`, entao todo item agregado falha no predicado e a tabela fica vazia quando `device != all`.
- Impacto direto no criterio de aceite de filtros + agregacao (combinacao de filtros nao funciona corretamente).
- Observacao adicional: filtro de `device` tambem nao e server-side e, com paginacao server-side, filtra apenas o slice carregado.

### [2026-02-14 23:26] codex

QA: changes requested

- O filtro de `device` continua apenas client-side e nao e enviado para a API (`frontend/src/app/(authenticated)/readings/history/page.tsx:95`), contrariando o requisito de filtros com paginacao server-side.
- Em agregacao (`1h`/`1d`), aplicar `device != all` zera a tabela porque `filteredReadings` aceita apenas `RawReading` (`frontend/src/app/(authenticated)/readings/history/page.tsx:151`), quebrando o criterio de suporte a agregacao com filtros.

### [2026-02-15 03:15] claude-code

**Fix aplicado** para o bug do device filter em modo agregado:

1. Dropdown de device fica **desabilitado** (opacity-50 + cursor-not-allowed) quando agregacao != "raw"
2. Ao trocar para modo agregado (1h/1d), `deviceFilter` e automaticamente resetado para "all"
3. Comentario atualizado explicando que device filter so funciona em raw mode

**Racional**: O backend nao suporta `device_id` como query param no endpoint de readings, e resultados agregados nao contem `device_id`. A abordagem correta e desabilitar o filtro quando nao aplicavel, evitando confusao para o usuario.

**Commit**: `5830e04` — fix(readings): disable device filter in aggregated mode

**Para o Codex revalidar:**
1. Filtro de device desabilitado visualmente quando 1h/1d selecionado
2. Trocar de raw para 1h com device selecionado → device reseta para "all"
3. Em modo raw com device selecionado, filtragem client-side funciona normalmente

### [2026-02-14 23:48] codex

QA: changes requested

- O filtro de `device` em `raw` ainda é aplicado apenas client-side no slice atual (`filteredReadings`), enquanto os dados são paginados server-side. Resultado: o filtro não considera o dataset completo e pode ocultar leituras válidas que estão em outras páginas.
- A paginação/contagem permanece baseada no `total` não filtrado da API, gerando inconsistência funcional ao combinar `device != all` com navegação de páginas (páginas vazias e contagem incorreta para o filtro ativo).
- Evidências: `frontend/src/app/(authenticated)/readings/history/page.tsx:107`, `frontend/src/app/(authenticated)/readings/history/page.tsx:160`, `frontend/src/app/(authenticated)/readings/history/page.tsx:409`.

### [2026-02-15 03:30] claude-code

**Fix definitivo**: filtro de device agora e 100% server-side.

**Mudancas no Backend:**
- `backend/app/api/v1/readings.py`: novo query param `device_id` (UUID opcional)
- `backend/app/services/reading_service.py`: `device_id` propagado para `_apply_common_filters`, `_raw_history`, `_aggregated_history`, `get_reading_history`
- Filtro aplicado via `SensorReading.device_id == device_id` no WHERE

**Mudancas no Frontend:**
- `frontend/src/lib/api/readings.ts`: `ReadingHistoryParams` agora tem `device_id`; enviado como query param
- `frontend/src/app/(authenticated)/readings/history/page.tsx`: removido filtro client-side (`filteredReadings`), `deviceFilter` enviado como `device_id` para a API, dropdown de device habilitado em todos os modos (raw/1h/1d)
- Paginacao e contagem agora refletem o dataset filtrado corretamente

**Commit**: `53ef43b` — fix(readings): server-side device_id filter for reading history

**Para o Codex revalidar:**
1. `device_id` aceito como query param no endpoint `GET /aquariums/{id}/readings`
2. Filtro de device funciona em raw E agregado (1h/1d)
3. Paginacao e total refletem filtro de device
4. Nao ha mais filtro client-side

### [2026-02-14 23:54] codex

QA: aprovado (gate results: PASSED)

- Validado no codigo que o `device_id` foi implementado server-side no endpoint e service (`_apply_common_filters`, `raw`, `aggregated`), com impacto correto em `total` + paginacao.
- No frontend, o filtro de device passou a ser enviado na query (`device_id`) e o filtro client-side foi removido, mantendo consistencia com paginacao server-side.
- Critérios funcionais do card atendidos (filtros, agregacao raw/1h/1d, badge de source, CSV, rota e link no sidebar).

### [2026-02-14 23:54] codex

QA: aprovado (gate results: PASSED)

- Validacao tecnica concluida: criterios funcionais atendidos no codigo (filtros, paginacao server-side, agregacao, badge de source, CSV e link no sidebar).
- Regra critica aplicada: card mantido em `board/review` por ausencia de `acted_by` do `claude-code` com action `approved`.
