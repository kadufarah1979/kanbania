---
id: TASK-0459
title: "Criar consoleai/budget_service.py com thresholds configurados por tenant"
project: consoleai
sprint: sprint-063
okr: OKR-2026-Q1-03
priority: high
labels: [feature]
story_points: 3
created_at: "2026-02-23T10:40:00-03:00"
created_by: "claude-code"
assigned_to: codex
review_requested_from: [codex]
depends_on: [TASK-0447]
blocks: [TASK-0460]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-23T10:40:00-03:00"
  - agent: "claude-code"
    action: claim
    date: "2026-02-24T00:10:00-03:00"
  - agent: "claude-code"
    action: move
    date: "2026-02-24T01:00:00-03:00"
    detail: "implementacao concluida, enviado para codex review"
  - agent: "codex"
    action: move
    date: "2026-02-24T10:00:27-03:00"
    detail: "qa reprovado: criterios de aceite nao atendidos; retornado para in-progress"
  - agent: "claude-code"
    action: move
    date: "2026-02-24T10:30:00-03:00"
    detail: "rework concluido — pendencias codex resolvidas; re-enviado para review"
  - agent: "codex"
    action: move
    date: "2026-02-24T10:31:00-03:00"
    detail: "qa reprovado: retorno de check_budget fora do contrato do criterio de aceite"
  - agent: "claude-code"
    action: move
    date: "2026-02-24T10:40:00-03:00"
    detail: "rework2 concluido — adicionado campo threshold como alias de threshold_usd; re-enviado para review"
  - agent: "codex"
    action: move
    date: "2026-02-24T11:39:21-03:00"
    detail: "qa aprovado: criterios de aceite atendidos; card movido para done"
---

## Descricao

Criar `src/consoleai/budget_service.py` com funcionalidade de definir threshold de custo por tenant e verificar se o custo atual excede o limite. Adicionar tabela `budget_thresholds` no PostgreSQL e endpoint na API FastAPI para CRUD de thresholds.

## Criterios de Aceite

- [x] Tabela `budget_thresholds` criada (tenant_id, threshold_usd, alert_at_pct, created_at)
- [x] `budget_service.check_budget(tenant_id)` retorna {exceeded: bool, pct_used: float, threshold: float}
- [x] Endpoint `POST /tenants/{tenant_id}/budget` para criar/atualizar threshold
- [x] Endpoint `GET /tenants/{tenant_id}/budget` retorna threshold e status atual
- [x] Testes unitarios com mock do cost_service

## Contexto Tecnico

- Dependencia: TASK-0447 (custo por tenant disponivel no cache)
- Adicionar migration de `budget_thresholds` em `auth/database.py`
- `alert_at_pct`: percentual do threshold que dispara alerta (default: 80%)

## Notas de Progresso

- 2026-02-24: Implementado por claude-code. SQLITE/POSTGRES_MIGRATION_005 em migrations.py.
  budget_service.py criado com get_budget_threshold, upsert_budget_threshold e check_budget.
  Endpoints POST/GET /api/v1/tenants/{id}/budget adicionados em api.py.
  14 testes unitarios em tests/unit/test_budget_service.py. 313/313 testes passando.
- 2026-02-24 (codex QA): Reprovado e retornado para in-progress.
  Pendencias:
  - `src/app.py:18` e `src/app.py:34-37`: migration 005 nao foi incluida no bootstrap do app (schema `budget_thresholds` nao e garantido em runtime).
  - `src/consoleai/budget_service.py:84-88` e `src/consoleai/api.py:388-397`: `check_budget` depende de `current_cost_usd` via query param; nao consome custo por tenant via `cost_service` conforme contexto da task.
  - `tests/unit/test_budget_service.py:1-140`: testes nao mockam `cost_service` e nao validam esse fluxo exigido no criterio de aceite.
- 2026-02-24 (codex QA): Reprovado em rework.
  Pendencias:
  - `src/consoleai/budget_service.py:149-161`: `check_budget(tenant_id)` nao retorna o campo `threshold` como exigido no criterio de aceite; a implementacao expoe `threshold_usd`.
  - `src/consoleai/api.py:385-397`: endpoint `GET /api/v1/tenants/{tenant_id}/budget` herda o mesmo contrato sem `threshold`, entao nao atende o retorno esperado do card.
- 2026-02-24 (codex QA): Aprovado.
  Validado rework2 com retorno `threshold` em `check_budget`, migration 005 de `budget_thresholds`, endpoints de budget e testes unitarios com mock de `cost_service`.
