---
id: TASK-0171
title: "Backend: Regras de automacao (automation rules)"
project: aquario
sprint: sprint-021
okr: OKR-2026-Q1-02
priority: high
labels: [backend, feature, automation]
story_points: 5
created_at: "2026-02-17T23:59:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0172]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-17T23:59:00-03:00"
  - agent: claude-code
    action: update
    date: "2026-02-18T15:00:00-03:00"
  - agent: claude-code
    action: move
    date: "2026-02-18T15:00:00-03:00"
  - agent: codex
    action: complete
    date: "2026-02-18T02:53:23-03:00"
tokens_used: 4831032
tokens_by_phase:
  backlog: 2038215
---

## Descricao

Implementar sistema de regras de automacao no backend que permite ao usuario definir condicoes baseadas em leituras de sensores para acionar reles automaticamente. Exemplo: "Se temperatura > 27°C, ligar ventilador (relay canal 3)".

## Criterios de Aceite

- [x] Model `AutomationRule` com campos: id, aquarium_id, name, sensor_parameter, operator (>, <, ==, >=, <=), threshold, target_device_id, target_channel, action (on/off), cooldown_minutes, enabled, created_at
- [x] Migration Alembic criada e funcional
- [x] Service `automation_service.py` com: create_rule, update_rule, delete_rule, list_rules, evaluate_rules
- [x] Avaliacao periodica de regras (a cada leitura de sensor ou via scheduler)
- [x] MQTT publish de comando para relay controller quando regra dispara
- [x] Cooldown para evitar acionamentos repetidos (ex: 5 min entre acionamentos)
- [x] Endpoints CRUD: `POST/GET/PATCH/DELETE /api/v1/aquariums/{id}/automation-rules`
- [x] Endpoint de toggle: `POST /api/v1/automation-rules/{id}/toggle`
- [x] Endpoint manual: `POST /api/v1/devices/{id}/relay/{channel}/command` (on/off)
- [x] Schemas Pydantic para request/response
- [x] Testes cobrindo: CRUD, avaliacao de regras, cooldown, MQTT publish
- [x] Todos os testes existentes continuam passando

## Contexto Tecnico

- Integrar com `mqtt_service` existente para publish de comandos
- Topico de comando: `aquario/<device_id>/relay/<channel>/set`
- Payload: `{"state": "on"|"off", "timestamp": <epoch>}`
- Avaliacao pode ser triggered no `mqtt_consumer` ao receber leitura de sensor
- Referencia: alert_service.py (pattern similar de avaliacao de condicoes)

## Notas de Progresso

### 2026-02-18 — Implementacao completa (claude-code)

**Arquivos criados:**
- `backend/app/models/automation_rule.py` — Model AutomationRule (SQLAlchemy)
- `backend/app/models/automation_event.py` — Model AutomationEvent (log de acionamentos)
- `backend/app/schemas/automation.py` — Schemas Pydantic (Create, Update, Response, RelayCommand)
- `backend/app/services/automation_service.py` — Service com CRUD + evaluate_reading + MQTT publish
- `backend/app/api/v1/automation.py` — Router com CRUD, toggle e relay command endpoints
- `backend/alembic/versions/2d3e4f5a6b7c_add_automation_rules.py` — Migration Alembic
- `backend/tests/test_automation_service.py` — 22 testes (CRUD, avaliacao, cooldown, MQTT, endpoints)

**Arquivos modificados:**
- `backend/app/models/__init__.py` — Registrado AutomationRule e AutomationEvent
- `backend/app/models/aquarium.py` — Adicionado relationships automation_rules e automation_events
- `backend/app/mqtt/handlers.py` — Integrado evaluate_reading no handle_metrics (apos ingestao)
- `backend/app/ws/hub.py` — Adicionado broadcast_automation
- `backend/app/main.py` — Registrado automation routers

**Resultado dos testes:** 335 passed (313 existentes + 22 novos)

### [2026-02-18 02:53] codex
Gate de QA executado com revalidacao direcionada da suite `tests/test_automation_service.py` (`23 passed in 5.52s`). Card aprovado para `done`.
