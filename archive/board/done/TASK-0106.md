---
id: TASK-0106
title: "Regression: alerts (rules, events, acknowledge)"
project: aquario
sprint: sprint-012
points: 2
priority: high
status: review
assigned_to: null
review_requested_from: [codex]
depends_on: [TASK-0101]
created_at: "2026-02-15T16:00:00-03:00"
created_by: claude-code
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-15T16:00:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-15T15:48:53-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-15T16:26:37-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T16:32:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-15T16:55:04-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T18:51:30-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T19:02:43-03:00"
tokens_used: 930091
tokens_by_phase:
  in_progress: 25339
---

## Descricao

Validar sistema de alertas: CRUD de regras, disparo de eventos, cooldown, acknowledge, notificacoes.

## Criterios de Aceite

- [x] CRUD de alert rules funcional (create, list, get, update, delete)
- [x] Leitura acima do threshold dispara alerta
- [x] Cooldown previne alertas duplicados
- [x] GET /api/v1/alerts/active retorna alertas nao-acknowledged
- [x] POST /api/v1/alerts/{id}/acknowledge marca como visto
- [x] Regra inativa nao dispara alertas
- [x] Testes test_alert_flow.py (9 tests) e test_alert_service.py (6 tests) passam
- [x] Testes test_notification_service.py passam (8 tests)

## Notas de Progresso

- [2026-02-15T16:30:00-03:00] Alerts regression OK: 32/32 tests pass (9 alert flow + 7 alert service + 8 alert rules + 8 notification). CRUD, threshold triggers, cooldown, acknowledge, active alerts, notifications all working.
- [2026-02-15T16:32:00-03:00] QA: changes requested â€” `POST /api/v1/aquariums/{aquarium_id}/alerts/{event_id}/acknowledge` pode reconhecer um `AlertEvent` de outro aquario: `backend/app/api/v1/alerts.py` valida ownership do `aquarium_id` da URL, mas `backend/app/services/alert_service.py:acknowledge_alert()` busca apenas por `event_id` (sem filtrar por `aquarium_id`). Isso permite ack cross-aquarium e ainda faz broadcast no aquario errado. Corrigir scoping (query `WHERE id=:event_id AND aquarium_id=:aquarium_id`, ou validar antes de persistir).
- [2026-02-15T18:51:30-03:00] QA: aprovado. Revalidado fix do bug real de escopo: `acknowledge_alert` agora filtra por `event_id` + `aquarium_id` em `backend/app/services/alert_service.py:198` e a rota passa `aquarium_id` em `backend/app/api/v1/alerts.py:279`, impedindo acknowledge cross-aquarium e broadcast incorreto. Gate pre-review nao executou por lock timeout de ambiente ("Could not acquire lock after 5min"), ignorado conforme politica. Card mantido em `review` por regra critica: ausencia de `acted_by` com `agent: claude-code` e `action: approved`.
- [2026-02-15T19:02:43-03:00] QA: aprovado (gate results: PASSED). Revalidacao final confirma criterios atendidos: CRUD de regras, trigger por threshold, cooldown, `GET /alerts/active`, `POST /alerts/{id}/acknowledge` com escopo por aquario e notificacoes.
