---
id: TASK-0273
title: "Criar models e migration para filter_media_types e aquarium_filter_media"
project: aquario
sprint: sprint-037
okr: null
priority: critical
labels: [feature, infra]
story_points: 5
created_at: "2026-02-20T18:30:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0274, TASK-0275, TASK-0276]
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-20T18:30:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-20T19:00:00-03:00"
  - agent: claude-code
    action: move
    date: "2026-02-20T19:15:00-03:00"
  - agent: codex
    action: qa
    date: "2026-02-20T15:56:55-03:00"
tokens_used: 460568
tokens_by_phase:
  todo: 6592
  review: 143995
---

## Descricao

Criar os models SQLAlchemy e a migration Alembic para o sistema de midias filtrantes do sump, conforme spec em `docs/dev/MAINTENANCE_AND_ROUTINES.md` secao 3.

Tres tabelas:
1. `filter_media_types` — catalogo de tipos de midia (mecanica, quimica, biologica) com ciclos padrao
2. `aquarium_filter_media` — instancias de midia instaladas em cada aquario com ciclos personalizaveis e datas de proxima acao
3. `filter_media_log` — historico de acoes (limpeza, troca, enxague, adicao, aposentadoria) com custo e snapshot de parametros

## Criterios de Aceite

- [x] Model `FilterMediaType` com campos: code, name_pt, name_en, category (mechanical/chemical/biological), icon, default_replace_days, default_clean_days, default_rinse_days, affects_params (JSONB), applicable_to, sort_order, is_active
- [x] Model `AquariumFilterMedia` com campos: aquarium_id, media_type_id, name, brand, model, compartment, quantity, installed_at, last_cleaned_at, last_rinsed_at, last_replaced_at, replace/clean/rinse_interval_days (override), next_clean_at, next_rinse_at, next_replace_at, status (active/needs_cleaning/needs_replacement/retired), notes
- [x] Model `FilterMediaLog` com campos: media_id, user_id, action (cleaned/rinsed/replaced/added/retired), notes, cost, params_snapshot (JSONB), performed_at
- [x] Migration Alembic gerada e aplicavel com `alembic upgrade head`
- [x] Indices em aquarium_id+status e media_id+performed_at
- [x] Models registrados em `models/__init__.py`

## Contexto Tecnico

- Spec: `docs/dev/MAINTENANCE_AND_ROUTINES.md` secoes 3.1-3.2
- Models existentes de referencia: `backend/app/models/water_change.py`, `backend/app/models/maintenance_log.py`
- Usar tenant_id e aquarium_id como filtros obrigatorios (padrao do projeto)
- Relacao: AquariumFilterMedia -> FilterMediaType (FK), FilterMediaLog -> AquariumFilterMedia (FK, CASCADE)

## Notas de Progresso

### [2026-02-20 19:15] claude-code
Implementacao concluida:
- `backend/app/models/filter_media.py`: 3 models (FilterMediaType, AquariumFilterMedia, FilterMediaLog)
- `backend/app/models/__init__.py`: imports adicionados
- `backend/alembic/versions/5c55b4e5be25_add_filter_media_tables.py`: migration com 3 tabelas, 3 indices, FKs com CASCADE
- Indices: `idx_filter_media_aquarium` (aquarium_id+status), `idx_filter_media_next_clean` (partial, status=active), `idx_filter_media_log` (media_id+performed_at)
- Relationships: AquariumFilterMedia.logs (cascade delete-orphan), FilterMediaLog.media (back_populates)
- Testes: 427 passed, 0 regressoes

### [2026-02-20 15:56] codex
QA aprovado. Evidencias:
- Models e migration conferidos (`filter_media.py`, `5c55b4e5be25_add_filter_media_tables.py`) com FKs, indices e registro em `models/__init__.py`.
- Rotas e testes relacionados conferidos por inspeção.
- Execução local de testes/migrations indisponível neste ambiente por dependência de DB host `postgres` e configuração de driver no Alembic.
