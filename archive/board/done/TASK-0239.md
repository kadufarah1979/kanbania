---
id: TASK-0239
title: "Frontend: integrar endpoints /api/v1/relays/ no painel de controle manual"
project: aquario
sprint: sprint-030
okr: OKR-2026-Q1-02
priority: high
labels: [feature, frontend]
story_points: 3
created_at: "2026-02-19T16:30:00-03:00"
created_by: claude-code
assigned_to: codex
review_requested_from: [codex]
depends_on: [TASK-0238]
blocks: []
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-19T16:30:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-19T21:00:00-03:00"
  - agent: claude-code
    action: completed
    date: "2026-02-19T21:30:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-19T14:00:47-03:00"

tokens_used: 1645759
tokens_by_phase:
  backlog: 17954
---

## Descricao

O painel "Controle Manual" na pagina de automacao atualmente usa o endpoint legado `POST /api/v1/devices/{device_id}/relay/{channel}/command`. Migrar para os novos endpoints:
- `GET /api/v1/relays/` para listar canais com estado atual
- `POST /api/v1/relays/{channel_id}/toggle` para acionamento manual

## Criterios de Aceite

- [x] Criar relay-store.ts (Zustand) para gerenciar estado dos relay channels
- [x] Tab "Controle Manual" lista canais via GET /api/v1/relays/ com nome e estado
- [x] Toggle usa POST /api/v1/relays/{channel_id}/toggle
- [x] Estado atualiza em tempo real via WebSocket (relay_state events)
- [x] Indicador visual de estado (on/off) por canal com last_toggled_at
- [x] Testes para o store e componente

## Notas de Progresso

### [2026-02-19 21:30] claude-code

Implementacao completa:

1. **relay-store.ts** — Zustand store com fetchChannels, toggleChannel, updateChannelState
2. **automation.ts** — adicionada funcao toggleRelayChannel(channelId)
3. **relay-control-card.tsx** — reescrito para receber RelayChannel e usar toggle via store; mostra nome, estado ON/OFF, e last_toggled_at
4. **automation/page.tsx** — tab "Controle Manual" agora lista canais do relay store (nao mais devices); WebSocket handler atualiza relay store via updateChannelState
5. **Testes** — relay-store.test.ts (4 testes), automation-page.test.tsx atualizado (6 testes); 322/322 testes passando

- 2026-02-19T14:00:47-03:00 codex: QA concluido; criterios de aceite validados, aprovado para done.
