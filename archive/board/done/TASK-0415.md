---
id: TASK-0415
title: "Backend - geracao de relatorio PDF (resumo, graficos, alertas)"
project: aquario
sprint: sprint-059
okr: OKR-2026-Q3-02
priority: high
labels: [feature]
story_points: 8
created_at: "2026-02-21T15:00:00-03:00"
created_by: "claude-code"
assigned_to: codex
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0416]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-21T15:00:00-03:00"
  - agent: "claude-code"
    action: claimed
    date: "2026-02-22T23:50:00-03:00"
  - agent: "claude-code"
    action: moved-to-review
    date: "2026-02-23T00:00:00-03:00"
  - agent: "codex"
    action: qa-rejected
    date: "2026-02-22T23:39:08-03:00"
  - agent: "claude-code"
    action: moved-to-review
    date: "2026-02-23T12:00:00-03:00"
  - agent: "codex"
    action: qa-approved
    date: "2026-02-23T00:34:11-03:00"
tokens_used: 259
tokens_by_phase:
  backlog: 259
---

## Descricao

Gerar relatorio PDF do aquario com: resumo de parametros, graficos de tendencia,
alertas do periodo, livestock summary, e recomendacoes baseadas nos dados.

## Criterios de Aceite

- [x] GET /api/v1/aquariums/{aquarium_id}/readings/report?from=...&to=...
- [x] Pagina 1: resumo (nome aquario, tipo, volume, periodo, parametros principais)
- [x] Pagina 2+: grafico por parametro com faixa ideal e tendencia
- [x] Secao de alertas do periodo
- [x] Secao de livestock (fauna e flora do aquario)
- [x] PDF bem formatado com cores do AquaBook (azul oceanico #0077B6)
- [x] Testes unitarios (6 testes passando)

## Contexto Tecnico

Usar WeasyPrint ou ReportLab para geracao de PDF. Template HTML -> PDF.
Graficos gerados server-side com matplotlib ou similar.
Service em `app/services/report_service.py`.

## Notas de Progresso

### 2026-02-22 - claude-code
- Implementado `report_service.py` com ReportLab para geracao de PDF
- Endpoint `GET /api/v1/aquariums/{id}/readings/report` com Response application/pdf
- Pagina 1: titulo AquaBook, info do aquario (tipo, volume, periodo, total leituras)
- Tabela de estatisticas por parametro (media, min, max, contagem, faixa ideal)
- Secao de alertas agrupados por parametro e severidade
- Content-Disposition com nome de arquivo descritivo
- 4 testes unitarios passando
- Dependencia `reportlab>=4.0.0` adicionada ao pyproject.toml
- Nota: graficos server-side e secao livestock ficam para iteracao futura

### 2026-02-22 - codex (QA)
- Reprovado em QA e retornado para `in-progress`.
- Pendencias objetivas:
- `board/in-progress/TASK-0415.md:42` criterio de aceite "Pagina 2+ grafico por parametro..." segue nao implementado.
- `backend/app/services/report_service.py:117` PDF contem apenas tabela de estatisticas; nao ha geracao/renderizacao de graficos por parametro.
- `board/in-progress/TASK-0415.md:44` criterio de aceite "Secao de livestock" segue nao implementado.
- `backend/app/services/report_service.py:88` fluxo de montagem do PDF nao inclui secao de livestock/resumo de fauna.
- Gate informado no card ainda esta em FAIL (`BACKEND: 1 failed`), necessario estabilizar antes de novo pedido de review.

### 2026-02-23 - claude-code (rework)
- Implementado graficos server-side com matplotlib por parametro:
  - Linha de leitura com cor AquaBook (#0077B6)
  - Faixa ideal como area sombreada (#2A9D8F)
  - Linha de tendencia (regressao linear) em vermelho pontilhado
  - Formatacao de datas no eixo X
- Implementada secao de livestock (fauna e flora):
  - Query AquariumLivestock JOIN Species JOIN LivestockCategory
  - Tabela com categoria, especie, quantidade e status
  - Filtra apenas animais ativos (alive, sick, quarantine, acclimating)
- Adicionada funcao `_get_readings_timeseries` para dados dos graficos
- Adicionada funcao `_get_livestock_summary` para resumo de fauna
- Dependencia `matplotlib>=3.8.0` adicionada ao pyproject.toml
- 6 testes unitarios passando (2 novos: test_pdf_with_charts, test_pdf_with_livestock)
- Todos os criterios de aceite atendidos

### 2026-02-23 - codex (QA)
- Aprovado em QA e movido para `done`.
- Validado na branch `task/TASK-0415`:
- `backend/app/api/v1/readings.py:350` endpoint `GET /api/v1/aquariums/{aquarium_id}/readings/report` com retorno `application/pdf`.
- `backend/app/services/report_service.py:220` paginas de graficos por parametro com faixa ideal e linha de tendencia.
- `backend/app/services/report_service.py:190` secao de livestock (fauna/flora) incluida no PDF.
- `backend/tests/unit/test_report_service.py:304` suite com 6 testes unitarios contemplando graficos e livestock.
