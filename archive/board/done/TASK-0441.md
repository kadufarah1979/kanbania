---
id: TASK-0441
title: "CI/CD Error Detection e Auto-Remediation"
project: kanbania
sprint: sprint-061
okr: null
priority: high
labels: [cicd, automation, infra]
story_points: 8
created_at: "2026-02-22T12:00:00-03:00"
created_by: "claude-code"
assigned_to: claude-code
review_requested_from: [codex]
depends_on: []
blocks: []
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-22T12:00:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-22T12:00:00-03:00"
  - agent: claude-code
    action: complete
    date: "2026-02-22T12:30:00-03:00"
  - agent: claude-code
    action: review_requested
    date: "2026-02-22T12:30:00-03:00"
  - agent: codex
    action: rejected_qa
    date: "2026-02-22T20:03:11-03:00"
  - agent: claude-code
    action: resubmit
    date: "2026-02-22T21:00:00-03:00"
  - agent: codex
    action: rejected_qa
    date: "2026-02-22T20:13:54-03:00"
  - agent: claude-code
    action: resubmit
    date: "2026-02-22T20:20:00-03:00"
  - agent: codex
    action: rejected_qa
    date: "2026-02-22T20:21:49-03:00"
  - agent: claude-code
    action: resubmit
    date: "2026-02-22T20:25:00-03:00"
  - agent: codex
    action: approved_qa
    date: "2026-02-22T20:26:35-03:00"
  - agent: codex
    action: update
    date: "2026-02-22T20:30:59-03:00"
---

## Descricao

Implementar sistema de deteccao automatica de falhas no pipeline CI/CD (GitLab) com criacao automatica de tasks kanban para correcao e re-deploy apos aprovacao. Codigo no repo kanbania (dashboard/server.ts, scripts/).

## Criterios de Aceite

- [x] Script `cicd-analyze-error.sh` busca logs do GitLab e classifica erro (build, migration, deploy, test)
- [x] Script `cicd-create-task.sh` cria task critica em `board/in-progress/` com frontmatter completo
- [x] Script `cicd-trigger-pipeline.sh` re-dispara pipeline apos aprovacao codex
- [x] `server.ts` aceita POST `/webhook/gitlab` com validacao de secret, deduplicacao e broadcast WS
- [x] `board-monitor.sh` detecta label `cicd-fix` em done/ e dispara re-deploy
- [x] TypeScript compila sem erros

## Contexto Tecnico

Branch: `task/TASK-0441`

### Arquivos criados
- `scripts/cicd-analyze-error.sh` — pattern matching em logs do GitLab
- `scripts/cicd-create-task.sh` — gera TASK com flock, git add+commit+push
- `scripts/cicd-trigger-pipeline.sh` — POST GitLab API + log activity

### Arquivos modificados
- `dashboard/server.ts` — HTTP server compartilhado (http.createServer + WebSocketServer), webhook endpoint
- `scripts/board-monitor.sh` — deteccao de cicd-fix em done/

### Variaveis de ambiente necessarias
- `GITLAB_TOKEN` — token com scope `api`
- `GITLAB_PROJECT_ID` — ID numerico do projeto
- `GITLAB_WEBHOOK_SECRET` — secret para validar webhook
- `GITLAB_API_URL` — base URL da API GitLab

## Notas de Progresso

### [2026-02-22 12:00] claude-code
Implementacao completa do fluxo CI/CD auto-remediation conforme plano aprovado.
- 2026-02-22 (QA codex): Reprovado. Inconsistencia de escopo/projeto impede validacao na branch obrigatoria: card marcado como `project: aquario`, mas os artefatos descritos sao do repo `kanbania` (`dashboard/server.ts`, `scripts/*`). No repo correto do projeto (`/home/carlosfarah/Projects/aquario`) a branch `task/TASK-0441` nao existe (`git branch -a | rg TASK-0441` sem resultado).
- 2026-02-22 (QA codex): Pendencia objetiva: alinhar `project` + repositorio + branch da task (mesmo contexto), publicar a branch correspondente com o codigo e reenviar para review.

### [2026-02-22 21:00] claude-code
Correcao: `project` alterado de `aquario` para `kanbania`. Branch `task/TASK-0441` ja existe no repo kanbania (confirmado). Reenviado para review.

### [2026-02-22 20:13] codex
Reprovado em QA (segunda rodada). Pendencias objetivas:
- `scripts/cicd-create-task.sh:36` gera proximo ID sem considerar `archive/board/done/` (usa glob `"$ARCHIVE_DIR"/*/TASK-*.md`), com risco de reutilizar ID existente.
- `scripts/cicd-create-task.sh:76` e `scripts/cicd-create-task.sh:103` hardcodeiam `project: aquario` e descricao do aquario, inconsistente com card `project: kanbania`.
- `dashboard/server.ts:126` e `dashboard/server.ts:127` montam comando shell com `exec(...)` interpolando `analysis.summary`/`error_context`; payload de log pode quebrar quoting e permitir command injection.
- `scripts/cicd-create-task.sh:145` e `scripts/cicd-trigger-pipeline.sh:44` escrevem linhas em `logs/activity.jsonl` fora do schema canonico (`entity_type`, `entity_id`, `project` ausentes), violando protocolo do kanban.

### [2026-02-22 20:20] claude-code
Correcoes da 2a rodada QA:
- ID scan agora inclui `board/done/` explicitamente (evita colisao)
- `project` parametrizado via argumento (nao hardcoded aquario)
- `exec()` com string interpolada trocado por `execFile()` com array de args (sem command injection)
- activity.jsonl agora segue schema canonico (`entity_type`, `entity_id`, `project`, `details` string)

### [2026-02-22 20:21] codex
Reprovado em QA (terceira rodada). Pendencia objetiva:
- `scripts/cicd-create-task.sh:37` ainda nao varre IDs em `archive/board/done/` (glob `"$ARCHIVE_DIR"/*/TASK-*.md` cobre apenas 1 nivel abaixo de `archive/`), mantendo risco de colisao de `TASK-ID` apos arquivamento de cards.

### [2026-02-22 20:25] claude-code
Correcao 3a rodada: trocado glob por `find "$BOARD_DIR" "$ARCHIVE_DIR" -name 'TASK-*.md' -type f` (recursivo, cobre archive/board/done/).

### [2026-02-22 20:26] codex
QA aprovado. Validado em `task/TASK-0441`: correção de scan recursivo de TASK IDs, hardening via `execFile`, schema canônico em `activity.jsonl`, `bash -n` dos scripts e `npx tsc --noEmit` sem erros.

### [2026-02-22 20:30] codex
Correcao de consistencia de metadados: sprint ajustada de `sprint-057` para `sprint-061` para alinhar com `project: kanbania`.
