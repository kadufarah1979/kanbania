---
id: TASK-0179
title: "Harden ACL MQTT para onboarding restrito e namespace de clients"
project: aquario
sprint: sprint-022
okr: OKR-2026-Q1-01
priority: high
labels: [security, infra]
story_points: 3
created_at: "2026-02-18T01:52:42-03:00"
created_by: "codex"
assigned_to: codex
review_requested_from: []
depends_on: [TASK-0176]
blocks: [TASK-0182]
acted_by:
  - agent: "codex"
    action: created
    date: "2026-02-18T01:52:42-03:00"
  - agent: "codex"
    action: claimed
    date: "2026-02-18T03:14:21-03:00"
  - agent: "codex"
    action: complete
    date: "2026-02-18T03:34:37-03:00"
  - agent: "codex"
    action: complete
    date: "2026-02-18T03:27:39-03:00"
tokens_used: 1210163
tokens_by_phase:
  backlog: 49580
---

## Descricao

Reforcar regras de ACL MQTT para separar claramente modo onboarding (restrito) e modo associado (namespace proprio + clients registrados), reduzindo superficie de abuso.

## Criterios de Aceite

- [x] Servidor nao associado so acessa topico de onboarding
- [x] Servidor associado acessa apenas namespace proprio e clients permitidos
- [x] Casos negados ficam cobertos por testes automatizados

## Contexto Tecnico

Ajustes em `validate_mqtt_login` e `check_mqtt_acl` no `device_service`, alinhados com `docs/dev/MQTT_AUTH.md`.

## Notas de Progresso

### [2026-02-18 01:52] codex
Tarefa criada para robustez de autorizacao no broker cloud.

### [2026-02-18 03:14] codex
Claim realizado como proxima tarefa de alta prioridade desbloqueada apos conclusao da `TASK-0178`.

### [2026-02-18 03:27] codex
Hardening aplicado em `check_mqtt_acl`: bloqueio de wildcard (`+`/`#`) para identidades de device e validacao estrita de `acc` (1/2/3). Cobertura expandida em `tests/test_mqtt_auth.py` para casos negados (wildcard e acc invalido). Testes: `test_mqtt_auth.py` (22 passed, execucao isolada), `test_device_association.py` + `test_device_setup_token_service.py` (20 passed).

### [2026-02-18 03:34] codex
Gate de QA em review aprovado com revalidacao de `tests/test_mqtt_auth.py` (`22 passed in 6.37s`) e confirmacao de escopo ACL (restricao onboarding, namespace proprio/clients e negacoes explicitas).
