---
id: TASK-0066
title: "Q&A API endpoints"
project: aquario
sprint: sprint-009
points: 2
priority: high
status: done
assigned_to: null
review_requested_from: [codex]
depends_on: [TASK-0065]
created_at: "2026-02-15T20:00:00-03:00"
created_by: claude-code
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-15T20:00:00-03:00"
  - agent: claude-code
    action: claimed
    date: "2026-02-15T21:00:00-03:00"
  - agent: claude-code
    action: moved_to_review
    date: "2026-02-15T21:01:00-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T09:20:32-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T09:23:55-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T09:47:29-03:00"
  - agent: codex
    action: qa_changes_requested
    date: "2026-02-15T09:51:04-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T10:06:09-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T10:10:06-03:00"
  - agent: claude-code
    action: approved
    date: "2026-02-15T11:50:00-03:00"
  - agent: codex
    action: qa_approved
    date: "2026-02-15T11:55:17-03:00"
tokens_used: 2417239
tokens_by_phase:
  backlog: 2370926
  in_progress: 34600
---

## Descricao

Endpoints: POST /listings/{id}/questions, GET /listings/{id}/questions, PUT /questions/{id}/answer, DELETE /questions/{id}. Errors: 400, 403, 404.

## Criterios de Aceite

- [x] POST criar pergunta (auth)
- [x] GET listar Q&A (publico)
- [x] PUT responder (seller only)
- [x] DELETE deletar (seller/admin)
- [x] Error handling correto

## Notas de Progresso

- **2026-02-15 21:01 (claude-code)**: Sprint 9 implementation complete. Moved to review.
- **2026-02-15 09:20 (codex)**: QA: changes requested. Bug funcional: `GET /marketplace/listings/{listing_id}/questions` retorna `200` com lista vazia para `listing_id` inexistente, sem `404` ("Anuncio nao encontrado"), contrariando o card em error handling. Regra critica aplicada: card mantido em `review` (sem `claude-code approved` em `acted_by`).
- **2026-02-15 09:23 (codex)**: QA: changes requested (recheck). Bug permanece: `GET /marketplace/listings/{listing_id}/questions` nao valida existencia/estado do anuncio e retorna `200` em vez de `404`. Resultado de gate recebido (`Could not acquire lock after 5min`) tratado como ambiente, sem impacto na decisao.
- **2026-02-15 09:47 (codex)**: QA: changes requested (recheck-2). Bug real persiste: `list_questions_endpoint` em `backend/app/api/v1/marketplace.py` chama `get_questions` diretamente (linha 379) sem validar se o anuncio existe/esta deletado; o service `get_questions` (`backend/app/services/listing_question_service.py`) apenas filtra por `listing_id` e retorna lista vazia/`200` quando inexistente. Esperado pelo card: `404` com "Anuncio nao encontrado". Gates automaticos: PASSED (considerados).
- **2026-02-15 09:51 (codex)**: QA: changes requested (recheck-3). Bug funcional continua aberto: `GET /marketplace/listings/{listing_id}/questions` (`backend/app/api/v1/marketplace.py`) nao valida existencia/status (`deleted`) do anuncio antes de listar; para `listing_id` inexistente retorna `200` com `questions=[]`/`total=0`. Crit√©rio de error handling do card exige `404` ("Anuncio nao encontrado"). Gates automaticos informados: PASSED.
- **2026-02-15 10:06 (codex)**: QA: aprovado tecnicamente (gate results: PASSED). Correcao validada: `GET /marketplace/listings/{listing_id}/questions` agora verifica existencia/status do anuncio e retorna `404` ("Anuncio nao encontrado") quando inexistente/deletado. Regra critica aplicada: card permanece em `review` por ausencia de `acted_by` com `claude-code approved`.
- **2026-02-15 10:10 (codex)**: QA recheck final: aprovado tecnicamente (gate results: PASSED). Endpoints e error handling do card conferem; sem vulnerabilidade obvia no escopo. Regra critica mantida: card segue em `review` ate existir `acted_by` com `claude-code approved`.
- **2026-02-15 11:55 (codex)**: QA: aprovado (gate results: PASSED). Revisao final confirmou criterios de aceite atendidos, error handling `400/403/404` conforme card e ausencia de vulnerabilidade obvia no escopo.
