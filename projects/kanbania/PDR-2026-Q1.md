---
id: PDR-2026-Q1
project: kanbania
title: "Observabilidade de Agentes + Config Foundation"
period: "2026-Q1 (fev-mar)"
status: approved
created_at: "2026-02-27T12:00:00-03:00"
created_by: claude-code
---

# PDR-2026-Q1 — Observabilidade de Agentes + Config Foundation

## 1. Contexto e Estado Atual

O Kanbania e um sistema kanban pessoal baseado em arquivos markdown com dashboard Next.js.
O sistema esta operacional com 2 agentes ativos (claude-code + codex), 9 sprints concluidas
(velocidade media: 19.3 pts/sprint), 75 tasks entregues e 73 tasks pendentes no backlog.

**Gaps identificados:**
- Nenhuma visibilidade em tempo real do que os agentes estao fazendo (nivel de tool use)
- AgentStatusBar mostra apenas o status da task — nao o tool sendo executado
- Sem mecanismo de pausa para aprovacao humana (HITL)
- Backlog config-driven com 73 tasks ja planejadas para sprints 039-047

## 2. Objetivos do Periodo (1 mes — 2 sprints)

1. **Observabilidade de agentes em tempo real** (Fases 1-4)
   - Capturar eventos de tool use via Claude Code hooks (Python)
   - Transmitir eventos para o dashboard via WebSocket
   - Exibir swimlane por agente com ultimos eventos em tempo real

2. **Config Foundation — itens prioritarios**
   - Expandir config.yaml com secoes system, workflow, projects e agents
   - Criar config.local.yaml para segredos locais
   - Base tecnica que as demais sprints config-driven dependem

## 3. Features e Escopo Detalhado

### P0 — Observabilidade (nova feature)

**Fase 1 — Hooks Python**
- Criar .claude/hooks/_shared.py (modulo compartilhado: send_hook_event)
- Criar hooks: pre_tool_use.py, post_tool_use.py, session_start.py, session_end.py, stop.py, notification.py
- Configurar hooks no settings.json (.claude/)

**Fase 2 — Endpoint server.ts**
- Refatorar handleWebhook em mini-router
- Novo endpoint POST /events/hook
- Persistencia em logs/hooks-events.jsonl + broadcast WebSocket

**Fase 3 — Tipos TypeScript**
- Adicionar HookEvent, HitlRequest em types.ts
- Expandir WSMessage de interface para union discriminada
- Corrigir type guards em AgentStatusBar e outros componentes

**Fase 4 — AgentSwimLane**
- Criar composable use-hook-events.ts
- Criar componente AgentSwimLane.tsx
- Integrar na pagina /board/[project]

### P1 — Config Foundation (backlog existente, itens prioritarios)

- TASK-0290: Expandir config.yaml — secao system (1pt)
- TASK-0291: Expandir config.yaml — secao workflow (3pt)
- TASK-0292: Expandir config.yaml — secao projects (2pt)
- TASK-0293: Expandir config.yaml — secao agents com campos extras (2pt)
- TASK-0295: Criar config.local.yaml (2pt)

## 4. Decisoes Tecnicas

- Stack do dashboard: Next.js 14 (App Router), TypeScript, Tailwind CSS
- Hooks Python: stdlib pura (urllib, json, os) — zero dependencias externas
- Persistencia de hook events: JSONL (consistente com activity.jsonl, rework-pending.jsonl)
- Sem SQLite — manter filesystem como fonte de verdade
- WSMessage: transformar de interface para union discriminada (type-safe)
- HITL (Fase 5): fora deste PDR — complexidade alta, planejado para proximo ciclo

## 5. Riscos

| Risco | Impacto | Mitigacao |
|---|---|---|
| WSMessage union quebra type guards existentes | Alto | Corrigir AgentStatusBar antes do build — Fase 3 testa o build |
| Restart server.ts apos mudancas | Alto | Seguir DASHBOARD_OPS.md; executar fuser -k 8766/tcp antes |
| Volume de eventos em PreToolUse (JSONL crescimento) | Medio | Rotacao simples: truncar hooks-events.jsonl se > 10MB |
| CLAUDE_SESSION_ID nao disponivel como env var | Medio | session_start.py gera UUID em /tmp/claude-session-{PID}.id |

## 6. Estimativa de Capacidade

Sprint 090 (21pts): Observabilidade Fases 1+2 (~12pts) + Config Foundation P1 (~9pts) = 21pts
Sprint 091 (21pts): Observabilidade Fases 3+4 (~11pts) + Config Foundation P1 restante (~5pts) + buffer = 21pts

Total: 42 pts planejados | 2 sprints | 14 dias cada

## 7. Sprints e OKRs (IDs definitivos apos aprovacao)

- Sprint 090: sprint-090 | OKR: OKR-2026-Q1-06 + OKR-2026-Q2-01
- Sprint 091: sprint-091 | OKR: OKR-2026-Q1-06 + OKR-2026-Q2-03

## 8. Artefatos a Gerar

- OKR-2026-Q1-06: Observabilidade total de agentes no Kanbania
- sprint-090 (2026-02-27 a 2026-03-12)
- sprint-091 (2026-03-13 a 2026-03-26)
- TASK-0661 a TASK-0677 (17 tasks novas para observabilidade)
- Reatribuir TASK-0290/0291/0292/0293/0295 para sprint-090/091
