---
id: PDR-2026-Q1
project: "consoleai"
period: "2026-Q1"
created_at: "2026-02-23T10:30:00-03:00"
created_by: "claude-code"
status: approved
---

# PDR — ConsoleAI (2026-Q1)

## 1. Visao do Produto

### 1.1 Problema

Times de DevOps da Amazonas Inovare operam com duas ferramentas separadas: o modulo FinOps (relatorios de custo AWS por OU/conta) e o ConsoleAI operacional (inventario, solicitacoes e aprovacoes de tarefas por tenant). Nao ha visibilidade cruzada — nao e possivel, por exemplo, ver o custo de uma OU ao aprovar uma acao operacional, nem identificar recursos ociosos com base no custo real.

### 1.2 Proposta de valor

Unificar FinOps e gestao operacional em uma plataforma multi-tenant coesa, onde cada tenant (OU) ve seu inventario AWS, suas acoes operacionais pendentes/aprovadas e seu custo AWS — tudo com autenticacao unificada e contexto de tenant por requisicao.

### 1.3 Usuarios/Stakeholders

- **DevOps Gestor**: aprova solicitacoes, ve custo e inventario por OU
- **DevOps Executor**: solicita acoes, consulta inventario, ve custo do seu tenant
- **Gestor Financeiro**: acompanha custo por OU e projecoes de Savings Plans
- **Administrador**: gerencia usuarios, tenants e permissoes

---

## 2. Estado Atual

### 2.1 O que ja existe

**Modulo FinOps** (legacy pages/):
- Fase 1: Relatorio real de custo 2025 por conta/OU/ambiente
- Fase 2: Projecao 2026 com 4 cenarios de Savings Plans
- Fase 3: Projecao 2027 com otimizacao de scheduling
- Sincronizacao de dados via boto3 (Cost Explorer, Savings Plans)
- Persistencia em SQLite (finops decisions, sync runs)

**Modulo ConsoleAI Operacional** (src/consoleai/):
- RBAC multi-tenant por OU com guardrail PRD somente leitura
- Inventario AWS: EC2, ELB/listeners/TG, Route53/dominios
- Restart de instancia com confirmacao e bloqueio PRD
- Workflow de solicitacao/aprovacao com sync ao Kanban
- Audit trail de acoes criticas
- API FastAPI versionada
- Testes unitarios (18 arquivos em tests/unit/)

**Lacunas de integracao**:
- FinOps e ConsoleAI sem autenticacao compartilhada
- Custo AWS nao mapeado a tenants no modulo operacional
- Pages legadas (fase1.py, fase2.py, fase3.py) coexistem com modulo novo
- Persistencia fragmentada: FinOps em SQLite, ConsoleAI migrando para PostgreSQL

### 2.2 Metricas atuais

| Metrica | Valor |
|---------|-------|
| Tasks concluidas | 28 |
| Tasks pendentes | 0 |
| Pontos entregues | 101 SP |
| Sprints com consoleai | 6 |
| Velocidade media | ~6.5 SP/sprint (historico misto) |
| OKRs ativos | 0 |
| Arquivos Python | 46 |
| Arquivos de teste | 18 |

### 2.3 Divida tecnica

- Pages legadas (fase1/2/3) nao usam autenticacao do ConsoleAI
- Persistencia FinOps em SQLite separada do PostgreSQL operacional
- Navegacao inconsistente: FinOps e ConsoleAI como silos no Streamlit
- Sem mapeamento custo-por-tenant no runtime (so relatorio estatico)

---

## 3. Gap Analysis

### 3.1 Funcionalidades faltantes

1. **[P0] Auth gate para paginas FinOps** — pages fase1/2/3 precisam de autenticacao por tenant
2. **[P0] Mapeamento custo-por-OU em runtime** — associar dados do Cost Explorer a tenants ativos dinamicamente
3. **[P0] Dashboard unificado Custo + Inventario** — visao consolidada por tenant (EC2 + ELB + custo mensal + alertas)
4. **[P0] Migracao FinOps para PostgreSQL** — unificar persistencia com o modulo operacional
5. **[P1] Alertas de budget por tenant** — notificar quando tenant excede threshold de custo configurado
6. **[P1] Recomendacoes de Savings Plans por tenant** — exibir cenarios de economia contextualizados por OU
7. **[P1] UX/navegacao unificada** — menu unico, design system consistente entre FinOps e Operacional
8. **[P1] Cost context em acoes operacionais** — exibir custo mensal do recurso ao solicitar restart/acao
9. **[P2] Rightsizing recommendations** — sugerir redimensionamento baseado em custo + utilizacao
10. **[P2] Export relatorio por tenant** — PDF/CSV do custo + inventario do tenant

### 3.2 Requisitos nao-funcionais

- **Seguranca**: nenhuma pagina FinOps acessivel sem autenticacao e contexto de tenant
- **Performance**: carregamento de dashboard unificado < 3s (cache de dados AWS)
- **Observabilidade**: logs estruturados em todas as chamadas boto3 do modulo FinOps
- **Rastreabilidade**: audit trail para visualizacoes de custo (quem viu o que e quando)

### 3.3 Dependencias externas

- AWS Cost Explorer API (ja integrado, mas sem escopo por tenant/OU)
- Credenciais AWS com permissoes de organizations + ce:GetCostAndUsage
- PostgreSQL instance disponivel para migracao

---

## 4. Decisoes Tecnicas

### 4.1 Arquitetura proposta

```
Streamlit App (dashboard.py)
 ├── Auth layer (auth/auth.py + authz.py) — gate para todas as pages
 ├── pages/
 │   ├── unified_dashboard.py   [NOVO] inventario + custo por tenant
 │   ├── finops_tenant.py       [NOVO] custo/projecoes contextualizados por tenant
 │   ├── operations.py          [NOVO] workflow + inventario unificados
 │   └── admin.py               usuarios, tenants, configuracoes
 ├── consoleai/
 │   ├── cost_service.py        [NOVO] busca custo por OU no Cost Explorer
 │   ├── budget_service.py      [NOVO] thresholds e alertas de budget
 │   └── ... (servicos existentes)
 └── PostgreSQL (persistencia unificada)
```

### 4.2 Trade-offs

| Decisao | Opcao escolhida | Alternativa descartada | Justificativa |
|---------|-----------------|----------------------|---------------|
| Persistencia | PostgreSQL unificado | Manter SQLite FinOps | Consistencia transacional e queries relacionais entre dominios |
| Custo por tenant | Consulta Cost Explorer por OU tag/name | Pre-processar e cachear em batch | Dados frescos sem complexidade de ETL adicional |
| Auth FinOps | Reutilizar auth/authz.py existente | Auth separado para FinOps | Evitar duplicidade, aproveitar RBAC ja testado |
| Navigation | Streamlit multipage unificado | Duas apps separadas | UX coesa, um unico ponto de entrada |

### 4.3 Riscos

| Risco | Probabilidade | Impacto | Mitigacao |
|-------|---------------|---------|-----------|
| Cost Explorer sem granularidade por OU | Media | Alto | Mapear OUs via organizations API + filtro por linked account |
| Migracao PostgreSQL com dados legados | Baixa | Medio | Script ETL com validacao + rollback |
| Performance de queries Cost Explorer | Media | Medio | Cache TTL 1h no PostgreSQL para dados de custo |
| Quebra de paginas legadas | Baixa | Baixo | Manter backward compat durante transicao |

---

## 5. Priorizacao

### 5.1 Must-have P0

1. Auth gate para todas as pages FinOps (reutilizar auth/authz.py)
2. Servico de custo por OU: `consoleai/cost_service.py` (consulta Cost Explorer + organizations)
3. Dashboard unificado: inventario + custo mensal por tenant em uma page
4. Migracao FinOps para PostgreSQL (tabelas: finops_sync, finops_decisions, cost_cache)

### 5.2 Should-have P1

1. Alertas de budget: threshold configuravel por tenant, notificacao na UI
2. Recomendacoes de Savings Plans contextualizadas por OU
3. Custo do recurso visivel no fluxo de aprovacao de solicitacoes
4. Navegacao/UX unificada (menu lateral, design system consistente)

### 5.3 Nice-to-have P2

1. Rightsizing recommendations (custo + CloudWatch metrics)
2. Export PDF/CSV do relatorio por tenant
3. Trend chart de custo por OU nos ultimos 3 meses

### 5.4 Criterios de priorizacao

- **Impacto operacional**: integracoes que unificam o fluxo diario (P0)
- **Seguranca**: auth gate e visibilidade de dados por tenant (P0)
- **Valor para gestores**: visibilidade de custo em contexto operacional (P1)
- **Esforco**: tasks decompostas em <= 3 SP para entrega incremental

---

## 6. Estimativa de Esforco

| Categoria | Tasks estimadas | Pontos estimados | Sprints estimados |
|-----------|----------------|------------------|-------------------|
| P0 - Must-have | 10 | 26 SP | 1.5 |
| P1 - Should-have | 8 | 22 SP | 1.0 |
| P2 - Nice-to-have | 4 | 10 SP | 0.5 |
| **Total** | **22** | **58 SP** | **~3 sprints** |

Capacidade: 21 SP/sprint. Horizonte Q1 2026: 4 sprints disponíveis (sprint-061 a sprint-064).
Folga de ~26 SP para imprevistos, testes e rework.

---

## 7. Roadmap Visual (IDs definitivos)

```
Q1 2026 — ConsoleAI: FinOps + Operacional Integrado
OKR: OKR-2026-Q1-03
============================================================
sprint-061 (Feb 23 – Mar 08) [P0 Foundation] — 21 SP
  ├── TASK-0443: Auth gate FinOps pages (3 SP)
  ├── TASK-0444: cost_service.py (3 SP)
  ├── TASK-0445: Tabelas PostgreSQL FinOps (2 SP)
  ├── TASK-0446: ETL SQLite -> PostgreSQL (3 SP)
  ├── TASK-0447: Cache custo por OU (2 SP)
  ├── TASK-0448: Testes unitarios (3 SP)
  ├── TASK-0449: Logs estruturados boto3 (2 SP)
  └── TASK-0450: Audit trail visualizacoes (3 SP)

sprint-062 (Mar 09 – Mar 22) [P0 Dashboard] — 21 SP
  ├── TASK-0451: unified_dashboard.py (3 SP)
  ├── TASK-0452: Graficos custo mensal (2 SP)
  ├── TASK-0453: Widget custo no inventario (3 SP)
  ├── TASK-0454: Custo no fluxo de aprovacao (3 SP)
  ├── TASK-0455: finops_tenant.py (3 SP)
  ├── TASK-0456: Menu lateral unificado (2 SP)
  ├── TASK-0457: Remover acesso anonimo legado (2 SP)
  └── TASK-0458: Testes de integracao (3 SP)

sprint-063 (Mar 23 – Apr 05) [P1 Alertas + Estabilizacao] — 16 SP
  ├── TASK-0459: budget_service.py (3 SP)
  ├── TASK-0460: Notificacao budget na UI (2 SP)
  ├── TASK-0461: Savings Plans por OU (3 SP)
  ├── TASK-0462: Trend chart custo (2 SP)
  ├── TASK-0463: Export CSV por tenant (2 SP)
  ├── TASK-0464: Testes E2E fluxo completo (3 SP)
  └── TASK-0465: Documentacao API (1 SP)
```

---

## 8. Criterios de Sucesso

Vinculados ao OKR-2026-Q1-03:

1. 100% das pages FinOps com autenticacao por tenant (guardrail ativo)
2. Custo AWS mapeado e exibido para todos os tenants ativos na plataforma
3. Dashboard unificado (inventario + custo) em producao e em uso pelo time
4. Latencia de carregamento do dashboard < 3s com cache ativo
5. Zero acesso cross-tenant a dados de custo (validado por testes)

---

## 9. Historico de Revisoes

| Data | Autor | Mudanca |
|------|-------|---------|
| 2026-02-23 | claude-code | Criacao inicial |
