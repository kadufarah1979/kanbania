---
id: PDR-2026-Q1Q2
project: "tecpag"
period: "2026-Q1Q2"
created_at: "2026-02-23T13:00:00-03:00"
created_by: "claude-code"
status: approved
---

# PDR — TecPag (Q1+Q2 2026)

## 1. Visao do Produto

### 1.1 Problema

O TecPag e uma plataforma de pagamentos multi-modalidade (PIX, online, presencial) que opera em producao sem conformidade PCI-DSS 4.0.1 e com **score de seguranca 25/100 (CRITICO)**.

12 vulnerabilidades criticas foram identificadas em 2026-02-02, predominantemente credenciais de producao (AWS IAM, DB, tokens) expostas em arquivos `.env` versionados no Git. Sem remediacao imediata, o projeto esta em risco de comprometimento total de producao e impossibilidade de certificacao PCI.

### 1.2 Proposta de valor

Transformar o TecPag de um sistema nao-conforme com vulnerabilidades criticas para uma plataforma:
- **Segura**: zero credenciais expostas, secrets centralizados no AWS Secrets Manager
- **Conforme**: PCI-DSS 4.0.1 com 12/14 requisitos implementados e automatizados
- **Auditavel**: evidencias tecnicas coletadas automaticamente, rastreabilidade completa
- **Operacional**: IaC validado, CI/CD funcional, observabilidade avancada

### 1.3 Usuarios/Stakeholders

- **Time de infraestrutura**: responsavel por IaC, provisionamento e hardening
- **Time DevOps**: responsavel por orquestracao de servicos e pipelines
- **Time de desenvolvimento**: responsavel pelos 7 microsservicos
- **Auditores PCI**: validam conformidade e emitem certificacao

---

## 2. Estado Atual

### 2.1 O que ja existe

**Infraestrutura (IaC):**
- 20+ modulos Terraform cobrindo: IAM, security-groups, launch_templates, ALB, NLB, autoscaling, Route53, ACM, S3, Secrets Manager, bastion-access, AMI
- 4 ambientes: dev, qa, hml, prd
- Scripts de provisionamento em cadeia (7 scripts, hardening com auditd, fail2ban, Docker, Zabbix Agent)

**Servicos (DevOps):**
- 8 servicos Docker Compose: gateway, plataforma, frontend, MongoDB, PostgreSQL, RabbitMQ, Redis, telemetria (Zabbix + ELK)
- Observabilidade parcial: Zabbix agent ativo, ELK configurado

**Codigo-fonte (Source):**
- 7 microsservicos: gateway-domain (9 modulos), gateway-api (7 modulos), gatewaypix, gatewayonline, gatewaypresencial, plataforma, Frontend

**Compliance:**
- pci-compliance-automation Python: orquestrador + 1/14 checkers implementados (13 sao stubs)
- Relatorios gerados em MD/JSON/CSV
- Analise de seguranca PCI realizada em 2026-02-02 (disponivel em DevOps/docs/)

### 2.2 Metricas atuais

| Metrica | Valor |
|---------|-------|
| Tasks concluidas (tecpag) | 0 (projeto novo no kanban) |
| Tasks tecpag-pci legadas | 4 (1 em todo, 3 em backlog) |
| Pontos entregues | 0 |
| Sprints completados | 0 |
| Velocidade media | 21 pts/sprint (padrao global) |
| OKRs ativos | 0 |
| Score de seguranca | 25/100 (CRITICO) |
| Conformidade PCI estimada | NAO CONFORME |
| Checkers PCI implementados | 1/14 |
| Vulnerabilidades criticas | 12 |
| Vulnerabilidades altas | 8 |

### 2.3 Divida tecnica

**Critica (bloqueia PCI):**
- Credenciais de producao em `.env` versionados: MongoDB, PostgreSQL, Redis, RabbitMQ, AWS IAM (2 chaves), tokens NPM/GitHub
- Grafana com acesso anonimo e senha padrao "admin"
- TLS insecure no otel-collector (producao)
- Debug mode habilitado em producao
- Containers rodando como root

**Alta:**
- 13 checkers PCI sao stubs (sem implementacao real)
- Sem CI/CD de validacao IaC (tfsec/checkov)
- Sem pipeline automatizado de deploy
- Headers de seguranca HTTP ausentes no nginx
- Portas de debug expostas em Docker Compose

**Media:**
- Modulos Terraform sem README e exemplos
- Scripts de provisionamento sem changelog/versioning
- Sem SAST/DAST nos microsservicos

---

## 3. Gap Analysis

### 3.1 Funcionalidades faltantes

**Seguranca (P0 — URGENTE):**
1. Gestao centralizada de secrets (AWS Secrets Manager) em TODOS os microsservicos
2. Remocao de credenciais do historico Git (git filter-repo)
3. Autenticacao obrigatoria em Grafana/Loki
4. TLS correto no otel-collector
5. Usuarios nao-root nos containers
6. Headers de seguranca HTTP (X-Frame-Options, CSP, HSTS)

**Compliance PCI (P0-P1):**
7. Checker PCI Req 2 (configuracoes padrao) — stub
8. Checker PCI Req 3 (criptografia em repouso) — stub (CRITICO)
9. Checker PCI Req 4 (criptografia em transito) — stub
10. Checker PCI Req 5 (antimalware) — stub
11. Checker PCI Req 6 (software seguro / SAST) — stub
12. Checker PCI Req 7 (controle de acesso need-to-know) — stub
13. Checker PCI Req 8 (autenticacao e gestao de identidade) — stub
14. Checker PCI Req 10 (logging e monitoramento) — parcialmente implementado
15. Checker PCI Req 11 (testes de penetracao) — stub (CRITICO)
16. Checker PCI Req 12 (politicas de seguranca) — stub
17. Checker PCI Req 13 (gestao de vulnerabilidades) — stub (CRITICO)

**IaC (P1):**
18. Validacao automatizada: tfsec + checkov no pipeline
19. Drift detection automatizado
20. README para os 20+ modulos Terraform

**DevOps (P1-P2):**
21. Pipeline CI/CD (build, test, deploy-hml, deploy-prd com aprovacao)
22. Dashboard Kibana para auditoria PCI
23. Alertas Zabbix para eventos de seguranca

**Source (P2):**
24. SAST automatizado nos microsservicos
25. Documentacao API (Swagger) para gateway-domain

### 3.2 Requisitos nao-funcionais

| Requisito | Status | Gap |
|-----------|--------|-----|
| Seguranca (nao-exposicao de secrets) | CRITICO | 12 vulns criticas |
| Conformidade PCI-DSS 4.0.1 | NAO CONFORME | Score 25/100 |
| Criptografia em repouso | NAO IMPLEMENTADO | Req 3 stub |
| Criptografia em transito | PARCIAL | TLS insecure em telemetria |
| Auditoria e logging | PARCIAL | Req 10 parcial |
| CI/CD automatizado | AUSENTE | Sem pipeline |
| SAST/DAST | AUSENTE | Sem analise estatica |

### 3.3 Dependencias externas

- **AWS Secrets Manager**: ja provisionado via Terraform — desbloqueia migracao de secrets
- **Git filter-repo**: ferramenta para remocao de historico — requer acesso ao repositorio Git
- **GitLab CI**: pipeline ja mapeado no pci-compliance-automation — precisa de runner configurado
- **Pentest externo (Req 11)**: pode demandar contratacao de empresa especializada

---

## 4. Decisoes Tecnicas

### 4.1 Arquitetura proposta

**Gestao de secrets (imediata):**
```
Atual:   .env file (hardcoded) → container
Alvo:    AWS Secrets Manager → EC2 instance role → secrets injetados em runtime
         (config-aws-cli.sh ja faz isso para alguns servicos — padronizar para todos)
```

**Pipeline CI/CD:**
```
Push → GitLab CI → tfsec (IaC) + checkov (IaC) + SAST (Source) → deploy-hml → aprovacao → deploy-prd
                 → pci-compliance-automation → relatorio PCI → notificacao
```

**Observabilidade para PCI:**
```
Apps → otel-collector (TLS corrigido) → Elasticsearch → Kibana (dashboard PCI)
     → CloudTrail → S3 (evidencias Req 10)
Zabbix agent → Zabbix server → alertas (seguranca: tentativas auth, portscan)
```

### 4.2 Trade-offs

| Decisao | Opcao escolhida | Alternativa descartada | Justificativa |
|---------|-----------------|----------------------|---------------|
| Secrets manager | AWS Secrets Manager | HashiCorp Vault | Ja existe no Terraform, integrado com IAM |
| Pipeline | GitLab CI | GitHub Actions | Ja mapeado no pci-compliance-automation |
| Orquestracao | Docker Compose (manter) | Migrar para Kubernetes | Kubernetes adicionaria complexidade sem beneficio no prazo PCI |
| Checkers PCI | Python (manter) | Framework externo (Scout Suite) | Controle total do codigo, ja existente |

### 4.3 Riscos

| Risco | Probabilidade | Impacto | Mitigacao |
|-------|---------------|---------|-----------|
| Credenciais expostas comprometidas antes da rotacao | Alta | Critico | Revogar IAM imediatamente (Dia 1) |
| Pentest externo (Req 11) nao contratado a tempo | Media | Alto | Iniciar processo de contratacao na Sprint 066 |
| Microsservicos quebrando apos migracao de secrets | Media | Alto | Testar em dev/hml antes de prd |
| Acesso ao historico Git por terceiros | Alta | Critico | git filter-repo + force push como P0 |
| Scope PCI (quais sistemas sao in-scope) | Media | Alto | Definir CDE (Cardholder Data Environment) formalmente |

---

## 5. Priorizacao

### 5.1 Must-have P0 — Remediacao critica (Sprint 066-067, Mar 2026)

1. Revogar credenciais AWS IAM expostas (imediato)
2. Rotacionar senhas de banco (MongoDB, PostgreSQL, Redis, RabbitMQ)
3. Migrar credenciais para AWS Secrets Manager (todos os microsservicos)
4. Remover `.env` do historico Git
5. Corrigir Grafana (desabilitar acesso anonimo, senha forte)
6. Corrigir TLS insecure no otel-collector
7. Desabilitar debug mode em producao
8. Corrigir containers rodando como root (criticos)
9. Remover portas de debug expostas

### 5.2 Should-have P1 — Hardening e conformidade (Sprint 068-070, Abr-Mai 2026)

10. Implementar headers de seguranca HTTP (nginx)
11. Integrar tfsec + checkov no pipeline IaC
12. Revisar IAM policies (principio minimo privilegio)
13. Implementar checkers PCI: Req 2, 3, 4, 5, 6, 7, 8, 10, 11
14. Criar pipeline CI/CD GitLab (build + deploy-hml)
15. Dashboard Kibana para auditoria PCI

### 5.3 Nice-to-have P2 — Excelencia operacional (Sprint 071-073, Mai-Jun 2026)

16. Implementar checkers PCI: Req 12, 13
17. Documentar modulos Terraform (README)
18. Deploy-prd automatizado com aprovacao manual
19. SAST nos microsservicos (Source)
20. Alertas Zabbix para eventos de seguranca
21. Relatorio consolidado PCI Q2 com evidencias de certificacao

### 5.4 Criterios de priorizacao

- **Impacto de seguranca**: credenciais expostas = risco imediato de comprometimento → P0 absoluto
- **Bloqueio PCI**: sem gestao de secrets, nenhum requisito PCI pode ser considerado conforme → P0
- **Dependencias tecnicas**: secrets devem estar migrados antes de implementar checkers PCI → sequencia respeitada
- **Valor entregue**: cada sprint deve entregar reducao mensuravel no numero de vulnerabilidades abertas

---

## 6. Estimativa de Esforco

| Categoria | Tasks estimadas | Pontos estimados | Sprints estimados |
|-----------|----------------|------------------|-------------------|
| P0 - Remediacao critica | 10 | 26 | 1.5 |
| P1 - Hardening + PCI | 14 | 42 | 2.5 |
| P2 - Excelencia operacional | 10 | 28 | 1.5 |
| **Total** | **34** | **96** | **~6** |

Capacidade disponivel: 8 sprints × 21 SP = 168 SP
Margem de buffer: ~72 SP (para tasks nao mapeadas, retrabalho, bugs)

---

## 7. Roadmap Visual

```
Q1 2026 — FOCO: REMEDIACAO CRITICA
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Sprint 066  |  1 Mar - 14 Mar  |  21 SP
  [P0] Revogar IAM + Rotacionar credenciais DB
  [P0] Secrets Manager: plataforma (ms-authenticator, ms-webhook, ms-domain-report)
  [P0] Remover .env do Git

Sprint 067  |  15 Mar - 28 Mar  |  21 SP
  [P0] Secrets Manager: gateways (pix, online, presencial) + Docker services
  [P0] Corrigir Grafana + TLS otel-collector + debug mode + root containers
  [P0] Headers HTTP nginx
  [P1] tfsec + checkov no pipeline IaC
  OKR-Q1: Vulnerabilidades criticas → 0

Q2 2026 — FOCO: HARDENING E CONFORMIDADE PCI
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Sprint 068  |  6 Abr - 19 Abr  |  21 SP
  [P1] Checkers PCI: Req 2 + Req 3 (critico) + Req 8
  [P1] Revisao IAM policies (principio minimo privilegio)

Sprint 069  |  20 Abr - 3 Mai  |  21 SP
  [P1] Checkers PCI: Req 4 + Req 5 + Req 6 (SAST)
  [P1] Pipeline CI/CD: build + test + deploy-hml

Sprint 070  |  4 Mai - 17 Mai  |  21 SP
  [P1] Checkers PCI: Req 7 + Req 10 + Req 11 (pentest)
  [P1] Dashboard Kibana auditoria PCI

Sprint 071  |  18 Mai - 31 Mai  |  21 SP
  [P2] Checkers PCI: Req 12 + Req 13 (vuln management)
  [P2] Pipeline CI/CD: deploy-prd com aprovacao
  [P2] Alertas Zabbix seguranca

Sprint 072  |  1 Jun - 14 Jun  |  21 SP
  [P2] Documentacao modulos Terraform
  [P2] SAST microsservicos (Source)
  [P2] Relatorio consolidado PCI — preparacao para certificacao

Sprint 073  |  15 Jun - 28 Jun  |  21 SP
  Buffer / Revisao final / Remediacao de findings de pentest
  Milestone: Score PCI >= 85%, Certificacao PCI iniciada
```

---

## 8. Criterios de Sucesso

Vinculados aos OKRs propostos:

| KR | Metrica | Baseline | Alvo Q1 | Alvo Q2 |
|----|---------|----------|---------|---------|
| Vulnerabilidades criticas abertas | 12 | 12 | 0 | 0 |
| Score de seguranca | 25/100 | 25 | 60+ | 85+ |
| Checkers PCI implementados | 1/14 | 1 | 3 | 12 |
| Credenciais expostas no Git | 12+ | 12 | 0 | 0 |
| Pipeline CI/CD IaC ativo | Nao | Nao | Sim | Sim |
| Conformidade PCI-DSS | Nao conforme | Nao conforme | Parcial | Conforme |

---

## 9. Historico de Revisoes

| Data | Autor | Mudanca |
|------|-------|---------|
| 2026-02-23 | claude-code | Criacao inicial — Q1+Q2 2026 |
