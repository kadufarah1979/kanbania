---
id: TASK-0654
title: "useAquariumWS — hook WebSocket com reconexao exponencial + aquariumStore"
project: aquario
subproject: app-android
sprint: null
okr: OKR-2026-Q2-11
priority: high
labels: [feature, mobile, infra]
story_points: 2
created_at: "2026-02-26T00:00:00-03:00"
created_by: "claude-code"
assigned_to: codex
review_requested_from: [codex]
depends_on: [TASK-0652]
blocks: [TASK-0653]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-26T00:00:00-03:00"
  - agent: "claude-code"
    action: implemented
    date: "2026-02-26T00:00:00-03:00"
  - agent: "claude-code"
    action: moved_to_review
    date: "2026-02-26T00:00:00-03:00"
---

## Descricao

Implementar o hook `useAquariumWS` para conexao WebSocket em tempo real com o backend, e o `aquariumStore` Zustand para manter o estado de leituras ao vivo por aquario.

## Criterios de Aceitacao

- [x] `src/shared/stores/aquariumStore.ts`:
  - State: `liveReadings: Record<aquariumId, Reading[]>`, `liveRelays: Record<aquariumId, Relay[]>`, `wsConnected: Record<aquariumId, boolean>`
  - Actions: `setLiveReadings`, `setLiveRelays`, `setWsConnected`
  - Sem persistencia (estado volatile — nao usar MMKV)
- [x] `src/shared/hooks/useAquariumWS.ts`:
  - Conecta em `WS_BASE_URL/ws/aquariums/{aquariumId}?token={accessToken}`
  - `onopen`: seta `wsConnected[id] = true`
  - `onmessage`: parseia tipo (`reading`, `alert`, `device_status`) e atualiza queryClient ou aquariumStore
  - `onclose`: reconexao com backoff exponencial (1s, 2s, 4s, 8s, 16s, 30s max — 5 tentativas)
  - Apos max tentativas: `wsConnected[id] = false`, habilita REST polling como fallback
  - Reconecta quando app volta ao foreground (AppState listener)
  - `cleanup`: `ws.close()` no unmount
- [ ] `OfflineRelay` indicator: quando `wsConnected = false`, mostrar badge "Ao vivo indisponivel"

## Notas Tecnicas

- Ref: `mobile/ux/OFFLINE_STRATEGY.md` secao 9
- Ref: `mobile/ux/STORES.md` secao aquariumStore
- Token no WS URL (query param) — nao no header (WebSocket API nativa nao suporta headers customizados)
- Ao receber `reading`: `queryClient.setQueryData(queryKeys.aquariums.readings.latest(id), ...)`
- Ao receber `alert`: `queryClient.invalidateQueries(queryKeys.aquariums.alerts.active(id))`

## Notas de Implementacao

- `aquariumStore.ts` ja possuia `setWsConnected` completo — nenhuma alteracao necessaria
- `useAquariumWS.ts` criado em `mobile/src/shared/hooks/`
- Backoff exponencial: 1s, 2s, 4s, 8s, 16s (MAX_ATTEMPTS=5, delay max 30s)
- `mergeReadings` mantém ultimas 50 leituras por parametro no queryClient cache
- AppState listener reconecta ao voltar ao foreground
