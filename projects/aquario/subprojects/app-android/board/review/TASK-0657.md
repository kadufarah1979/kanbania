---
id: TASK-0657
title: "Push notifications FCM end-to-end — firebase_admin, canais Android, deep links"
project: aquario
subproject: app-android
sprint: null
okr: OKR-2026-Q2-11
priority: high
labels: [feature, mobile, infra]
story_points: 3
created_at: "2026-02-26T00:00:00-03:00"
created_by: "claude-code"
assigned_to: codex
review_requested_from: [codex]
depends_on: [TASK-0652, TASK-0660]
blocks: []
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-26T00:00:00-03:00"
  - agent: "claude-code"
    action: started
    date: "2026-02-26T00:00:00-03:00"
  - agent: "claude-code"
    action: submitted_for_review
    date: "2026-02-26T00:00:00-03:00"
---

## Descricao

Implementar o sistema de push notifications FCM end-to-end: configuracao no app (canais Android, permissao POST_NOTIFICATIONS), envio do token FCM ao backend e handling dos 3 estados do app (foreground, background, killed).

## Criterios de Aceitacao

- [ ] `notificationStore.ts`: `fcmToken`, `pushPermission`, `preferences` por tipo
- [ ] Canais Android configurados no boot do app:
  - `aquabook_alerts`: prioridade HIGH, bypassa DND, som customizado
  - `aquabook_default`: prioridade DEFAULT
- [ ] Permissao `POST_NOTIFICATIONS` solicitada apos 1o login (nunca na abertura do app)
- [ ] `registerForPushNotificationsAsync()`: pede permissao, obtem Expo Push Token, envia para `POST /api/v1/notifications/fcm-token` (TASK-0660 backend)
- [ ] Foreground handler: `Notifications.setNotificationHandler` — mostrar banner + som + badge
- [ ] Background: SO cuida — navegar para tela correta via deep link
- [ ] App killed: `getLastNotificationResponseAsync()` no boot — navegar para tela correta
- [ ] `handleDeepLink(url)`: mapeia `aquabook://aquarium/{id}` → AquariumDetail, `aquabook://chat/{id}` → ChatDetail, etc.
- [ ] Token refresh listener: `onTokenRefresh` — atualizar backend automaticamente
- [ ] Logout: `DELETE /api/v1/notifications/fcm-token` com token atual

## Notas Tecnicas

- Ref completa: `mobile/ux/PUSH_NOTIFICATIONS.md`
- Backend: usar Expo Push Notifications API (abstrai FCM + APNs) via `firebase_admin.send_each()`
- `expo-notifications` para handling, `expo-device` para verificar se e dispositivo fisico
- Token simulador = null — nao travar o app, apenas logar warning
- Dependencia: TASK-0660 (backend endpoint FCM token)
