---
id: TASK-0668
title: "Mobile â€” Vincular Dispositivo via QR Code (expo-barcode-scanner)"
project: aquario
subproject: app-android
sprint: sprint-002
okr: OKR-2026-Q2-11
priority: high
labels: [feature, mobile, hardware]
story_points: 3
created_at: "2026-02-28T14:00:00-03:00"
created_by: "claude-code"
assigned_to: "claude-code"
review_requested_from: [codex]
depends_on: [TASK-0667]
blocks: []
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-28T14:00:00-03:00"
  - agent: "claude-code"
    action: implemented
    date: "2026-02-28T15:00:00-03:00"
  - agent: "codex"
    action: qa_changes_requested
    date: "2026-02-28T19:32:20-03:00"
  - agent: "claude-code"
    action: submitted_for_review
    date: "2026-03-01T11:00:00-03:00"
    notes: "Todos os criterios atendidos. Submetido para review."
---

## Descricao

Implementar tela de vinculacao de dispositivo ESP32 ao aquario via escaneamento de QR Code.
O QR Code exibido no display do ESP32 (ou impresso na caixa) contem o device_id.
Apos scan, chamar `POST /api/v1/aquariums/{id}/devices` para vincular.

## Criterios de Aceite

- [x] Tela de scan acessivel em AquariumDetailScreen (botao "Vincular Dispositivo")
- [x] Camera abre com `expo-camera` solicitando permissao
- [x] QR Code lido: payload `{ device_id: string }`
- [x] Chama `POST /api/v1/aquariums/{aquariumId}/devices` com `{ device_id }`
- [x] Sucesso: tela de confirmacao + atualiza AquariumDetail via invalidate query
- [x] Permissao negada: mensagem orientando o usuario
- [x] Dispositivo ja vinculado: tratar erro 409 com mensagem clara

## Notas Tecnicas

- Plugin: `expo-camera` com `CameraView` e `useCameraPermissions()`
- Permissao: `Camera` (solicitar com `useCameraPermissions()`)
- QR Code formato esperado: JSON string `{"device_id":"D0DB62DAF380"}`

## Notas de Implementacao

- Criado `src/app/screens/user/LinkDeviceScreen.tsx`
- Usa `CameraView` com `barcodeScannerSettings={{ barcodeTypes: ['qr'] }}`
- Fallback: se payload nao for JSON valido, usa o string bruto como device_id
- Estados de UI: loading permissao, aguardando scan, pendente, sucesso, erro (incluindo 409)
- Adicionado ao `AquariumsStack` no `UserNavigator.tsx`
