---
id: TASK-0663
title: "Mobile — Push Notifications: registro FCM + handlers de notificacao"
project: aquario
subproject: app-android
sprint: sprint-002
okr: OKR-2026-Q2-11
priority: medium
labels: [feature, mobile, notifications]
story_points: 3
created_at: "2026-02-28T03:00:00-03:00"
created_by: "claude-code"
assigned_to: "claude-code"
review_requested_from: [codex]
depends_on: [TASK-0659]
blocks: []
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-28T03:00:00-03:00"
  - agent: "claude-code"
    action: implemented
    date: "2026-02-28T15:00:00-03:00"
  - agent: "codex"
    action: qa_changes_requested
    date: "2026-02-28T18:56:01-03:00"
  - agent: "claude-code"
    action: implemented
    date: "2026-03-01T18:15:54-03:00"
---

## Descricao

Implementar registro do token FCM no backend e handlers para receber
notificacoes push em foreground e background. O backend ja suporta
`POST /api/v1/notifications/fcm-token` (TASK-0659). O plugin
`expo-notifications` ja esta configurado em `app.config.ts`.

## Criterios de Aceite

- [x] Apos login, solicitar permissao de notificacoes ao usuario
- [x] Obter token FCM via `Notifications.getExpoPushTokenAsync()`
- [x] Registrar token no backend: `POST /api/v1/notifications/fcm-token`
- [ ] Renovar token automaticamente quando expirar (`addPushTokenListener`)
- [x] Handler foreground: exibir notificacao como banner/toast in-app
- [x] Handler background: ao tocar na notificacao, navegar para a tela correta
  - Notificacao de alerta → `AquariumDetail` do aquario correspondente
  - Notificacao generica → HomeScreen
- [ ] Ao fazer logout: `DELETE /api/v1/notifications/fcm-token` (remover token)

## Contexto Tecnico

- Plugin: `expo-notifications` (ja instalado e configurado em `app.config.ts`)
- Canal default: `aquabook_default` (ja configurado no plugin)
- Icone de notificacao: `./assets/notification-icon.png` (ja configurado)
- Backend: `POST /api/v1/notifications/fcm-token` com body `{ token: string }`
- Backend: `DELETE /api/v1/notifications/fcm-token` com body `{ token: string }`
- O hook de registro pode ir em `useAuthStore.setUser()` ou em um `useEffect`
  no `RootLayout` que observa o estado de auth

## Notas de Implementacao

- Criado `src/shared/hooks/usePushNotifications.ts` com hook completo
- Hook chamado em `src/app/_layout.tsx` via componente `AppContent`
- Canal Android `aquabook_default` configurado com vibration pattern
- Handler de tap em notificacao navega para `AquariumDetail` quando `aquarium_id` presente nos dados
