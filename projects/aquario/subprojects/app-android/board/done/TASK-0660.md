---
id: TASK-0660
title: "Backend â€” DeletionRequest model + DELETE /auth/account + job diario de exclusao"
project: aquario
subproject: app-android
sprint: null
okr: OKR-2026-Q2-11
priority: critical
labels: [feature, mobile, security]
story_points: 3
created_at: "2026-02-26T00:00:00-03:00"
created_by: "claude-code"
assigned_to: null
review_requested_from: [codex]
depends_on: []
blocks: []
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-26T00:00:00-03:00"
  - agent: "claude-code"
    action: started
    date: "2026-02-26T12:00:00-03:00"
  - agent: "claude-code"
    action: submitted_for_review
    date: "2026-02-26T12:30:00-03:00"
  - agent: "codex"
    action: approved
    date: "2026-02-26T18:00:00-03:00"
---

## Descricao

Implementar o sistema de exclusao de conta exigido pelo Google Play (Dec 2023) e LGPD Art. 18 VI. Grace period de 30 dias com possibilidade de cancelamento. Job diario executa as exclusoes agendadas.

## Criterios de Aceitacao

- [x] Model `DeletionRequest`: `id`, `user_id`, `requested_at`, `scheduled_at` (+30d), `executed_at`, `status` (pending/cancelled/executed), `confirmation_token`
- [x] Migration Alembic: tabela `deletion_requests`
- [x] `DELETE /api/v1/auth/account` (autenticado):
  - Body: `{ password?: str, confirmation_token?: str }` (token para OAuth users)
  - Cria `DeletionRequest` com status `pending`
  - Deleta imediatamente: tokens FCM, push subscriptions
  - Retorna: `{ scheduled_at, cancellation_deadline }`
- [x] `POST /api/v1/auth/account/cancel-deletion` (autenticado):
  - Cancela `DeletionRequest` pendente
- [x] `POST /api/v1/auth/account/request-deletion-by-email` (publico, rate limited):
  - Para URL publica `aquabook.app/excluir-conta`
  - Rate limit 3 req/hora por IP, resposta generica (nao vaza existencia de conta)
- [x] Job `deletion_job_loop` (diario as 04h00 BRT):
  - Busca `DeletionRequest` com `status=pending` e `scheduled_at <= now`
  - Deleta: readings, aquariums, posts, comentarios, likes, amizades, notificacoes
  - Anonimiza: transacoes financeiras (buyer_id/seller_id -> NULL)
  - Seta `executed_at`, `status=executed`
- [x] Re-login durante grace period: `GET /me` retorna `pending_deletion` com `scheduled_at` e `cancellation_deadline`
- [x] Job registrado no lifespan com flag `DELETION_JOB_ENABLED`
- [x] Health check `/health/ready` monitora `deletion_job`

## Notas Tecnicas

- Ref completa: `mobile/ux/ACCOUNT_DELETION.md`
- URL publica obrigatoria para Play Console: `https://aquabook.app/excluir-conta`
- Readings (TimescaleDB): DELETE via raw SQL antes de apagar aquariums
- Transacoes financeiras: UPDATE buyer_id/seller_id = NULL (anonimizacao, nao exclusao)
- Migration: `r1s2t3u4v5w6_add_deletion_requests.py`
- Branch: `task/TASK-0660`

## Implementacao

- `backend/app/models/deletion_request.py`: ORM model com UUID nativo (PostgreSQL dialect)
- `backend/alembic/versions/r1s2t3u4v5w6_add_deletion_requests.py`: migration com indices
- `backend/app/schemas/auth.py`: AccountDeletionRequest, AccountDeletionResponse, RequestDeletionByEmailRequest
- `backend/app/api/v1/auth.py`: 3 novos endpoints + /me atualizado
- `backend/app/jobs/deletion_job.py`: loop diario seguindo padrao de data_retention_job.py
- `backend/app/main.py`: registro do deletion_job_loop no lifespan + health check
