---
id: TASK-0651
title: "queryClient TanStack Query v5 + persister MMKV + queryKeys + staleTimes"
project: aquario
subproject: app-android
sprint: sprint-001
okr: OKR-2026-Q2-11
priority: high
labels: [feature, mobile, infra]
story_points: 2
created_at: "2026-02-26T00:00:00-03:00"
created_by: "claude-code"
assigned_to: claude-code
review_requested_from: []
depends_on: [TASK-0647]
blocks: [TASK-0652]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-26T00:00:00-03:00"
  - agent: "claude-code"
    action: auto-approved
    date: "2026-02-26T00:02:00-03:00"
    note: "Implementado como parte do TASK-0647 — queryClient.ts, queryKeys.ts, staleTimes.ts, useNetworkStatus.ts, useAppStateRefresh.ts criados"
---

## Descricao

Configurar o TanStack Query v5 com persistencia em MMKV, definir a estrutura hierarquica de query keys e os stale times por tipo de dado. Base do sistema de cache offline-first do app.

## Criterios de Aceitacao

- [ ] `src/shared/api/queryClient.ts`:
  - `QueryClient` com retry logic (nao retenta 4xx, max 2 tentativas para outros)
  - `createAsyncStoragePersister` com MMKV adapter, throttle 3s
  - `persistQueryClient` com maxAge 7 dias
  - `dehydrateOptions.shouldDehydrateQuery` excluindo: `auth`, `messages`, `chat-detail`
- [ ] `src/shared/api/queryKeys.ts` — estrutura hierarquica completa:
  - `auth`, `aquariums` (list, detail, params, readings, alerts, relays, automation, livestock, maintenance, equipment, photos), `feed`, `chat`, `notifications`, `store`, `catalog`, `pro`
- [ ] `src/shared/api/staleTimes.ts` — stale times por recurso:
  - `latestReadings: 0`, `activeAlerts: 30s`, `aquariumList: 2min`, `readingHistory: 5min`, `userProfile: 10min`, `species: 1h`, `badges: Infinity`
- [ ] `src/shared/hooks/useNetworkSync.ts` — sincroniza `onlineManager` TQ com NetInfo
- [ ] `src/shared/hooks/useAppStateRefresh.ts` — `focusManager.setFocused` no AppState change
- [ ] `QueryClientProvider` no root layout com `PersistQueryClientProvider`

## Notas Tecnicas

- Ref completa: `mobile/ux/OFFLINE_STRATEGY.md` secoes 3, 4 e 5
- `@tanstack/react-query-persist-client` e `@tanstack/query-async-storage-persister` sao pacotes separados
- MMKV adapter: `setItem` sync (MMKV e sync), mas interface exige Promise — retornar `Promise.resolve()`
- `refetchOnWindowFocus: true` e `refetchOnReconnect: true` por padrao
