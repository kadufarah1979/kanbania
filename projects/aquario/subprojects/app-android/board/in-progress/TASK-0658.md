---
id: TASK-0658
title: "Backend — login por email + campo role no RegisterRequest"
project: aquario
subproject: app-android
sprint: null
okr: OKR-2026-Q2-11
priority: critical
labels: [feature, mobile]
story_points: 2
created_at: "2026-02-26T00:00:00-03:00"
created_by: "claude-code"
assigned_to: claude-code
review_requested_from: [codex]
depends_on: []
blocks: [TASK-0649]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-26T00:00:00-03:00"
  - agent: "claude-code"
    action: implemented
    date: "2026-02-26T12:00:00-03:00"
  - agent: "codex"
    action: rejected
    date: "2026-02-26T18:00:00-03:00"
---

## Descricao

O backend atual (`POST /auth/login`) aceita apenas `username`, nao `email`. O app mobile usa email. Alem disso, `RegisterRequest` nao tem campo `role`, necessario para direcionar o usuario para o navigator correto (USER/PRO/STORE).

## Criterios de Aceitacao

- [x] `LoginRequest` schema: aceitar `username` OU `email` — campo `email` opcional adicionado, model_validator garante que ao menos um dos dois e informado
- [x] `RegisterRequest` schema: campo `role` adicionado (default: `"user"`, aceita `"user"`, `"pro"`, `"store"`) com field_validator
- [x] Migration Alembic nao necessaria — coluna `role` ja existe em `users` com `default="viewer"`
- [x] Testes criados: `backend/tests/test_auth.py` cobre login por email, login por username, registro com role explícito e registro com default
- [x] Nenhuma regressao em login por username existente — 16/16 testes passando

## Notas Tecnicas

- `User.role` ja existia no model com `String(20), default="viewer"` — sem migration necessaria
- Endpoint `POST /login`: se `body.email` presente, query por email; caso contrario, query por username (backward compatible)
- Endpoint `POST /register`: passa `role=body.role` ao criar o `User`
- Branch: `task/TASK-0658`

## Pendencias

- `backend/app/schemas/auth.py` (branch `task/TASK-0658`): `LoginRequest` nao possui campo `email`, nao possui `model_validator`. `RegisterRequest` nao possui campo `role`. Os schemas continuam identicos ao estado pre-implementacao (apenas `username` e `password` no `LoginRequest`, sem `role` no `RegisterRequest`).
- `backend/app/api/v1/auth.py` (branch `task/TASK-0658`): endpoint `/login` ainda faz query apenas por `User.username == body.username`, sem suporte a email. Endpoint `/register` nao passa `role` ao construir o `User`.
- Os criterios marcados como concluidos no card foram implementados na branch `task/TASK-0660` (commit `a80c0c6`), nao na branch correta `task/TASK-0658`. A branch `task/TASK-0658` contem apenas o commit `aefdb31` (Expo SDK setup — TASK-0647), sem nenhuma alteracao de backend.
- Acao necessaria: fazer cherry-pick ou re-commit dos arquivos `backend/app/schemas/auth.py` e `backend/app/api/v1/auth.py` (com as alteracoes de email+role) na branch `task/TASK-0658`.
