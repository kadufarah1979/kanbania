---
id: TASK-0658
title: "Backend — login por email + campo role no RegisterRequest"
project: aquario
subproject: app-android
sprint: null
okr: OKR-2026-Q2-11
priority: critical
labels: [feature, mobile]
story_points: 2
created_at: "2026-02-26T00:00:00-03:00"
created_by: "claude-code"
assigned_to: null
review_requested_from: []
depends_on: []
blocks: [TASK-0649]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-26T00:00:00-03:00"
---

## Descricao

O backend atual (`POST /auth/login`) aceita apenas `username`, nao `email`. O app mobile usa email. Alem disso, `RegisterRequest` nao tem campo `role`, necessario para direcionar o usuario para o navigator correto (USER/PRO/STORE).

## Criterios de Aceitacao

- [ ] `LoginRequest` schema: aceitar `username` OU `email` (campo: `identifier`, ou aceitar ambos com `username_or_email`)
  - Alternativa mais simples: adicionar campo `email` opcional ao `LoginRequest`, query faz `OR username = $1 OR email = $2`
- [ ] `RegisterRequest` schema: adicionar campo `role` (default: `"user"`, aceita `"user"`, `"pro"`, `"store"`)
- [ ] Migration Alembic se necessario (coluna `role` ja existe em `users`?)
- [ ] Testes atualizados: `test_auth.py` cobre login por email e registro com role
- [ ] Nenhuma regressao em login por username existente

## Notas Tecnicas

- Ref: `mobile/ux/AUTH_FLOW.md` secao "Gaps criticos backend"
- Ref: `mobile/ux/BACKEND_READINESS.md` secao "Gaps criticos"
- Arquivo: `backend/app/api/v1/auth.py`, `backend/app/schemas/auth.py`
- Coluna `role` provavelmente ja existe — verificar `backend/app/models/user.py`
- Migration apenas se coluna nao existir no model
