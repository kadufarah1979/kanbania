---
id: TASK-0660
title: "Backend â€” DeletionRequest model + DELETE /auth/account + job diario de exclusao"
project: aquario
subproject: app-android
sprint: null
okr: OKR-2026-Q2-11
priority: critical
labels: [feature, mobile, security]
story_points: 3
created_at: "2026-02-26T00:00:00-03:00"
created_by: "claude-code"
assigned_to: null
review_requested_from: []
depends_on: []
blocks: []
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-26T00:00:00-03:00"
---

## Descricao

Implementar o sistema de exclusao de conta exigido pelo Google Play (Dec 2023) e LGPD Art. 18 VI. Grace period de 30 dias com possibilidade de cancelamento. Job diario executa as exclusoes agendadas.

## Criterios de Aceitacao

- [ ] Model `DeletionRequest`: `id`, `user_id`, `requested_at`, `scheduled_at` (+30d), `executed_at`, `status` (pending/cancelled/executed), `confirmation_token`
- [ ] Migration Alembic: tabela `deletion_requests`
- [ ] `DELETE /api/v1/auth/account` (autenticado):
  - Body: `{ password?: str, confirmation_token?: str }` (token para OAuth users)
  - Cria `DeletionRequest` com status `pending`
  - Deleta imediatamente: tokens FCM, push subscriptions, sessoes ativas
  - Retorna: `{ scheduled_at, cancellation_deadline }`
- [ ] `POST /api/v1/auth/account/cancel-deletion` (autenticado):
  - Cancela `DeletionRequest` pendente (se ainda dentro do grace period)
- [ ] `POST /api/v1/auth/account/request-deletion-by-email` (publico, rate limited):
  - Para URL publica `aquabook.app/excluir-conta`
  - Envia email com link de confirmacao
- [ ] Job APScheduler `execute_pending_deletions` (diario):
  - Busca `DeletionRequest` com `status=pending` e `scheduled_at <= now`
  - Deleta: perfil, aquarios, readings, posts, comentarios, amizades
  - Anonimiza: transacoes financeiras (mantidas 5 anos)
  - Seta `executed_at`, `status=executed`
- [ ] Re-login durante grace period: informar que exclusao esta agendada + opcao de cancelar

## Notas Tecnicas

- Ref completa: `mobile/ux/ACCOUNT_DELETION.md`
- URL publica obrigatoria para Play Console: `https://aquabook.app/excluir-conta`
- Readings (TimescaleDB): `DELETE FROM readings WHERE aquarium_id IN (SELECT id FROM aquariums WHERE user_id = $1)`
- Transacoes financeiras: `UPDATE transactions SET user_id = NULL, user_name = 'Conta Excluida' WHERE user_id = $1`
- Rate limit no endpoint publico: max 3 requests/hora por email
