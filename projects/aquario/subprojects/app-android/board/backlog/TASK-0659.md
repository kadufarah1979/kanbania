---
id: TASK-0659
title: "Backend — modelo FcmToken + endpoints POST/DELETE /notifications/fcm-token"
project: aquario
subproject: app-android
sprint: null
okr: OKR-2026-Q2-11
priority: high
labels: [feature, mobile, infra]
story_points: 2
created_at: "2026-02-26T00:00:00-03:00"
created_by: "claude-code"
assigned_to: null
review_requested_from: []
depends_on: []
blocks: [TASK-0657]
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-26T00:00:00-03:00"
---

## Descricao

O backend usa pywebpush (Web Push / VAPID) para notificacoes. O app mobile precisa de FCM. Adicionar suporte a FCM sem remover o Web Push existente: novo model `FcmToken`, novos endpoints e integracao com `firebase_admin` no `notification_service.py`.

## Criterios de Aceitacao

- [ ] Model `FcmToken`: `id`, `user_id` (FK), `token` (string, unique), `platform` (android/ios), `created_at`
- [ ] Migration Alembic: tabela `fcm_tokens`
- [ ] `POST /api/v1/notifications/fcm-token` (autenticado):
  - Body: `{ token: str, platform: "android" | "ios" }`
  - Upsert: se token ja existe para o user, atualiza; se nao, insere
  - Response: `{ id, token, platform, created_at }`
- [ ] `DELETE /api/v1/notifications/fcm-token` (autenticado):
  - Body: `{ token: str }`
  - Remove token do banco (logout ou desativacao de push)
- [ ] `notification_service.py`: adicionar `send_fcm_notification(user_id, title, body, data)`:
  - Busca `FcmToken` pelo `user_id`
  - Usa `firebase_admin.messaging.send_each([Message(...)])`
  - `AndroidConfig`: `channel_id = "aquabook_alerts"` para alertas, `"aquabook_default"` para outros
  - Em `InvalidRegistrationToken`: deletar token do banco automaticamente
- [ ] `alert_service.py` e `chat_service.py`: chamar `send_fcm_notification` alem do Web Push existente
- [ ] `FIREBASE_CREDENTIALS_JSON` no `.env` e `docker-compose.yml`

## Notas Tecnicas

- Ref: `mobile/ux/PUSH_NOTIFICATIONS.md` secoes 2, 3 e 5
- `firebase_admin` via pip: `firebase-admin>=6.0.0`
- Credenciais Firebase: JSON do service account (nao committar — usar env var ou secrets)
- Web Push existente: NAO remover, continuar funcionando para PWA
