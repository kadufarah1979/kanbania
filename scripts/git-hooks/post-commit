#!/usr/bin/env bash
# post-commit â€” Detecta tasks movidas para board/done/ e publica no X.
# Instalado por: scripts/install-git-hooks.sh

ROOT="$(git rev-parse --show-toplevel)"
SCRIPT="$ROOT/scripts/post-to-x.js"

# Requer Node.js
if ! command -v node &>/dev/null; then
  exit 0
fi

# Script nao existe (integracao nao instalada)
if [ ! -f "$SCRIPT" ]; then
  exit 0
fi

# Detecta arquivos adicionados em board/done/ neste commit
DONE_FILES=$(git diff-tree --no-commit-id -r --name-only --diff-filter=A HEAD \
  | grep -E "^board/done/TASK-[0-9]+\.md$")

if [ -z "$DONE_FILES" ]; then
  exit 0
fi

for file in $DONE_FILES; do
  echo "[post-commit] Task concluida detectada: $file"
  # Roda em background para nao atrasar o commit
  node "$SCRIPT" "$file" >> /tmp/kanbania-x.log 2>&1 &
done

exit 0
