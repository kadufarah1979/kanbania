---
id: TASK-0548
title: "Refatorar módulo ALB para suportar host_header e create_listener"
project: mdm-terraform
subproject: null
sprint: sprint-076
okr: null
priority: high
labels:
  - terraform
  - refactor
  - infra
story_points: 3
created_at: "2026-02-24T00:00:00-03:00"
created_by: "claude-code"
assigned_to: "claude-code"
review_requested_from: []
depends_on: []
blocks:
  - TASK-0549
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-24T00:00:00-03:00"
  - agent: "claude-code"
    action: claim
    date: "2026-02-24T00:00:00-03:00"
---

## Descricao

Modificar `terraform/modules/alb/application.tf` para suportar dois novos comportamentos:

1. Flag `create_listener` (default true) no resource `aws_lb_listener.listener` — permite que apps sem listener dedicado (que vão usar um listener compartilhado na porta 443) não tentem criar seu próprio listener.
2. Suporte a condição `host_header` dinâmica no resource `aws_lb_listener_rule.rule`, além do `path_pattern` já existente — necessário para rotear tráfego por hostname no listener 443 compartilhado.

A mudança deve ser retrocompatível: stages que não usam os novos campos continuam funcionando sem qualquer alteração.

## Criterios de Aceite

- [ ] `create_listener` com default `true` funciona sem alteração nos stages existentes
- [ ] Quando `create_listener = false`, o resource `aws_lb_listener` não é criado (usando `count` ou `for_each`)
- [ ] `host_header` é suportado como condição opcional no `aws_lb_listener_rule.rule`
- [ ] Quando `host_header` não é informado, o comportamento anterior (somente `path_pattern`) é mantido
- [ ] `terraform validate` passa sem erros no módulo
- [ ] Nenhum stage existente requer alteração para acomodar as mudanças

## Contexto Tecnico

Arquivo principal: `terraform/modules/alb/application.tf`

O módulo ALB atualmente cria um listener dedicado por serviço. Para consolidar na porta 443 compartilhada (do portal), os serviços apiGateway, apiMdm, apiMedia, apiGtkong e kafkaControlCenter precisam usar `create_listener = false` e rotear via `host_header` no listener do portal.

A condição `host_header` no `aws_lb_listener_rule` usa o bloco `condition { host_header { values = [...] } }`.

## Notas de Progresso

### [2026-02-24 00:00] claude-code
Card criado. Primeiro card da sprint-076. Bloqueia TASK-0549.
