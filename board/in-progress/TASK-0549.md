---
id: TASK-0549
title: "Atualizar locals_load_balancer.tf do HML para porta 443"
project: mdm-terraform
subproject: null
sprint: sprint-076
okr: null
priority: high
labels:
  - terraform
  - infra
story_points: 3
created_at: "2026-02-24T00:00:00-03:00"
created_by: "claude-code"
assigned_to: "claude-code"
review_requested_from: []
depends_on:
  - TASK-0548
blocks:
  - TASK-0554
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-24T00:00:00-03:00"
  - agent: "claude-code"
    action: claim
    date: "2026-02-24T00:00:00-03:00"
---

## Descricao

Em `terraform/stage/hml/locals_load_balancer.tf`, migrar os serviços do ALB público que usam portas não-padrão para compartilhar o listener 443 do portal, utilizando roteamento por `host_header`.

Serviços a migrar:
- `apiGateway`: remover `listener_port = 8080`, adicionar `create_listener = false`, `listener_rules = true`, `host_header`, `priority`
- `apiMdm`: remover `listener_port = 12186`, adicionar `create_listener = false`, `listener_rules = true`, `host_header`, `priority`
- `apiMedia`: remover `listener_port = 12170`, adicionar `create_listener = false`, `listener_rules = true`, `host_header`, `priority`
- `apiGtkong`: remover `listener_port = 8001`, adicionar `create_listener = false`, `listener_rules = true`, `host_header`, `priority`
- `kafkaControlCenter`: remover `listener_port = 9021`, adicionar `create_listener = false`, `listener_rules = true`, `host_header`, `priority`

Os `host_header` devem corresponder aos hostnames dos respectivos serviços no ambiente HML (ex: `api.gateway.hml.mdm-hub.com.br`).

## Criterios de Aceite

- [ ] `apiGateway` configurado com `create_listener = false` e `host_header` correto, sem `listener_port = 8080`
- [ ] `apiMdm` configurado com `create_listener = false` e `host_header` correto, sem `listener_port = 12186`
- [ ] `apiMedia` configurado com `create_listener = false` e `host_header` correto, sem `listener_port = 12170`
- [ ] `apiGtkong` configurado com `create_listener = false` e `host_header` correto, sem `listener_port = 8001`
- [ ] `kafkaControlCenter` configurado com `create_listener = false` e `host_header` correto, sem `listener_port = 9021`
- [ ] Priorities únicas e sem conflito entre regras do listener 443
- [ ] `terraform validate` passa no stage hml

## Contexto Tecnico

Arquivo: `terraform/stage/hml/locals_load_balancer.tf`

Depende de TASK-0548 (módulo ALB deve suportar `create_listener` e `host_header` antes de usar aqui).

As priorities das regras do listener devem ser únicas. Sugestão de intervalos:
- portal: 100 (existente, não alterar)
- apiGateway: 200
- apiMdm: 210
- apiMedia: 220
- apiGtkong: 230
- kafkaControlCenter: 240

## Notas de Progresso

### [2026-02-24 00:00] claude-code
Card criado. Depende de TASK-0548. Bloqueia TASK-0554.
