---
id: TASK-0553
title: "Atualizar upstreams do Kong HML (media e mdm)"
project: mdm-terraform
subproject: null
sprint: sprint-076
okr: null
priority: medium
labels:
  - infra
story_points: 2
created_at: "2026-02-24T00:00:00-03:00"
created_by: "claude-code"
assigned_to: "claude-code"
review_requested_from: []
depends_on: []
blocks:
  - TASK-0555
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-24T00:00:00-03:00"
  - agent: "claude-code"
    action: claim
    date: "2026-02-24T00:00:00-03:00"
---

## Descricao

Via Kong Admin API no servidor apiGateway HML (10.2.37.14), atualizar os targets dos upstreams que apontam para portas não-padrão em domínios públicos:

- `media-upstream`: `api.media.hml.mdm-hub.com.br:12170` → `api.media.hml.mdm-hub.com.br:443`
- `mdm-upstream`: `api.mdm.hml.mdm-hub.com.br:12186` → `api.mdm.hml.mdm-hub.com.br:443`

Procedimento por upstream:
1. Adicionar novo target com porta 443 e `weight=100`
2. Listar targets atuais para obter o ID do target antigo
3. Deletar o target antigo

Pode ser feito sem janela de manutenção (Kong suporta atualização de targets com zero downtime).

## Criterios de Aceite

- [ ] `media-upstream` com target `api.media.hml.mdm-hub.com.br:443` ativo e `weight=100`
- [ ] Target antigo `api.media.hml.mdm-hub.com.br:12170` removido do `media-upstream`
- [ ] `mdm-upstream` com target `api.mdm.hml.mdm-hub.com.br:443` ativo e `weight=100`
- [ ] Target antigo `api.mdm.hml.mdm-hub.com.br:12186` removido do `mdm-upstream`
- [ ] Rotas do Kong funcionando após atualização (validar com curl via Kong)

## Contexto Tecnico

Kong Admin API: `http://10.2.37.14:8001` (via bastion ou rede interna HML)

Comandos de referência:

```bash
# Adicionar novo target
curl -X POST http://10.2.37.14:8001/upstreams/media-upstream/targets \
  -d "target=api.media.hml.mdm-hub.com.br:443&weight=100"

# Listar targets para pegar ID do antigo
curl http://10.2.37.14:8001/upstreams/media-upstream/targets

# Deletar target antigo (substituir {id} pelo ID real)
curl -X DELETE http://10.2.37.14:8001/upstreams/media-upstream/targets/{id}

# Repetir para mdm-upstream
```

## Notas de Progresso

### [2026-02-24 00:00] claude-code
Card criado. Tarefa operacional via Kong Admin API. Pode ser feita sem janela de manutenção. Bloqueia TASK-0555.
