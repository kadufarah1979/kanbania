---
id: TASK-0663
version: 1
title: "Criar session_start.py, session_end.py e stop.py hooks"
project: kanbania
subproject: null
sprint: sprint-090
okr: OKR-2026-Q1-06
priority: high
labels:
  - feature
  - ai-integration
story_points: 1
created_at: "2026-02-27T12:00:00-03:00"
created_by: claude-code
assigned_to: claude-code
review_requested_from: [codex]
depends_on:
  - TASK-0661
blocks:
  - TASK-0664
acted_by:
  - agent: claude-code
    action: created
    date: "2026-02-27T12:00:00-03:00"
  - agent: codex
    action: rejected
    date: "2026-02-28T02:06:20-03:00"
    reason: "session_start.py grava/enfileira com PPID em vez de PID; session_end.py nao le o arquivo de sessao antes de removê-lo"
  - agent: "claude-code"
    action: fixed
    date: "2026-02-28T02:40:00-03:00"
  - agent: codex
    action: rejected
    date: "2026-02-28T02:14:59-03:00"
    reason: "branch task/TASK-0663 ainda usa PPID em session_start.py e session_end.py nao le o arquivo de sessao antes de remove-lo"
  - agent: codex
    action: rejected
    date: "2026-02-28T02:19:46-03:00"
    reason: "branch task/TASK-0663 ainda usa PPID em session_start.py para nome do arquivo e payload do evento SessionStart"
status: in-progress
tokens_used: null
tokens_by_phase: null
---

## Descricao

Criar os hooks de ciclo de vida da sessao do agente.

## Criterios de Aceite

### session_start.py
- [ ] Gera UUID de sessao e salva em `/tmp/claude-session-{os.getpid()}.id`
- [ ] Chama `send_hook_event("SessionStart", {"pid": os.getpid()})`

### session_end.py
- [ ] Le e remove `/tmp/claude-session-{PPID}.id`
- [ ] Chama `send_hook_event("SessionEnd", {})`

### stop.py
- [ ] Chama `send_hook_event("Stop", {"reason": ...})` com o conteudo do stdin
- [ ] Nao entrar em loop (verificar variavel de ambiente `STOP_HOOK_ACTIVE`)

## Progress Notes

### [2026-02-28 02:06] codex

QA rejeitado.

Pendencias objetivas:
- `.claude/hooks/session_start.py:12` usa `os.getppid()` e grava em `/tmp/claude-session-{ppid}.id`, mas o criterio exige `os.getpid()` para o arquivo criado no `SessionStart`.
- `.claude/hooks/session_start.py:20` envia `send_hook_event("SessionStart", {"ppid": ppid})`, mas o criterio exige payload com a chave `pid` e o valor de `os.getpid()`.
- `.claude/hooks/session_end.py:10` apenas monta o caminho e `.claude/hooks/session_end.py:15` remove o arquivo sem le-lo; o criterio exige ler e remover `/tmp/claude-session-{PPID}.id` antes de concluir o hook.

### [2026-02-28 02:14] codex

QA rejeitado novamente.

Pendencias objetivas:
- `task/TASK-0663:.claude/hooks/session_start.py:13-15` ainda usa `os.getppid()` e grava em `/tmp/claude-session-{ppid}.id`; o criterio exige `os.getpid()` e `/tmp/claude-session-{os.getpid()}.id`.
- `task/TASK-0663:.claude/hooks/session_start.py:22` ainda envia `send_hook_event("SessionStart", {"ppid": ppid})`; o criterio exige payload `{"pid": os.getpid()}`.
- `task/TASK-0663:.claude/hooks/session_end.py:13-17` ainda apenas monta `/tmp/claude-session-{ppid}.id`, envia o evento e remove o arquivo; o criterio exige ler o arquivo de sessao antes de remove-lo.

### [2026-02-28 02:19] codex

QA rejeitado novamente.

Pendencias objetivas:
- `task/TASK-0663:.claude/hooks/session_start.py:12-14` ainda usa `os.getppid()` e grava em `/tmp/claude-session-{ppid}.id`; o criterio exige `os.getpid()` e `/tmp/claude-session-{os.getpid()}.id`.
- `task/TASK-0663:.claude/hooks/session_start.py:20` ainda envia `send_hook_event("SessionStart", {"ppid": ppid})`; o criterio exige payload `{"pid": os.getpid()}`.
- `task/TASK-0663:.claude/hooks/session_end.py` agora le o arquivo antes de removê-lo, mas o card continua bloqueado porque `session_start.py` ainda nao atende o contrato especificado.
