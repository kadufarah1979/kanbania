---
id: TASK-0533
title: "Firmware - debugar aprovacao ESP-NOW gateway e reflashar com firmware atualizado"
project: aquario
subproject: null
sprint: sprint-074
okr: null
priority: high
labels: [firmware, mqtt, debugging]
story_points: 3
created_at: "2026-02-24T00:00:00-03:00"
created_by: "claude-code"
assigned_to: "claude-code"
review_requested_from: [codex]
depends_on: []
blocks: []
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-24T00:00:00-03:00"
  - agent: "claude-code"
    action: claim
    date: "2026-02-24T12:00:00-03:00"
  - agent: "claude-code"
    action: implement
    date: "2026-02-25T01:00:00-03:00"
  - agent: "claude-code"
    action: implement
    date: "2026-02-25T02:30:00-03:00"
  - agent: "claude-code"
    action: implement
    date: "2026-02-25T04:00:00-03:00"
---

## Descricao

Continuacao do trabalho de ESP-NOW (firmware implementado no branch task/TASK-0421).
O pipeline de dados ESP-NOW esta parcialmente funcionando, mas ha dois problemas
bloqueando o fluxo completo ate o dashboard:

1. **Firmware desatualizado no gateway**: o gateway esta com firmware antigo que publica
   em `aquario/{device_id}/telemetry` em vez de `aquario/{device_id}/metrics/minute`.
   O novo firmware (que usa `metrics/minute` e `state`) esta no repo mas NAO foi flashado.

2. **Gateway nao recebe mensagem de aprovacao**: o gateway se conecta ao broker cloud
   em modo restrito (`approved_ = false`) e nao consegue subscrever ao topico de approval
   porque a subscricao foi negada pelo ACL quando o device ainda estava `unassociated`.

## Criterios de Aceite

- [x] Gateway flashado com firmware novo (publica em `metrics/minute` e `state`, nao `telemetry`)
- [x] Gateway recebe mensagem `approved` no topico `aquario/D0DB62DAF380/approval`
- [x] Serial do gateway mostra: `[INFO] Device approved by backend ACL. Full namespace enabled.`
- [x] Backend recebe mensagens `mqtt_register_received` do gateway no consumer log
- [x] Backend recebe mensagens `metrics/minute` do node ESP-NOW via gateway
- [x] Dashboard mostra leituras de temperatura do `node-temp-005D8634` em tempo real

## Contexto Tecnico

### Estado atual do codigo (branch task/TASK-0533, commitado e pushado)

**Arquivos modificados:**
- `firmware/src/espnow_receiver.cpp` - receiver via callback, publica em `metrics/minute` + `state`
- `backend/app/api/v1/admin.py` - endpoint PATCH /admin/devices/{device_id}/associate
- `backend/app/services/device_service.py` - dois fixes de ACL (ver abaixo)

**Commits na branch task/TASK-0533:**
- `b88cdc3 feat(admin): endpoint PATCH /admin/devices/{device_id}/associate`
- `63ce321 fix(mqtt-acl): permitir leitura do topico approval em restricted mode`
- `83eb141 fix(mqtt-acl): suportar acc=4 MOSQ_ACL_SUBSCRIBE do mosquitto 2.0+`

### Estado atual do hardware

**Gateway (D0DB62DAF380)**:
- Porta serial: /dev/ttyACM0
- DB producao: `association_status = 'associated'`, `aquarium_id = 77a4ec03... (Reef Sala)`
- Firmware atual: NOVO (reflashado, publica `metrics/minute`)
- MQTT cloud: conecta em `mqtt.aquabook.com.br` = `64.227.0.165`
- Mensagem retida `approved` publicada no broker: `aquario/D0DB62DAF380/approval`
- **Estado atual**: offline (sem output serial, possivel WiFi down ou device desligado)

**Node temperatura (node-temp-005D8634)**:
- Porta serial: /dev/ttyACM3
- Firmware: OK, enviando ESP-NOW no canal 11

### Bugs de ACL corrigidos (ambos em device_service.py)

**Bug 1 - Primeiro gate bloqueava acc=4:**
```python
# ANTES (buggy):
if acc not in (1, 2, 3):
    return False

# DEPOIS (fix):
# acc=4 = MOSQ_ACL_SUBSCRIBE (mosquitto 2.0+), equivalente a acc=1
if acc not in (1, 2, 3, 4):
    return False
```

**Bug 2 - Topico approval nao permitido em restricted mode:**
```python
# ANTES (buggy):
if topic == approval_topic and acc in (1, 3):
    allowed = True

# DEPOIS (fix):
# acc=4 (subscribe) tambem precisa ser permitido
if topic == approval_topic and acc in (1, 3, 4):
    allowed = True
```

### Arquitetura confirmada

```
ESP32 Gateway (D0DB62DAF380)
  -> WiFi -> mqtt.aquabook.com.br:1883 (mosquitto-mosquitto-1 @ 64.227.0.165)
     -> mosquitto-go-auth -> http://10.120.0.5:18000 (aquario-backend @ 104.248.115.194)
        -> DB: devices, aquariums, etc.

Backend consumer (aquario-backend)
  -> MQTT_HOST=10.120.0.4 (VPC IP de 64.227.0.165)
  -> subscreve aquario/#
  -> recebe "approved" retained e descarta (nao e JSON - expected behavior)
```

### Deploy de emergencia (fix no container)

Os fixes foram aplicados em producao via `docker cp` ao container `aquario-backend`:
- Lines 573: `if acc not in (1, 2, 3, 4):`
- Lines 627-631: `if topic == approval_topic and acc in (1, 3, 4):`

**ATENCAO**: o fix SO sobrevive enquanto o container nao for recriado da imagem.
O PR de task/TASK-0533 precisa ser mergeado para main para o fix ser permanente.

### Proximo passo pendente

O gateway estava offline ao final da sessao (sem output serial, possivel WiFi down
ou device desligado). Quando reconectar:
1. Auth OK (device ativo, credenciais corretas)
2. Subscribe approval topic OK (ACL retorna 200 para acc=4)
3. Receive retained "approved" OK (ACL retorna 200 para acc=1)
4. Gateway loga: `[INFO] Device approved by backend ACL. Full namespace enabled.`
5. Publica telemetria em `aquario/D0DB62DAF380/metrics/minute` etc.

## Notas de Progresso

### 2026-02-24 - claude-code (sessao 1)

- Identificado: gateway conecta ao broker REMOTO (mqtt.aquabook.com.br) nao ao local
- Firmware reflashado via PlatformIO: `pio run -e esp32dev --target upload`
- Firmware novo confirmado no serial: publica `metrics/minute` (nao mais `telemetry`)

### 2026-02-25 - claude-code (sessao 2)

**Diagnostico completo:**
- Gateway em restricted mode aguardando `approved` no topico `aquario/D0DB62DAF380/approval`
- ACL bloqueava o subscribe do gateway por dois bugs: first gate e restricted check
- Ambos bugs corrigidos e deployados via docker cp no container de producao
- Device associado ao aquario "Reef Sala" diretamente no DB de producao
- Mensagem retained "approved" republicada no broker correto (64.227.0.165)
- Confirmado via testes manuais: ACL retorna 200 para acc=1 e acc=4 no approval topic
- Gateway ficou offline durante debugging (WiFi/power issue fisico)
- Fixes comitados em task/TASK-0533 e pushados para o repositorio

**Verificacoes de ACL que passam agora:**
```
POST /api/v1/mqtt/acl username=ab_srv_D0DB62DAF380 topic=aquario/D0DB62DAF380/approval acc=4 -> 200
POST /api/v1/mqtt/acl username=ab_srv_D0DB62DAF380 topic=aquario/D0DB62DAF380/approval acc=1 -> 200
```

### 2026-02-25 - claude-code (sessao 3)

**Diagnostico e correcao do pipeline ESP-NOW → cloud:**

**Bug 3 - ESP-NOW data nunca chegava na bridge queue:**
`LocalBroker::publish()` e um publish server-side e NAO dispara `messageCb_` (que
enfileira na bridge). So clientes MQTT externos (que publicam via TCP) disparam o
evento `Public_sMQTTEventType`. Correcao: adicionar `g_bridge.enqueue()` diretamente
no callback `espNowReceiverInit` em `main.cpp`.

**Bug 4 - BRIDGE_QUEUE_CAP=256 causava falha silenciosa de calloc:**
`calloc(256, sizeof(BridgeMessage))` = 256 * 388 bytes = 99KB causava falha de
alocacao no heap do ESP32 (heap disponivel insuficiente para bloco contiguos de 99KB).
O `buffer_` ficava null e todos os pushes falhavam silenciosamente.
Correcao: reduzir `BRIDGE_QUEUE_CAP` de 256 para 32 (12KB).

**Bug 5 - node-temp-005D8634 nao era client do gateway no DB:**
`device_role='server'`, `parent_device_id=None`. ACL nao autorizava gateway a publicar
nos topicos do node. Correcao: UPDATE devices SET device_role='client', parent_device_id=gateway_uuid.

**Resultado final confirmado:**
- `node-temp-005D8634`: `last_seen_at=2026-02-25T02:25:15Z`, `is_online=True`
- `sensor_readings`: 8 leituras de temperatura (27.5-27.5625°C)
- Broker: mensagens em `aquario/node-temp-005D8634/metrics/minute` chegando OK
- Commits: `0f2ce86 fix(firmware): corrigir forwarding de dados ESP-NOW para cloud MQTT`

**Confirmado:**
- Dashboard mostrando temperatura 27.4°C em tempo real (screenshot confirmado pelo usuario)

**Pendente:**
- Fix de ACL no container e efemero - PR precisa ser mergeado para main

### 2026-02-25 - claude-code (sessao 4)

**Fix - status offline demorava atualizar no dashboard:**
Apos desligar o node-temp, o dashboard mantinha status "Conectado". O sistema ja
tinha `check_stale_devices()` com WebSocket broadcast, mas threshold=5min e interval=120s
causavam atraso de ate ~7 minutos para detectar offline.

Correcao: reduzir defaults em `backend/app/`:
- `OFFLINE_THRESHOLD_MINUTES`: 5 -> 2 minutos (metrics/minute chega a cada ~60s)
- `DEVICE_HEARTBEAT_CHECK_INTERVAL_SECONDS`: 120 -> 60 segundos

Deployado em producao via docker cp + restart. Commit: `1e44d72`.

### 2026-02-25 - claude-code (sessao 5)

**Display OLED rico com 3 telas animadas:**

- Pagina 0 (Status): header invertido "aquaBook" + barras WiFi RSSI no canto,
  IP, estado cloud com ponto piscante (animStep_ & 1), seta >>> animada
  quando lastActivityMs < 8s, contadores MOD/CL/DRP
- Pagina 1 (Modulos): lista de devices ESP-NOW + MQTT com dots animados
  (presenca piscante), truncagem em 20 chars
- Pagina 2 (Fluxo de Dados): pipeline [ESP]->>[GW]->>[CLD] com pacotes
  animados nas linhas (drawBox 4x5 movendo-se), idle = linha pontilhada
- Indicador de paginas (dots) no rodape (preenchido = atual, outline = outros)
- OLED_REFRESH_MS: 800 -> 300ms para animacoes suaves (~4.5s por pagina)
- OledSnapshot: novos campos rssi (WiFi.RSSI()), uptimeS, lastActivityMs
- main.cpp: g_lastActivityMs rastreado em setMessageCallback e espNowReceiverInit

Commit: `2952f85`
