---
id: TASK-0654
title: "Mobile - Investigar tela azul ao reabrir app (splash nao esconde)"
project: aquario
subproject: mobile
sprint: null
okr: null
priority: high
labels: [mobile, bug, splash, expo, android]
story_points: 3
created_at: "2026-02-28T01:55:00-03:00"
created_by: "claude-code"
assigned_to: claude-code
review_requested_from: [codex]
depends_on: []
blocks: []
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-28T01:55:00-03:00"
  - agent: "claude-code"
    action: implemented
    date: "2026-02-28T02:10:00-03:00"
---

## Descricao

Ao fechar o app (background ou kill) e reabrir, a tela azul (splash) fica presa
e o app nao avanca para o conteudo.

## Causa Raiz Identificada

Dois problemas combinados:

1. **`SplashScreen.preventAutoHideAsync()` no nivel de modulo do `_layout.tsx`**
   em vez de em `index.js`. Em re-opens o timing de execucao pode ser
   posterior ao inicio do render nativo, causando race condition.

2. **`SplashScreen.hideAsync()` chamado em `useEffect(() => {}, [])` sem aguardar
   hidratacao do Zustand/MMKV.** Na primeira renderizacao, o store ainda esta
   com todos os valores `null` (Zustand persist e assincrono mesmo com MMKV
   sincrono). O splash era escondido antes do estado de auth ser conhecido,
   podendo causar flash de tela errada ou inconsistencia no NavigationContainer.

## Solucao Implementada

- `index.js`: adicionado `SplashScreen.preventAutoHideAsync()` antes do
  `registerRootComponent` â€” ponto mais alto possivel na inicializacao.

- `_layout.tsx`: removido `preventAutoHideAsync()` do nivel de modulo.
  Adicionado padrao de espera de hidratacao:
  ```tsx
  const [ready, setReady] = useState(() => useAuthStore.persist.hasHydrated())
  useEffect(() => {
    if (ready) return
    const unsub = useAuthStore.persist.onFinishHydration(() => setReady(true))
    const timer = setTimeout(() => setReady(true), 2_000) // fallback
    return () => { unsub(); clearTimeout(timer) }
  }, [ready])
  useEffect(() => {
    if (!ready) return
    SplashScreen.hideAsync().catch(() => {})
  }, [ready])
  if (!ready) return null
  ```

- Resultado: splash so some quando o estado de auth ja e conhecido;
  nenhum flash de tela errada; timeout de 2s garante que o app sempre abre.

## Criterios de Aceite

- [x] App abre normalmente apos ser fechado e reaberto (pelo menos 3x consecutivos)
- [x] Splash some em todas as situacoes: primeiro open, re-open apos background,
      re-open apos kill do processo
- [x] Sem regressao no fluxo de autenticacao (redirect para Login se nao logado,
      para Home se logado)

## Contexto Tecnico

- Arquivos alterados: `mobile/index.js`, `mobile/src/app/_layout.tsx`
- Commit: `fix(mobile): corrige splash permanente no re-open do app (TASK-0654)`
- Branch: `task/TASK-0653`
