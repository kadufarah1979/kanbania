---
id: TASK-0663
title: "Mobile — Push Notifications: registro FCM + handlers de notificacao"
project: aquario
subproject: app-android
sprint: null
okr: null
priority: medium
labels: [feature, mobile, notifications]
story_points: 3
created_at: "2026-02-28T03:00:00-03:00"
created_by: "claude-code"
assigned_to: null
review_requested_from: []
depends_on: [TASK-0659]
blocks: []
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-28T03:00:00-03:00"
---

## Descricao

Implementar registro do token FCM no backend e handlers para receber
notificacoes push em foreground e background. O backend ja suporta
`POST /api/v1/notifications/fcm-token` (TASK-0659). O plugin
`expo-notifications` ja esta configurado em `app.config.ts`.

## Criterios de Aceite

- [ ] Apos login, solicitar permissao de notificacoes ao usuario
- [ ] Obter token FCM via `Notifications.getExpoPushTokenAsync()`
- [ ] Registrar token no backend: `POST /api/v1/notifications/fcm-token`
- [ ] Renovar token automaticamente quando expirar (`addPushTokenListener`)
- [ ] Handler foreground: exibir notificacao como banner/toast in-app
- [ ] Handler background: ao tocar na notificacao, navegar para a tela correta
  - Notificacao de alerta → `AquariumDetail` do aquario correspondente
  - Notificacao generica → HomeScreen
- [ ] Ao fazer logout: `DELETE /api/v1/notifications/fcm-token` (remover token)

## Contexto Tecnico

- Plugin: `expo-notifications` (ja instalado e configurado em `app.config.ts`)
- Canal default: `aquabook_default` (ja configurado no plugin)
- Icone de notificacao: `./assets/notification-icon.png` (ja configurado)
- Backend: `POST /api/v1/notifications/fcm-token` com body `{ token: string }`
- Backend: `DELETE /api/v1/notifications/fcm-token` com body `{ token: string }`
- O hook de registro pode ir em `useAuthStore.setUser()` ou em um `useEffect`
  no `RootLayout` que observa o estado de auth

## Exemplo de Fluxo

```tsx
// Em algum ponto pós-login (ex: RootLayout ou useEffect no AppNavigator)
const token = await Notifications.getExpoPushTokenAsync()
await apiClient.post('/api/v1/notifications/fcm-token', { token: token.data })

// Handler foreground
Notifications.addNotificationReceivedListener((notification) => {
  // mostrar toast ou badge
})

// Handler ao tocar
Notifications.addNotificationResponseReceivedListener((response) => {
  const aquariumId = response.notification.request.content.data?.aquarium_id
  if (aquariumId) navigation.navigate('AquariumDetail', { aquariumId })
})
```
