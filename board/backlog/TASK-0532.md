---
id: TASK-0532
title: "Implementar rolling update com gray deployment nos microsservicos TecPag"
project: tecpag
subproject: tecpag-devops
sprint: null
okr: OKR-2026-Q2-09
priority: medium
labels: [devops, infra, feature]
story_points: 5
created_at: "2026-02-24T00:00:00-03:00"
created_by: "claude-code"
assigned_to: null
review_requested_from: []
depends_on: [TASK-0515, TASK-0522]
blocks: []
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-24T00:00:00-03:00"
---

## Descricao

Implementar estrategia de gray deployment (canary release) para os microsservicos TecPag,
permitindo que novas versoes sejam expostas a uma fracao controlada do trafego antes do
rollout completo. Elimina a necessidade de janelas de manutencao e reduz o risco de deploy.

## Sugestao de Implementacao

### Abordagem recomendada: ALB Weighted Target Groups

O TecPag ja usa AWS ALB + Auto Scaling Groups, o que torna essa a abordagem mais nativa
e com menor complexidade operacional.

**Fluxo:**

```
                         5% trafego (gray)
         ┌──────────────────────────────► ASG-v2 (nova versao)
ALB ────►│  Weighted Target Groups
         └──────────────────────────────► ASG-v1 (versao atual)
                         95% trafego (stable)
```

**Passos de implementacao:**

1. **Terraform** — adicionar segundo target group no modulo `app_load_balance`:
   - `aws_lb_target_group` para versao gray (v2)
   - `aws_lb_listener_rule` com `weighted` distribuindo: 95% v1, 5% v2

2. **Auto Scaling Group** — criar ASG separado para o gray:
   - Launch template com nova versao da imagem
   - Min/max capacity menor (1-2 instancias)

3. **Pipeline CI/CD** — adicionar stage `deploy-gray`:
   - Deploy da nova versao no ASG gray
   - Monitorar metricas por N minutos (CloudWatch + Zabbix)
   - Se saudavel: shift gradual de trafego (5% → 25% → 50% → 100%)
   - Se erro: rollback automatico (peso gray → 0%)

4. **Promocao automatica (opcional)**:
   - Lambda ou script que ajusta os pesos do ALB baseado em metricas
   - Threshold: error rate < 1%, latencia p95 < 500ms por 10 minutos

**Modulos Terraform a criar/modificar:**
- `IaC/modules/app_load_balance/` — adicionar suporte a weighted rules
- Novo modulo: `IaC/modules/gray-deployment/` — encapsula ASG + target group gray

**Alternativa mais simples (se Terraform for complexo demais agora):**
- Usar `aws_codedeploy_deployment_group` com `canary` deployment config
- Integra diretamente com ALB e faz o shift automaticamente

### Criterios de rollback automatico
- Error rate > 2% em 5 minutos
- Latencia p99 > 2s em 5 minutos
- Health check falhando em > 1 instancia gray

## Criterios de Aceite

- [ ] Modulo Terraform para gray deployment criado e documentado
- [ ] Pipeline CI/CD com stage `deploy-gray` funcionando
- [ ] Deploy de nova versao com 5% de trafego sem afetar stable
- [ ] Promocao gradual automatica baseada em metricas (ou manual via pipeline)
- [ ] Rollback automatico em caso de degradacao de metricas
- [ ] Testado com deploy real de um dos gateways (gatewaypix ou gatewayonline)
- [ ] Runbook documentado em `docs/gray-deployment-runbook.md`

## Contexto Tecnico

Dependencias:
- TASK-0515: pipeline CI/CD base (pre-requisito)
- TASK-0522: deploy-prd com aprovacao (pre-requisito)

Recursos AWS existentes:
- ALB: `IaC/modules/app_load_balance/`
- ASG: `IaC/modules/autoscaling/`
- Launch Templates: `IaC/modules/launch_templates/`

> Esta task tem 5 SP e deve ser decomposta em sub-tasks antes de executar.
> Sugestao: (1) modulo Terraform, (2) pipeline stage, (3) metricas e rollback, (4) testes e runbook.

## Notas de Progresso

### [2026-02-24 00:00] claude-code
Task criada com sugestao de implementacao. Nao iniciar antes de TASK-0515 e TASK-0522 estarem concluidas.
