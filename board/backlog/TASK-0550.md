---
id: TASK-0550
title: "Firmware - ESP-NOW pairing bidirecional (botao + remoto via MQTT)"
project: aquario
subproject: null
sprint: null
okr: null
priority: high
labels: [firmware, espnow, mqtt, pairing]
story_points: 8
created_at: "2026-02-25T00:00:00-03:00"
created_by: "claude-code"
assigned_to: null
review_requested_from: []
depends_on: []
blocks: []
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-25T00:00:00-03:00"
---

## Descricao

Implementar sistema de pairing ESP-NOW bidirecional suportando dois fluxos:

1. **Pairing presencial (botao)**: pressionar botao no node coloca-o em modo
   pairing; gateway responde com seu MAC; node grava na NVS e passa a usar
   unicast.

2. **Pairing remoto (MQTT)**: dashboard envia comando ao gateway via MQTT;
   gateway entra em janela de pairing e transmite seu MAC via ESP-NOW; node
   recebe, atualiza NVS e re-faz pairing sem necessidade de acesso fisico.

## Criterios de Aceite

- [ ] Node: ao pressionar botao, entra em modo pairing e faz broadcast de beacon
- [ ] Gateway: ao receber beacon de pairing, responde com MAC via ESP-NOW unicast
- [ ] Node: grava MAC do gateway na NVS e usa unicast em todas as transmissoes seguintes
- [ ] Gateway: aceita comando MQTT `aquario/{gw_id}/cmd/pairing` com `{"node_id": "..."}`
- [ ] Gateway: ao receber comando, entra em janela de pairing (30s) e faz broadcast do MAC
- [ ] Node: ao receber broadcast de pairing, atualiza MAC na NVS (re-pairing remoto)
- [ ] Gateway OLED: exibe "PAIRING..." durante janela ativa
- [ ] Backend: endpoint ou comando MQTT para iniciar pairing remoto via dashboard
- [ ] Multiplos gateways na mesma rede sem duplicacao de mensagens (unicast resolve)

## Contexto Tecnico

### Arquitetura

```
Pairing presencial:
  [Botao no node] → broadcast beacon → [Gateway] → unicast MAC → [Node grava NVS]

Pairing remoto:
  [Dashboard] → MQTT → [Gateway] → ESP-NOW broadcast MAC → [Node atualiza NVS]
```

### Mudancas necessarias no firmware

**`firmware/src/espnow_receiver` → renomear para `espnow_bridge`:**
- Gateway precisa tambem ENVIAR ESP-NOW (hoje so recebe)
- Adicionar `esp_now_send()` para resposta de pairing e comandos futuros
- Adicionar peer management (registrar MACs dos nodes conhecidos)

**`firmware/src/main.cpp` (gateway):**
- Adicionar handler para topico MQTT `aquario/{gw_id}/cmd/pairing`
- Janela de pairing: variavel `g_pairingWindowMs` com timeout de 30s
- OLED snapshot: campo `pairingActive` para exibir "PAIRING..." na tela

**Firmware node (monitor/):**
- Modo pairing ativado por botao (GPIO0 = BOOT button, press curto)
- Broadcast beacon com `device_id` e `magic`
- Receber resposta unicast do gateway com MAC
- Gravar MAC do gateway na NVS via `Preferences`
- Na inicializacao: ler MAC da NVS; se presente, usar unicast; senao, entrar em pairing

**Payload de pairing (novo `espnow_pairing.h`):**
```cpp
struct EspNowPairingBeacon {
  uint32_t magic;      // ESPNOW_PAIRING_MAGIC
  char device_id[32];  // node device_id
  uint8_t type;        // 0=beacon (node->gw), 1=response (gw->node)
  uint8_t gateway_mac[6]; // preenchido na resposta
};
```

### Mudancas necessarias no backend

- Endpoint ou publicacao MQTT para acionar pairing remoto:
  `POST /api/v1/devices/{device_id}/pair` → publica `aquario/{gw_id}/cmd/pairing`
- O `gw_id` vem do `parent_device_id` do node no DB

### Estado atual

- Gateway ESP-NOW: somente receiver (`espnow_receiver.cpp`)
- Node-temp: envia broadcast, sem pairing, sem NVS para MAC do gateway
- Multiplos gateways no mesmo canal → duplicacao de mensagens (problema aberto)

## Notas de Progresso

_Nenhuma ainda._
