---
id: TASK-0554
title: "Executar terraform plan e validar diff HML"
project: mdm-terraform
subproject: null
sprint: sprint-076
okr: null
priority: high
labels:
  - terraform
  - infra
story_points: 2
created_at: "2026-02-24T00:00:00-03:00"
created_by: "claude-code"
assigned_to: null
review_requested_from: []
depends_on:
  - TASK-0549
  - TASK-0550
  - TASK-0551
blocks:
  - TASK-0555
acted_by:
  - agent: "claude-code"
    action: created
    date: "2026-02-24T00:00:00-03:00"
---

## Descricao

Antes de aplicar, executar e revisar o terraform plan no stage HML para garantir que o diff está correto e contém apenas as mudanças esperadas.

```bash
cd terraform/stage/hml
terraform fmt -recursive
terraform validate
terraform plan
```

Validar que o diff contém:
- **Destroy**: `aws_lb_listener` para apiGateway, apiMdm, apiMedia, apiGtkong, kafkaControlCenter (portas antigas)
- **Create**: `aws_lb_listener_rule` para cada serviço (host_header no listener 443)
- **Update**: security group rules (remoção das portas não-padrão 8080, 8001, 12170, 12186, 9021)
- **Update**: route53 records (alias para ALB → CNAME Akamai)

Só prosseguir para TASK-0555 (apply) se o plan estiver correto e aprovado.

## Criterios de Aceite

- [ ] `terraform fmt -recursive` sem diff (código já formatado)
- [ ] `terraform validate` sem erros
- [ ] Plan mostra destroy dos 5 listeners das portas antigas
- [ ] Plan mostra create das 5 regras host_header no listener 443
- [ ] Plan mostra update das regras de SG (remoção das portas não-padrão)
- [ ] Plan mostra update dos records Route53 (alias → CNAME Akamai) para os domínios confirmados
- [ ] Nenhuma mudança inesperada no plan (sem destroy/create de recursos não relacionados)
- [ ] Plan revisado e aprovado para prosseguir ao apply

## Contexto Tecnico

Stage: `terraform/stage/hml/`

Depende de TASK-0549 (locals_load_balancer), TASK-0550 (security groups) e TASK-0551 (route53) estarem concluídas antes de executar o plan.

O plan deve ser salvo em arquivo para referência durante o apply:
```bash
terraform plan -out=plan.tfplan
```

## Notas de Progresso

### [2026-02-24 00:00] claude-code
Card criado. Gate de validação antes do apply. Depende de TASK-0549, TASK-0550 e TASK-0551. Bloqueia TASK-0555.
